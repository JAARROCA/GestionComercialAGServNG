/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"84404C60-18CE-4887-B06B-3789049B255F"}
 */
var codcrc = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3E78DE16-D860-420F-A046-FE3A113E63EA"}
 */
var crcurl = null;

/**
 * @type {Number}
 * 
 *
 *
 * @properties={typeid:35,uuid:"FE1C3B5B-CA32-495D-B9AC-66F557E067C2",variableType:8}
 */
var FormatoFactura3 = null;

/**
 * @type {Number}
 * 
 *
 * @properties={typeid:35,uuid:"AB7B8941-C9C4-4500-A475-2E49AFD10D3F",variableType:8}
 */
var FormatoFactura2 = null;

/**
 * @type {Number}
 * 
 *
 * @properties={typeid:35,uuid:"03E468EB-B545-4F1F-BF31-3DA60AF47C71",variableType:8}
 */
var FormatoFactura = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"C618166F-0B78-40BB-902C-AC494299EE6E",variableType:4}
 */
var entorno_ticketbai = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"038EF113-1CBF-4EC4-9815-35DE4905F6F9",variableType:4}
 */
var anulatbai = null;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"09E20527-72FB-476E-B8A9-4A0EF86E2773",variableType:8}
 */
var modificartbai = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D2511B4F-EC12-46F7-AF3F-F3A4836B6491"}
 */
var macaddress = null;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"5E2D88A4-64E1-44A7-89AC-2A212372289F",variableType:8}
 */
var xmltbai = null;

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"B481AB1F-3063-4FDD-9317-64061B2094C9"}
 */
var Certif = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3341506C-002D-45C4-914D-73A4ACF37DD2"}
 */
var HastaDescCliente = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"7C09F51C-E57E-4634-A3FF-22DA9B7C4409"}
 */
var DescDesdeCliente = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"5D755DE9-4702-4798-876D-ADC2E649AD22",variableType:4}
 */
var HastaCliente = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"AAB5AA79-B047-4D9F-A61E-F1830745E508",variableType:4}
 */
var DesdeCliente = null;

/**
 * @type {Number}
 *
 *
 *
 * @properties={typeid:35,uuid:"57498185-7766-430B-8EAF-C0B2CCAC6C25",variableType:8}
 */
var HastaEje = null;

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"4CE97956-9422-44DC-9B3F-E23790A09FA4"}
 */
var HastaSer = null;

/**
 * @type {Number}
 *
 *
 *
 * @properties={typeid:35,uuid:"49EA1324-F041-4941-B4C9-0A32C92E362C",variableType:8}
 */
var HastaNup = null;

/**
 * @type {Number}
 *
 *
 *
 * @properties={typeid:35,uuid:"29E91A63-A819-4A29-98DA-46856D7BB5E5",variableType:8}
 */
var DesdeEje = null;

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"42A346A2-5E8B-4FF0-B48B-8D6B0671C99E"}
 */
var DesdeSer = null;

/**
 * @type {Number}
 *
 *
 *
 * @properties={typeid:35,uuid:"C17C74D5-5C38-417B-BCEE-FF9485967568",variableType:8}
 */
var DesdeNup = null;

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"91BBC8F1-0A89-49BA-B042-F85D53848BF8"}
 */
var newxml = '';

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"DFE3C546-EBBE-4FDA-9379-DFA919922576"}
 */
var htm = '';

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"0AA2F709-F904-4096-83B0-0DE6EED74FED"}
 */
var serverURL = '';

/**
 * @type {String}
 *
 *
 *
 * @properties={typeid:35,uuid:"3596FCAD-6EFF-4597-89A5-18EEE53B6CFF"}
 */
var nom = '';

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"DBC536F2-9192-4310-A79A-68F3AFA52724",variableType:-4}
 */
var Document;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"12E0D413-A2A3-4B3F-93E7-000D0AEA9DA8",variableType:-4}
 */
var Document2;

/**
 * @type {Namespace}
 *
 *
 *
 * @properties={typeid:35,uuid:"E29E8BC6-778D-4556-B22B-C838E4C8B156",variableType:-4}
 */
var ns;

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"F767E1A7-F3B1-4B0E-91E0-6BB6E335B36E",variableType:-4}
 */
var Cabecera;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"16709964-46BC-439B-963C-A44B75C6F940",variableType:-4}
 */
var Modelo;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"2AB6801D-5540-4B22-B0D7-5F7C4FDA79C3",variableType:-4}
 */
var Capitulo;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"81209E16-68A5-4EE8-B12A-9DF6A34EC41D",variableType:-4}
 */
var Subcapitulo;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"340600D1-21D1-466B-8171-D287AEF4DD7C",variableType:-4}
 */
var ObligadoTributario;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"74584924-D708-4CB4-8F1F-367DAC6B3C47",variableType:-4}
 */
var FacturasEmitidas;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"26336FCB-99C0-4DDF-B6C7-F6CA582691EB",variableType:-4}
 */
var FacturaEmitida;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"B4F51189-2C30-46E5-87C1-7EFAAC6BF8B4",variableType:-4}
 */
var TicketBai;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"BD24F655-859B-48D6-9F22-111E50DCD740",variableType:-4}
 */
var Operacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"29078434-5670-491B-8755-27E13D90F901",variableType:-4}
 */
var ObligadoEmision;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"80FD855B-F166-4A0F-B9BB-7BBC7E32281A",variableType:-4}
 */
var NombreRazon;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"E6A31D3D-2780-4FBD-A1B0-6F2076E1B4C3",variableType:-4}
 */
var RegistroAltaFacturas;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"A5C2DAB8-040B-43E8-99F2-CEE2C54DAB20",variableType:-4}
 */
var RegistroFacturacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"02D96129-7EC0-43AA-8A6B-EAA298CB228F",variableType:-4}
 */
var DatosControl;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"4BE525E9-D8A2-4C7D-8177-FFD92136953F",variableType:-4}
 */
var Huella;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"06568C48-A1E3-4C2C-ABCF-75A703AAF237",variableType:-4}
 */
var TipoHash;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"6677931E-C79F-4C31-8BD9-0A879F41B065",variableType:-4}
 */
var FechaGenRegistro;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"6A0C1F9F-8C34-4074-9FD2-87F50DCE6A58",variableType:-4}
 */
var HoraGenRegistro;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"9A15AA4E-8C9C-4552-BC06-2C05E9E67C20",variableType:-4}
 */
var HusoHorarioGenRegistro;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"73DC2A8F-FA73-495D-87B1-0CC18BB19960",variableType:-4}
 */
var PeriodoLiquidacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"222255FA-7915-47B8-B3DA-B47A6AA2F742",variableType:-4}
 */
var Periodo;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"0FDE321F-FF4C-40E1-810B-B7267D466581",variableType:-4}
 */
var IDEmisorFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"4DA25CDC-E55F-45C2-8520-D4193920D01A",variableType:-4}
 */
var Ejercicio;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"91C26428-C1C7-46D6-B167-17F98F92584D",variableType:-4}
 */
var IDFactura;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"F78489A4-9410-45A3-9FF0-DB1CADB7EC38",variableType:-4}
 */
var TipoFactura;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"EEC7116E-4557-4DFF-AE91-4ECF5AFD26A0",variableType:-4}
 */
var Tercero;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"7B4A4352-691B-4CEB-8353-B1BA1406AAAB",variableType:-4}
 */
var Contraparte;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"5F9BEB29-19D9-4FF5-8CC4-1F45DC373BC1",variableType:-4}
 */
var Desglose;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"44E0383F-4C70-4098-8FC2-A3552E5F8DB7",variableType:-4}
 */
var DetalleDesglose;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"56DD1AF8-721A-42D6-812B-AE4790DB792C",variableType:-4}
 */
var ClaveRegimen;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"D21F9E8B-4449-47D2-BB23-8CEF751B22C0",variableType:-4}
 */
var CalificacionOperacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"896EEB56-C361-4300-AA49-A44576F2D528",variableType:-4}
 */
var OperacionExenta;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"88085BD2-1244-47F4-B537-A9229D92EDBD",variableType:-4}
 */
var DescripcionOperacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"F26573C6-7AEE-423D-833C-FA91508FCB14",variableType:-4}
 */
var NumSerieFacturaEmisor;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"73F5CAB9-483A-4F85-9CC5-328A924A9ACA",variableType:-4}
 */
var FechaExpedicionFacturaEmisor;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"24A02595-359A-408C-A903-C5E1C77622E0",variableType:-4}
 */
var Sujetos;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"F94A6752-A99E-4021-93A0-353F638B2AED",variableType:-4}
 */
var Emisor;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"B69D4863-65AE-4361-95E2-F597ED7E4967",variableType:-4}
 */
var NIF;

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"67DBD9E4-02DE-4D44-8D0C-8DD2F1E84AED",variableType:-4}
 */
var IDOtro;

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"B2064559-7A65-4A00-A14E-615612A3EC00",variableType:-4}
 */
var CodigoPais;

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"8FAD47A4-77FB-499C-B77E-F0ACE3A4F3A1",variableType:-4}
 */
var IDType;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"9970D500-2D8E-4DC4-B10D-7E3E4A94CC09",variableType:-4}
 */
var ID;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"54450604-FE27-40D3-B25F-173479547485",variableType:-4}
 */
var ApellidosNombreRazonSocial;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"96683465-4648-4879-8DB7-9E9067C5D41F",variableType:-4}
 */
var Destinatarios;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"BF3E35BC-F028-435C-8BF1-50B2A5653988",variableType:-4}
 */
var IDDestinatario;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"8115AB68-C4D4-4E1A-872E-1CA1646DB265",variableType:-4}
 */
var CodigoPostal;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"BCA7F7F2-0470-4B04-9A66-63A9D16FC3C6",variableType:-4}
 */
var Direccion;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"D6415D86-897E-4923-82E3-08464CF5DAFA",variableType:-4}
 */
var VariosDestinatarios;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"245A30A1-0A01-4616-BBEE-212D27EF6BDF",variableType:-4}
 */
var EmitidaPorTercerosODestinatario;

/**
 * @type {XML}
 *
 *
 *
 * @properties={typeid:35,uuid:"D9830DC3-DF22-49C2-9083-2DBBC0F4CD26",variableType:-4}
 */
var IDVersionTBAI;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"DB7C98CA-4BFC-401F-ACEF-9032A1FCA2C9",variableType:-4}
 */
var IDVersion;

/**
 * @type {XML}
 *
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"484B2AFA-ADC8-4452-8688-73AA3F8E52A4",variableType:-4}
 */
var Accion;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"E7F350E6-3B6A-4916-9BC6-4D9FBC722B06",variableType:-4}
 */
var Factura;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"386E54A9-55F5-453F-B0E8-76905D3DEED5",variableType:-4}
 */
var FacturaRectificativa;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"380B25DD-A466-458E-9CC3-1CD6D36157FE",variableType:-4}
 */
var Codigo;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"60C0D365-04AA-4CB6-A598-60F8D4CCF355",variableType:-4}
 */
var Tipo;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"EBDC8C64-08E0-469A-AB1B-5C52043B0CAF",variableType:-4}
 */
var ImporteRectificacionSustitutiva;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"E22E3A3B-7AA5-4475-860F-3F1B51472732",variableType:-4}
 */
var FacturasRectificadasSustituidas;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"8DDF70FD-55B8-4670-8E7B-D2FF1C03263A",variableType:-4}
 */
var IDFacturaRectificadaSustituida;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1092C79A-D880-4153-AC81-C34BCC239419",variableType:-4}
 */
var BaseRectificada;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"E865DDDC-EAC5-4E20-913E-DEAD2387F30F",variableType:-4}
 */
var CuotaRectificada;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"80F9E52F-BDD1-49E6-89ED-23962F8D8F8D",variableType:-4}
 */
var CuotaRecargoRectificada;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"43CB556E-D513-4D76-988E-505F84B54FAD",variableType:-4}
 */
var CabeceraFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"15DA6AF3-DE04-493B-8620-A7679388F1A5",variableType:-4}
 */
var SerieFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"972F6214-53A2-4E20-9C99-2B40A9806A4C",variableType:-4}
 */
var NumFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"E8B81FEC-8A29-4A32-AEE5-76585A5774D2",variableType:-4}
 */
var FechaExpedicionFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"7F29987D-9FE5-45FE-869F-BA77378DF744",variableType:-4}
 */
var HoraExpedicionFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"81D9E0E7-D2BB-4E56-BDB2-E312B14A11ED",variableType:-4}
 */
var FacturaSimplificada;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"836BA06D-0209-474C-8AEA-6E53409388D1",variableType:-4}
 */
var FacturaEmitidaSustitucionSimplificada;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"BF206244-FE5D-4FF8-B65D-881357831E7D",variableType:-4}
 */
var DatosFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"FF4A7594-FB7A-4806-A4D4-FD18F83EFE37",variableType:-4}
 */
var FechaOperacion;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"8D09526B-5EE2-43E9-87B9-5A8668BF3E02",variableType:-4}
 */
var DescripcionFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"494C391A-8E8E-49EF-B943-8000E474231F",variableType:-4}
 */
var DetallesFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"82074711-08D2-4797-8F60-E788599A4859",variableType:-4}
 */
var IDDetalleFactura;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"ED1DAFCB-CD0F-4107-9752-2967D981B720",variableType:-4}
 */
var DescripcionDetalle;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"A8E8744B-41F6-4A23-AB4E-ADF37B25F446",variableType:-4}
 */
var Cantidad;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"D2D2B6E7-0480-4A12-B48B-20D22DFFB78D",variableType:-4}
 */
var ImporteUnitario;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C37AC55E-55E5-4ABB-9E7E-7CC29E1866E8",variableType:-4}
 */
var Descuento;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"E1CDE178-3904-465E-BEE1-F6A81402F162",variableType:-4}
 */
var ImporteTotal;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"DFCAADA8-ABAA-4FE0-8EC0-369B6AFB9F4E",variableType:-4}
 */
var ImporteTotalFactura;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"7F61D920-90AB-491D-A8EC-DBE40A412196",variableType:-4}
 */
var RetencionSoportada;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"92D91885-603A-4C30-B7C1-474E011B9776",variableType:-4}
 */
var BaseImponibleACoste;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"FA964E17-D85F-4D60-A688-2B3DC1579333",variableType:-4}
 */
var Claves;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"BE6AACFA-DE96-49BA-941D-4B23F834C588",variableType:-4}
 */
var IDClave;

/**
 * @type {XML}
 *
 *
 *
 *
 * @properties={typeid:35,uuid:"7D555EEA-DDFE-4E6D-8698-F73AE28165CB",variableType:-4}
 */
var ClaveRegimenIvaOpTrascendencia;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D7742046-033A-44B4-AAEE-F8E1F8CD64C9",variableType:-4}
 */
var TipoDesglose;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4033EF7C-5C0B-44E7-811C-84B1F7899B41",variableType:-4}
 */
var DesgloseFactura;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2E939200-0CB5-47DD-A89D-FF0C22EFEA1F",variableType:-4}
 */
var Sujeta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"75A3695A-CA31-4C1A-A12B-740B56D1E570",variableType:-4}
 */
var PrestacionServicios;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5AAECE2C-1DEE-4111-AF33-2FBCCF0EEC04",variableType:-4}
 */
var DesgloseTipoOperacion;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"03A968AB-A9CE-4E2B-9126-CF7DED1A117D",variableType:-4}
 */
var Entrega;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2F22757D-DA3E-46C5-8340-AF58BF3EED31",variableType:-4}
 */
var Exenta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DCDAEC04-5D77-4AD8-B5F6-6994282BCE75",variableType:-4}
 */
var DetalleExenta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"F86A9FF8-2E0E-46F5-A6E2-08220CD5B340",variableType:-4}
 */
var CausaExencion;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"3DA3AD47-86DC-49FA-8420-93A5F30CFFB7",variableType:-4}
 */
var NoExenta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"0598FB04-519F-4488-8A4B-3459BCC6F13D",variableType:-4}
 */
var DetalleNoExenta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"3B483F1B-FD98-4C5A-A47E-5A6EB1555919",variableType:-4}
 */
var TipoNoExenta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"78389B68-650A-424D-B68E-3BD6AA83FD7A",variableType:-4}
 */
var DesgloseIVA;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"37E08B73-9811-47A3-9C56-2D2272EC6A78",variableType:-4}
 */
var DetalleIVA;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"BC552681-66CB-4E2F-B048-4FD7AEF2DF44",variableType:-4}
 */
var TipoRecargoEquivalencia;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"226E00D2-1BFD-4ECF-8B42-4541BCF8D8CC",variableType:-4}
 */
var CuotaRecargoEquivalencia;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2C1255E7-7036-4A1C-8BC0-BC2E798716AD",variableType:-4}
 */
var BaseImponible;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"3637485B-0CD2-4379-AA95-181F8EC6C62F",variableType:-4}
 */
var TipoImpositivo;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"525C265F-3709-4BCA-9AF9-520C60B17B2A",variableType:-4}
 */
var BaseImponibleOimporteNoSujeto;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"D7719238-0A70-439A-95D7-6A77E250A280",variableType:-4}
 */
var CuotaRepercutida;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"B71298B6-3A6B-4EB9-AAD8-55114F408260",variableType:-4}
 */
var CuotaImpuesto;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DBDC407C-9AF8-4235-9E37-026F9B7C9918",variableType:-4}
 */
var OperacionEnRecargoDeEquivalenciaORegimenSimplificado;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"254F5349-25B8-475D-9B6D-59D4E6868F86",variableType:-4}
 */
var HuellaTBAI;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"388F4C23-6F8D-4BF9-A9B0-E489EA0E5B63",variableType:-4}
 */
var SignatureValueFirmaFactura;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"02E37003-515C-4FA6-8844-F9437DB548BF",variableType:-4}
 */
var SignatureValueFirmaAnulacion;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"B0B9C874-EF95-42E7-AB9A-8A9EC38D59D7",variableType:-4}
 */
var Software;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"52E8BBFD-292A-457C-BFCA-B4D7DB7B3BDE",variableType:-4}
 */
var LicenciaTBAI;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"3F0645E7-B474-4DE4-B639-BD82A7357A1D",variableType:-4}
 */
var EntidadDesarrolladora;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"8C9F896C-3FFC-4AED-B1F3-8D34CAB62205",variableType:-4}
 */
var Nombre;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"742033AF-FE15-4295-B678-B23861D91FAD",variableType:-4}
 */
var Version;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D65DD53D-8214-406E-BF22-FFC951B2C450",variableType:-4}
 */
var NoSujeta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"9797D4B7-7C0A-48D1-8C56-EDA3C00DBE19",variableType:-4}
 */
var DetalleNoSujeta;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"B531619C-DEA6-4668-8E2E-5B1814A378E7",variableType:-4}
 */
var Causa;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"AC82D031-CAD2-4282-A482-F3926E8E3BE0",variableType:-4}
 */
var Importe;

/**
* @type {XML}
*
*
 *
 * @properties={typeid:35,uuid:"CED80207-E23C-457B-BB96-B0820D040A9D",variableType:-4}
 */
var EncadenamientoFacturaAnterior;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"0C81F561-7F25-4EDF-975E-A36BEDA7C194",variableType:-4}
 */
var SistemaInformatico;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"78CD850A-6571-4014-BDDB-CE3E5C6E4A87",variableType:-4}
 */
var IdSistemaInformatico;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"C5D63439-CFFC-4F88-87D6-B735342B5A02",variableType:-4}
 */
var NumeroInstalacion;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"A272C14F-75C0-456B-9E35-B66602F74BDA",variableType:-4}
 */
var TipoUsoSistema;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"4B67A055-6105-4E07-BC2C-067E2FDB365B",variableType:-4}
 */
var IDEmisorFacturaAnterior;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"8040AD59-BA7D-469A-8DD4-EF3375BA9CFB",variableType:-4}
 */
var NumSerieFacturaAnterior;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"57442540-E23D-46BE-A8C3-C03733143515",variableType:-4}
 */
var HuellaFacturaAnterior;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"F31D07E9-1B07-4AC5-82F3-F441E6567ADD",variableType:-4}
 */
var SerieFacturaAnterior;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"FFFCA397-5BB4-4DA1-88B0-053A72FE0BD4",variableType:-4}
 */
var NumFacturaAnterior;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1D7FFECF-B56A-4DF0-8ED0-58D53A02C6D3",variableType:-4}
 */
var FechaExpedicionFacturaAnterior;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"7A2AD4FF-E30A-4A3D-B522-F868B9FE383C",variableType:-4}
 */
var SignatureValueFirmaFacturaAnterior;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"CB8127E0-4F6C-4716-AC5A-9BF3FDFF1E21",variableType:-4}
 */
var NumSerieDispositivo;

/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EBECB3D0-3C65-498E-A96A-745C331733FC"}
 */
function onLoad(event) {
	// TODO Auto-generated method stub
	//application.setNumpadEnterAsFocusNextEnabled(true)	
	
}

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"D4DB630A-92E9-48E0-B403-C1C34B4B4C8F"}
 */
var ctbai = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C77B0CE8-0615-483D-92A8-6CC8B211DC96"}
 */
var mactbai = '';

/**
 * @type {Object}
 *
 *
 * @properties={typeid:35,uuid:"F28CF5EB-7372-43AC-888D-C84BFD5E0723",variableType:-4}
 */
var frtbai;

/**
 * @type {Object}
 *
 *
 *
 * @properties={typeid:35,uuid:"26EB9AC6-FDC2-4C13-9FFC-06CCF07031A0",variableType:-4}
 */
var fichxmlenvtbai;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B8F4817F-C90C-4E64-86CF-CFBDD8E60F10"}
 */
var qrtbai = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"79958B1A-9CE4-4A11-8EDA-E0CC7ACFDEFE"}
 */
var firmatbai = '';

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"A2AEE88C-E643-47E8-BF6F-B809A27F8CE3",variableType:93}
 */
var fechtbai;

/**
 * Callback method for when form is shown.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"D98D94D4-0F36-4A3F-A833-BC3AB3E611A6"}
 * @SuppressWarnings(deprecated)
 */
function onShow(event) {
	// TODO Auto-generated method stub
	/*var A = new Date().getFullYear().toString()
	A = A.substr(2,4)
	DesdeEje = A
	HastaEje = A
	DesdeSer = ''
	HastaSer = ''
	DesdeNup = null
	HastaNup = null*/
	certif()
	/*if(application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
	{
		elements.lbl_clavecertif.visible = false;
		elements.filename.visible = false;
	}
	else
	{
		elements.lbl_clavecertif.visible = true;
		elements.filename.visible = true;
	}
	*/
	var formato = gcparametrosaplicacion_to_parametrosaplicacion.facturapredettbai;
	if(!formato) formato = 1
	if(formato == 1){
		onActionFormatoFactura1(event)
	}
	else if(formato == 2){
		onActionFormatoFactura3(event)
	}
	else if(formato == 3){
		onActionFormatoFactura2(event)
	}
	
	/*if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20') elements.btn_datos_enviados_TBAI.imageURL = 'media:///TicketBai_ES.png';
	else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01')  elements.btn_datos_enviados_TBAI.imageURL = 'media:///araba_diputacion.gif';
	else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48')  elements.btn_datos_enviados_TBAI.imageURL = 'media:///vizcaya_batuz_diputacion.gif';
	else elements.btn_datos_enviados_TBAI.imageURL = 'media:///TicketBai_ES.png';*/
	
	elements.desdeeje.enabled = false;
	elements.desdeeje.editable = false;
	elements.desdeser.enabled = false;
	elements.desdeser.editable = false;
	elements.desdenup.enabled = false;
	elements.desdenup.editable = false;
	elements.hastaeje.enabled = false;
	elements.hastaeje.editable = false;
	elements.hastaser.enabled = false;
	elements.hastaser.editable = false;
	elements.hastanup.enabled = false;
	elements.hastanup.editable = false;
	elements.xmltbai.enabled = false;
	elements.anulatbai.enabled = false;
	elements.modificartbai.enabled = false;
	elements.btn_editardatosTBAI.enabled = false;
	elements.btn_borrardatosTBAI.enabled = false;
	elements.btn_importardatosTBAI.enabled = false;
	codcrc = null;
	crcurl = null;
	if(globals.GCNombreUsuario == 'JAVI' || globals.GCNombreUsuario == 'ADMINISTRADOR')
	{
		elements.crcurl.visible = true;
		elements.codcrc.visible = true;
		elements.btn_editardatosTBAI.visible = true
	}
	else
	{
		elements.crcurl.visible = false;
		elements.codcrc.visible = false;
		elements.btn_editardatosTBAI.visible = false
	}
	globals.core_formulario_TBAI = 'dialogImpresionFacturasVERIFACTUGC';
	
	plugins.window.createShortcut('control F10', handle_shortCutGC);
	plugins.window.createShortcut('control alt B', handle_shortCutGC);
	plugins.window.createShortcut('control alt V', handle_shortCutGC);
	macaddress = plugins.UserManager.Client().macAddress;				
	/*var filename = "C:\\Servoy\\mac\\macAddress.txt";
	var jsFile = plugins.file.convertToJSFile(filename);
	if (jsFile.exists()) {
	var texto = new Array();
	 var _oFR = new Packages.java.io.FileInputStream(filename),
        _oIR = new Packages.java.io.InputStreamReader(_oFR, "UTF8"),
        _oBR = new Packages.java.io.BufferedReader(_oIR),
       
        z = 0;
	    while ((texto[z] = _oBR.readLine()) != null) 
	    {
           z++;            
        }
	    
        _oBR.close();
        macaddress = texto[0]
	}
	else{
		macaddress = 'Falta dirección MAC'
	}*/
	var hfolder = plugins.file.getHomeFolder()+"\\.servoy\\";
	var rutabat = hfolder+"Comando_numero_serie.bat";
	//var rutabat = "c:\\Servoy\\Comando_numero_serie.bat";
	var f = plugins.file.convertToJSFile(rutabat);
	
	if(f && f.exists() && application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
	{
		var str = application.executeProgram(rutabat);
		str = str.replace("SerialNumber","")
		str = str.trim();
		macaddress = str;	
		if(!macaddress) macaddress = plugins.UserManager.Client().macAddress;
	}
	else if(!f || !f.exists() && application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
	{
		var jsFile = plugins.file.createTempFile('Comando_numero_serie','.bat');
		
		var success = plugins.file.writeTXTFile(jsFile,'@echo off\nwmic bios get serialnumber');
		if (!success) application.output('Could not write file.');
		
		str = application.executeProgram(jsFile);
		str = str.replace("SerialNumber","")
		str = str.trim();
		macaddress = str;
		if(!macaddress) macaddress = plugins.UserManager.Client().macAddress;
	}
	
	var query = "SELECT tbFacturaCabecera.ID, tbFacturaCabecera.mac, tbFacturaCabecera.ctbai, tbFacturaCabecera.cqr, tbFacturaCabecera.fechaenviofichero "+
    "FROM tbFacturaCabecera tbFacturaCabecera "+
    "WHERE (tbFacturaCabecera.eje_cfa >= "+DesdeEje+
    " AND tbFacturaCabecera.eje_cfa <= "+HastaEje+") "+
    "AND (tbFacturaCabecera.ser_cfa >= '"+DesdeSer+"' "+
    "AND tbFacturaCabecera.ser_cfa <= '"+HastaSer+"') "+
    "AND (tbFacturaCabecera.nup_cfa >= "+DesdeNup+
    " AND tbFacturaCabecera.nup_cfa <= "+HastaNup+") "
    //"AND (tbFacturaCabecera.clie_cfa BETWEEN "+DesdeCliente+" AND "+HastaCliente+") "+
    //"ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
    //"tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
	ctbai = dataset.getValue(1,2);
	fechtbai = dataset.getValue(1,5);
	var codqr = dataset.getValue(1,4);
	if(ctbai && fechtbai/*&& application.getApplicationType() != APPLICATION_TYPES.SMART_CLIENT*/)
	{
		xmltbai = 0;
		anulatbai = 0;
		modificartbai = 0;	
		elements.btn_prev_factura_antesTBAI.visible = false;
		elements.btn_prev_factura_antesTBAI.enabled = false;
	}
	else if(!ctbai && codqr)
	{
		xmltbai = 0;
		anulatbai = 0;
		modificartbai = 0;
		elements.btn_prev_factura_antesTBAI.visible = false;
		elements.btn_prev_factura_antesTBAI.enabled = false;
	}
	else
	{
		xmltbai = 1;
		anulatbai = 0;
		modificartbai = 0;
		elements.btn_prev_factura_antesTBAI.visible = true;
		elements.btn_prev_factura_antesTBAI.enabled = true;
	}
	//if(globals.GCNombreUsuario == 'JAVI') entorno_ticketbai = 1;
	if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbaientorno == 1) entorno_ticketbai = 1;
	else entorno_ticketbai = 0;
	/*mactbai = dataset.getValue(1,2);
	qrtbai = dataset.getValue(1,4);
	fechtbai = dataset.getValue(1,5);*/
	elements.desdenup.requestFocus()
	
	
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"E365A119-E2DA-46E7-B015-B2768AA7D095"}
 */
function onActiondesdeeje(event) {
	// TODO Auto-generated method stub
	elements.desdeser.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"6E96D837-2B37-42E5-895F-556F7703F705"}
 */
function onActiondesdeser(event) {
	// TODO Auto-generated method stub
	elements.desdenup.selectAll()
	elements.desdenup.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"2A02495B-3196-4313-9C40-EBF10DB0CC94"}
 */
function onActiondesdenup(event) {
	// TODO Auto-generated method stub
	elements.hastanup.selectAll()
	elements.hastanup.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"EC4B6D56-EE01-4B61-BDF8-59BB987A985A"}
 */
function onActionhastaeje(event) {
	// TODO Auto-generated method stub
	elements.hastaser.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"4C7E52FB-6B7E-4CCB-82F5-EFB4E243629B"}
 */
function onActionhastaser(event) {
	// TODO Auto-generated method stub
	elements.hastanup.selectAll()
	elements.hastanup.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"F1FFEC62-2A86-4BA9-A17A-7CAF95446232"}
 */
function btn_DesdeCliente(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'dlg_ImpresionFacturasVERIFACTU1';
	//globals.GCshowDialogClientes('Clientes', 1, null, null, true, 'Borrar Línea', null, null, null, null);
	var win = application.getWindow('Clientes')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Clientes", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Clientes';
	//win.resizable = true;
	win.show(forms.dialog_ClientesGC)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"1EDEE02C-1631-4CD2-8535-286B6BE93313"}
 */
function btn_HastaCliente(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'dlg_ImpresionFacturasVERIFACTU2';
	//globals.GCshowDialogClientes('Clientes', 1, null, null, true, 'Borrar Línea', null, null, null, null);
	var win = application.getWindow('Clientes')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Clientes", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Clientes';
	//win.resizable = true;
	win.show(forms.dialog_ClientesGC)
}

/**
 * @properties={typeid:24,uuid:"E99405E9-C057-4CB3-990E-D77D88D1411A"}
 */
function certif(){
	if(gcparametrosaplicacion_to_parametrosaplicacion.certifdigital) Certif = gcparametrosaplicacion_to_parametrosaplicacion.name_certifdigital;
	else Certif = 'NO SE HA GUARDADO CERTIFICADO ALGUNO\n EN LOS PARAMETROS DE LA APLICACIÓN'
	
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 * @properties={typeid:24,uuid:"07620B30-7710-4388-B4F7-5DD6B1429612"}
 */
function onDataChangednup() {
	// TODO Auto-generated method stub
	HastaNup = DesdeNup;
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 *
 * @properties={typeid:24,uuid:"E6ECA739-4C7D-4EB0-903C-A1445C55245A"}
 */
function onDataChangehnup() {
	// TODO Auto-generated method stub
	DesdeNup = HastaNup;
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"8E854A84-48FA-4F66-B08F-11ECE5CDA0AA"}
 */
function onActionDatosTicketBAI(event) {
	var query = "SELECT tbFacturaCabecera.ID, tbFacturaCabecera.mac, tbFacturaCabecera.ctbai, tbFacturaCabecera.cqr, "+
	"tbFacturaCabecera.fechaenviofichero, tbfacturaCabecera.fichero_respuesta_tbai, tbfacturaCabecera.firmafactura,tbfacturaCabecera.xml_enviado_tbai "+
    "FROM tbFacturaCabecera tbFacturaCabecera "+
    "WHERE (tbFacturaCabecera.eje_cfa >= "+DesdeEje+
    " AND tbFacturaCabecera.eje_cfa <= "+HastaEje+") "+
    "AND (tbFacturaCabecera.ser_cfa >= '"+DesdeSer+"' "+
    "AND tbFacturaCabecera.ser_cfa <= '"+HastaSer+"') "+
    "AND (tbFacturaCabecera.nup_cfa >= "+DesdeNup+
    " AND tbFacturaCabecera.nup_cfa <= "+HastaNup+") "
    //"AND (tbFacturaCabecera.clie_cfa BETWEEN "+DesdeCliente+" AND "+HastaCliente+") "+
    //"ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
    //"tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
	ctbai = dataset.getValue(1,3);
	mactbai = dataset.getValue(1,2);
	qrtbai = dataset.getValue(1,4);
	fechtbai = dataset.getValue(1,5);
	frtbai = dataset.getValue(1,6);
	firmatbai = dataset.getValue(1,7);
	fichxmlenvtbai = dataset.getValue(1,8);
	
	
	var menu = plugins.window.createPopupMenu();
	
	if(mactbai)	var titulo = 'Serial dispositivo: '+ mactbai;
	else if(!mactbai && qrtbai) titulo = 'Serial dispositivo: FACTURA ANULADA EN VERIFACTU';
	else titulo = 'Serial dispositivo: NO SE HA ENVIDO A VERIFACTU';
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///Computer.png');
	if(ctbai/* && mactbai*/)	titulo = 'TBai: '+ctbai;	
	else titulo = 'TBai:  NO SE HA ENVIDO A VERIFACTU';	
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///TicketBai_ES.png');
	if(qrtbai/* && mactbai*/) titulo = 'QR: '+qrtbai;
	else titulo = 'QR:  NO SE HA ENVIDO A VERIFACTU';
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///QR.JPG');
	if(fechtbai/* && mactbai*/) titulo = 'Fecha Envío: '+utils.dateFormat(fechtbai,'dd-MM-yyyy HH:mm');//utils.dateFormat(fechtbai,'dd-MM-yyyy HH:mm');	
	else titulo = 'Fecha Envío: NO SE HA ENVIDO A VERIFACTU';
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///31.PNG');
	if(frtbai/* && mactbai*/) titulo = 'Fichero de respuesta VERIFACTU tras el envío ';
	else titulo = 'Fichero de respuesta VERIFACTU: NO EXISTE FICHERO DE RESPUESTA DE VERIFACTU';
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///admin_24.gif');
	if(firmatbai/* && mactbai*/) titulo = 'Firma: '+firmatbai;
	else titulo = 'Firma: NO SE HA ENVIDO A VERIFACTU';
	//titulo = titulo.toUpperCase();				
	menu.addMenuItem(titulo, MenuTbai, 'media:///login2.png');
	titulo = 'Visualizar XML envío a VERIFACTU';
	menu.addMenuItem(titulo, MenuTbai, 'media:///xml.gif');
	titulo = 'Consulta de facturas enviadas a VERIFACTU';
	if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20') menu.addMenuItem(titulo, MenuTbai, 'media:///gipuzkoa_diputacion.gif');
	else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01') menu.addMenuItem(titulo, MenuTbai, 'media:///araba_diputacion.gif');
	else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48') menu.addMenuItem(titulo, MenuTbai, 'media:///vizcaya_batuz_diputacion.gif');
	else menu.addMenuItem(titulo, MenuTbai, 'media:///consulta.gif');
	/*if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
	utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48') 
	{
		titulo = 'Libro registro de operaciones económicas (LROE)';
		menu.addMenuItem(titulo, MenuTbai, 'media:///vizcaya_batuz_diputacion.gif');
	}*/
	
	if (event.getSource()) {
		// display the popup over the component which is the source of the event
		menu.show(event.getSource(),0,0);				
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {JSEvent} event
 *
 * @SuppressWarnings(unused)
 * @SuppressWarnings(wrongparameters)
 *
 * @properties={typeid:24,uuid:"B3C606E8-7D8E-4686-97D0-75C90810FCD9"}
 */
function MenuTbai(event){
	switch (arguments[4]) {
			case ('Serial dispositivo: ' + mactbai).toUpperCase():
			
			break;
		case ('Verifactu: '+ctbai):
			if((application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT ||
					application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT) && ctbai)
			{
				application.setClipboardContent(ctbai)
				globals.GCshowInfoDialog(ctbai+"\ncopiado al portapapeles.", null, null, null, null, null)
			}
			else if(application.getApplicationType() == APPLICATION_TYPES.NG_CLIENT && plugins.ngdesktoputils)
			{
				plugins.ngdesktoputils.setClipboardContent(ctbai);				
			}
			break;
		case 'QR: '+qrtbai:
			application.showURL(qrtbai,'_blank')
			break;
		case ('Fecha Envío: '+utils.dateFormat(fechtbai,'dd-MM-yyyy HH:mm')).toUpperCase():
		
		break;
		case ('Fichero de respuesta VERIFACTU tras el envío '):
			if(frtbai)
			{
				var tempFile = /*plugins.file.createFile(filename)*/plugins.file.createTempFile('_salida','.xml');
				var success = plugins.file.writeFile(tempFile, frtbai);
				uploadCallbackFunction2(tempFile)
				break;
			}
			else break;
		case ('Visualizar XML envío a VERIFACTU'):
			var nfactura = forms.FrmFacturasGC.eje_cfa+utils.numberFormat(forms.FrmFacturasGC.nup_cfa,'00000')+forms.FrmFacturasGC.ser_cfa;
			var vSet = databaseManager.getFoundSet(globals.GCconex, 'tbfacturacabecera')
			vSet.loadRecords(databaseManager.convertToDataSet([forms.FrmFacturasGC.id]))  
			var record = vSet.getRecord(vSet.getSelectedIndex())
			var ruta =  "c:\\tmp\\TBAI"+nfactura+"_firma.xml";
			var f = plugins.file.convertToJSFile(ruta);		
			if(fichxmlenvtbai){
				tempFile = /*plugins.file.createFile(filename)*/plugins.file.createTempFile('_XMLEnvioTBAI','.xml');
				success = plugins.file.writeFile(tempFile, fichxmlenvtbai);
				uploadCallbackFunction99(tempFile)
			}
			else if(f && f.exists())
			{
				var rawData = plugins.file.readFile(ruta);
				record.xml_enviado_tbai = rawData;
				databaseManager.saveData(record);
				var query = "SELECT tbfacturaCabecera.xml_enviado_tbai "+
			    "FROM tbFacturaCabecera tbFacturaCabecera "+
			    "WHERE (tbFacturaCabecera.eje_cfa >= "+DesdeEje+
			    " AND tbFacturaCabecera.eje_cfa <= "+HastaEje+") "+
			    "AND (tbFacturaCabecera.ser_cfa >= '"+DesdeSer+"' "+
			    "AND tbFacturaCabecera.ser_cfa <= '"+HastaSer+"') "+
			    "AND (tbFacturaCabecera.nup_cfa >= "+DesdeNup+
			    " AND tbFacturaCabecera.nup_cfa <= "+HastaNup+") "
			    var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
				fichxmlenvtbai = dataset.getValue(1,1);
				
				tempFile = /*plugins.file.createFile(filename)*/plugins.file.createTempFile('_XMLEnvioVERIFACTU','.xml');
				success = plugins.file.writeFile(tempFile, rawData);
				uploadCallbackFunction99(tempFile)
			}
			else VisualizarXML()
		break;
		case ('Consulta de facturas enviadas a VERIFACTU'):
			if(entorno_ticketbai == 0)//pruebas
			{
				if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
						utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20')//GUIPUZCOA
				{
					application.showURL('http://egoitza.gipuzkoa.eus/WAS/CORP/WATTramiteakWEB/inicio.do','_blank')
				}
				else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
				utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01')//ARABA
				{
					application.showURL('https://pruebas-ticketbai.araba.eus/tbai/consultafacturas/?idioma=es','_blank')
				}
				else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
				utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48')//VIZCAYA
				{
					application.showURL('https://batuz.eus/misfacturas','_blank')
				}
				else
				{
					application.showURL('http://egoitza.gipuzkoa.eus/WAS/CORP/WATTramiteakWEB/inicio.do','_blank')
				}
			}
			else//real
			{
				if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
				utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20')//GUIPUZCOA
				{
					application.showURL('http://egoitza.gipuzkoa.eus/WAS/CORP/WATTramiteakWEB/inicio.do','_blank')
				}
				else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
				utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01')//ARABA
				{
					application.showURL('https://ticketbai.araba.eus/tbai/consultafacturas/?idioma=es','_blank')
				}
				else if(gcparametrosaplicacion_to_parametrosaplicacion.codpostal &&
				utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48')//VIZCAYA
				{
					application.showURL('https://batuz.eus/misfacturas','_blank')
				}
				else
				{
					application.showURL('http://egoitza.gipuzkoa.eus/WAS/CORP/WATTramiteakWEB/inicio.do','_blank')
				}
			}
			break;
		case('Libro registro de operaciones económicas (LROE)'):
			LROEXML()
			break;
		default: break;
	}
}

/**
 * @properties={typeid:24,uuid:"DD84D4DF-82EE-4062-BC5F-A13589BB70BB"}
 */
function LROEXML(){
	try{
		var ok = 0;
		/*var js = "c:\\tmp\\TBAI2309824_firma.xml";
		var f = plugins.file.convertToJSFile(js);
		if(f && f.exists())
		{
			var byteArray = plugins.file.readFile('c:\\tmp\\TBAI2309824_firma.xml');
			if(byteArray){
				var byteArraybase64 = utils.bytesToBase64(byteArray);
				application.output(byteArraybase64)
			}
		}*/
		var xml = new String();
		htm = new String();
		newxml = new String();
		if(forms.FrmFacturasGC.id && forms.FrmFacturasGC.eje_cfa && forms.FrmFacturasGC.nup_cfa && 
		forms.FrmFacturasGC.xml_enviado_tbai && forms.FrmFacturasGC.GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0)
		{
			xml = '<?xml version="1.0" encoding="UTF-8"?>';
			Document = <lrpjfecsgap/>
				Cabecera = <Cabecera/>
					Modelo = <Modelo/>
					//Modelo 140 Autonomos
					//Modelo 240 Personas jurídicas
					Modelo.appendChild('240')
					//Capitulo 1 Facturas Emitidas
					//Capitulo 2 Facturas Recibidas
					Capitulo =<Capitulo/>
					Capitulo.appendChild(1)
					//1.1 – Facturas emitidas con software garante
					Subcapitulo = <Subcapitulo/>
					Subcapitulo.appendChild('1.1')
					Operacion = <Operacion/>
					Operacion.appendChild('A00')
					Version = <Version/>
					Version.appendChild('1.0')
					Ejercicio = <Ejercicio/>
					Ejercicio.appendChild(new Date().getFullYear())
					ObligadoTributario = <ObligadoTributario/>
						NIF = <NIF/>
						if(forms.dlg_ImpresionFacturasTBAIGC.entorno_ticketbai == 0) NIF.appendChild('A99800005')
						else NIF.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.cif)
						ApellidosNombreRazonSocial = <ApellidosNombreRazonSocial/>
						if(forms.dlg_ImpresionFacturasTBAIGC.entorno_ticketbai == 0) ApellidosNombreRazonSocial.appendChild('SOFTWARE GARANTE TICKETBAI PRUEBA')
						else ApellidosNombreRazonSocial.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.empresa)
					ObligadoTributario.appendChild(NIF)
					ObligadoTributario.appendChild(ApellidosNombreRazonSocial)
				Cabecera.appendChild(Modelo)	
				Cabecera.appendChild(Capitulo)
				Cabecera.appendChild(Subcapitulo)
				Cabecera.appendChild(Operacion)
				Cabecera.appendChild(Version)
				Cabecera.appendChild(Ejercicio)
				Cabecera.appendChild(ObligadoTributario)
				FacturasEmitidas = <FacturasEmitidas/>
					FacturaEmitida = <FacturaEmitida/>
						TicketBai = <TicketBai/>
						if(forms.FrmFacturasGC.xml_enviado_tbai) TicketBai.appendChild(utils.bytesToBase64(forms.FrmFacturasGC.xml_enviado_tbai))
						else TicketBai.appendChild('')
					FacturaEmitida.appendChild(TicketBai)	
				FacturasEmitidas.appendChild(FacturaEmitida)
			Document.appendChild(Cabecera)
			Document.appendChild(FacturasEmitidas)
			
			xml += Document
			//var newxml = xml.toString().replace(' xmlns=""','')
			newxml = utils.stringReplace(xml.toString(),'<lrpjfecsgap','<lrpjfecsgap:LROEPJ240FacturasEmitidasConSGAltaPeticion')
			newxml = utils.stringReplace(newxml,'</lrpjfecsgap','</lrpjfecsgap:LROEPJ240FacturasEmitidasConSGAltaPeticion')
			newxml = utils.stringReplace(newxml,'<lrpjfecsgap:LROEPJ240FacturasEmitidasConSGAltaPeticion>','<lrpjfecsgap:LROEPJ240FacturasEmitidasConSGAltaPeticion  xmlns:lrpjfecsgap="https://www.batuz.eus/fitxategiak/batuz/LROE/esquemas/LROE_PJ_240_1_1_FacturasEmitidas_ConSG_AltaPeticion_V1_0_2.xsd">')
			
			newxml = utils.stringReplace(newxml,' xmlns=""','')
			//var xml2 = new XML(newxml)
			application.output(newxml);
			htm = newxml
			var nfactura = forms.FrmFacturasGC.eje_cfa+utils.numberFormat(forms.FrmFacturasGC.nup_cfa,'00000')+forms.FrmFacturasGC.ser_cfa;
			/*if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
			{
				var js = plugins.file.showFileSaveDialog("LROE"+nfactura+".xml", 'Selecciona localización para salvar el fichero');
				if (!js) return;			
									
				ok = 1
				// Write the file in the selected location
				plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');
			}
			else
			{*/
				ok = 1
						/*js = application.getServerURL()  + "\\uploads\\FacturaE32.xml"
						plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');	*/
						
						var jsFile = plugins.file.createTempFile('LROE'+nfactura,'.xml');
						
						var success = plugins.file.writeXMLFile(jsFile , newxml.toString());
						if (!success) application.output('Could not write file.');
						
						//plugins.file.streamFilesToServer(jsFile)
						//plugins.file.openFile(jsFile,"_blank",'application/xml')
						else plugins.file.openFile('TBAI'+nfactura+'.xml',jsFile.getBytes(),'application/txt')
			//}
		}
	}
	catch (e) 
	{
		application.output("catched exception");
		application.output(e);
	} 
	finally 
	{
		if(ok == 1)
		{
			//application.output('Fichero XML generado correctamente')
			
			//application.getWindow('Impresion Facturas').hide();
			//globals.GCenableBgElements();
		}
	}
}

/**
 * @properties={typeid:24,uuid:"D23504E7-8AF8-41AA-9390-2A8FBDBFB89F"}
 */
function VisualizarXML(){
	try{
		var desdecli = forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeCliente;
		if(desdecli == null || desdecli == '') desdecli = 1;
		var hastacli = forms.dlg_ImpresionFacturasVERIFACTUGC.HastaCliente;
		if(hastacli == null || hastacli == '') hastacli = 9999999999;
		var ok = 0;
		
		if(forms.FrmFacturasGC.id && forms.FrmFacturasGC.eje_cfa && forms.FrmFacturasGC.nup_cfa && 
				forms.FrmFacturasGC.GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0)
		{
			var query = "SELECT ParametrosAplicacion.NºEmpresa,ParametrosAplicacion.Propiedad,"+
		    "ParametrosAplicacion.Empresa,ParametrosAplicacion.CodPostal,"+
		    "ParametrosAplicacion.Direccion,ParametrosAplicacion.Poblacion,"+
		    "ParametrosAplicacion.Provincia,ParametrosAplicacion.CIF,"+
		    "ParametrosAplicacion.Telefono,ParametrosAplicacion.Fax,"+
		    "ParametrosAplicacion.Mail,ParametrosAplicacion.Web,"+
		    "ParametrosAplicacion.Logo,ParametrosAplicacion.Logo2,"+
		    "ParametrosAplicacion.TelAux,ParametrosAplicacion.CtaBancaria,"+
		    "ParametrosAplicacion.Registro,ParametrosAplicacion.Tomo,"+
		    "ParametrosAplicacion.Folio,ParametrosAplicacion.HojaRegistral,"+
		    "ParametrosAplicacion.pais,"+
		    "tbFacturaCabecera.ID,tbFacturaCabecera.eje_cfa,"+
		    "tbFacturaCabecera.ser_cfa,tbFacturaCabecera.nup_cfa,"+
		    "tbFacturaCabecera.fecha_cfa,tbFacturaCabecera.fechcobro_cfa,"+
		    "tbFacturaCabecera.fechconta_cfa,tbFacturaCabecera.clie_cfa,"+
		    "tbFacturaCabecera.cfpa_cfa,tbFacturaCabecera.desccfpa_cfa,"+
		    "tbFacturaCabecera.repr_cfa,tbFacturaCabecera.obse_cfa,"+
		    "tbFacturaCabecera.fenvio,tbFacturaCabecera.situconta,"+
		    "tbFacturaCabecera.situ,tbFacturaCabecera.impbre_cfa,"+
		    "tbFacturaCabecera.depp_cfa,tbFacturaCabecera.pgfi_cfa,"+
		    "tbFacturaCabecera.impbie_cfa,tbFacturaCabecera.piva_cfa,"+
		    "tbFacturaCabecera.cuotaiva_cfa,tbFacturaCabecera.impbie2_cfa,"+
		    "tbFacturaCabecera.piva2_cfa,tbFacturaCabecera.cuotaiva2_cfa,"+
		    "tbFacturaCabecera.impbie3_cfa,tbFacturaCabecera.piva3_cfa,"+
		    "tbFacturaCabecera.cuotaiva3_cfa,tbFacturaCabecera.impnee_cfa,"+
		    "tbFacturaCabecera.gtosfinan_cfa,tbFacturaCabecera.impgtosfinan,"+
		    "tbFacturaCabecera.impre,tbFacturaCabecera.impre2,"+
		    "tbFacturaCabecera.impre3,tbFacturaLinea.ID,tbFacturaLinea.eje_lfa,"+
		    "tbFacturaLinea.ser_lfa,tbFacturaLinea.nup_lfa,tbFacturaLinea.nli_lfa,"+
		    "tbFacturaLinea.nalb_lfa,tbFacturaLinea.lalb_lfa,"+
		    "tbFacturaLinea.ref_lfa,tbFacturaLinea.concep_lfa,"+
		    "tbFacturaLinea.cant1_lfa,tbFacturaLinea.prec_lfa,"+
		    "tbFacturaLinea.unme_lfa,tbFacturaLinea.piva_lfa,"+
		    "tbFacturaLinea.dto_lfa,tbFacturaLinea.impdto_lfa,"+
		    "tbFacturaLinea.clie_lfa,tbFacturaLinea.situ_lfa,"+
		    "tbFacturaLinea.precuni_lfa,tbFacturaLinea.impor_lfa,"+
		    "tbFacturaLinea.importot_lfa,tbFacturaLinea.fecha_lfa,"+
		    "tbFacturaLinea.nprograma_lfa,tbMaestroClientes.ID,"+
		    "tbMaestroClientes.IdCliente,tbMaestroClientes.DescCliente,"+
		    "tbMaestroClientes.Direccion,tbMaestroClientes.Poblacion,"+
		    "tbMaestroClientes.Provincia,tbMaestroClientes.CodPostal,"+
		    "tbMaestroClientes.RazonSocial,tbMaestroClientes.PersContacto,"+
		    "tbMaestroClientes.EmailContacto,tbMaestroClientes.Telf1,"+
		    "tbMaestroClientes.Telf2,tbMaestroClientes.Fax,"+
		    "tbMaestroClientes.CIF,tbMaestroClientes.NumProveedor,"+
		    "tbMaestroClientes.CuentaContable,tbMaestroClientes.IdFormaPago,"+
		    "tbMaestroClientes.TipoIva,tbMaestroClientes.IdMoneda,"+
		    "tbMaestroClientes.DiaPago1,tbMaestroClientes.DiaPago2,tbMaestroClientes.DiaPago3,"+
		    "tbMaestroClientes.Pais,tbMaestroClientes.Observaciones,"+
		    "tbMaestroClientes.CodigoBanco,tbMaestroClientes.CodigoSucursal,"+
		    "tbMaestroClientes.Codigo1DC,tbMaestroClientes.CodigoCuenta,"+
		    "tbMaestroArticulos.RefCliente,tbMaestroformpago.denom_fp,ParametrosAplicacion.bic,tbFacturaCabecera.impirpf,tbFacturaCabecera.pirpf "+
		    "FROM tbFacturaCabecera tbFacturaCabecera LEFT JOIN dbo.tbFacturaLinea tbFacturaLinea ON "+
			 "tbFacturaCabecera.eje_cfa = tbFacturaLinea.eje_lfa "+
		    "AND tbFacturaCabecera.nup_cfa = tbFacturaLinea.nup_lfa "+
		    "AND tbFacturaCabecera.ser_cfa = tbFacturaLinea.ser_lfa "+
		    "LEFT JOIN dbo.tbMaestroClientes tbMaestroClientes ON "+
			 "tbFacturaCabecera.clie_cfa = tbMaestroClientes.IdCliente "+
		    "LEFT JOIN dbo.tbMaestroformpago tbMaestroformpago ON "+
			 "tbFacturaCabecera.cfpa_cfa = tbMaestroformpago.codig_fp "+
		    "LEFT JOIN dbo.tbMaestroArticulos tbMaestroArticulos ON "+
			 "tbFacturaLinea.ref_lfa = tbMaestroArticulos.Codigo,"+
		    "dbo.ParametrosAplicacion ParametrosAplicacion "+
		    "WHERE (tbFacturaCabecera.eje_cfa >= "+DesdeEje+
		    " AND tbFacturaCabecera.eje_cfa <= "+HastaEje+") "+
		    "AND (tbFacturaCabecera.ser_cfa >= '"+DesdeSer+"' "+
		    "AND tbFacturaCabecera.ser_cfa <= '"+HastaSer+"') "+
		    "AND (tbFacturaCabecera.nup_cfa >= "+DesdeNup+
		    " AND tbFacturaCabecera.nup_cfa <= "+HastaNup+") "+
		    "AND (tbFacturaCabecera.clie_cfa BETWEEN "+desdecli+" AND "+hastacli+") "+
		    "ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
		    "tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
			var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,99999999)
			var rows = dataset.getMaxRowIndex();
			var xml = new String();
			var xml2 = new String();
			htm = new String();
			newxml = new String();
			if(rows > 0)
			{	
				//var uuidfactura = dataset.getValue(1,22)
				datosempresa(DesdeEje,DesdeSer,DesdeNup,HastaEje,HastaSer,HastaNup,desdecli,hastacli)
				var cliente = dataset.getValue(1,29);
					xml = '<?xml version="1.0" encoding="UTF-8"?>';
					xml2 = '<?xml version="1.0" encoding="UTF-8"?>';
					application.output('Cabecera')
					Document = <AltaFactuSistemaFacturacion/>
					Document2 = <AltaFactuSistemaFacturacion/>
					/*ns = new Namespace('T',"urn:ticketbai:emision")
					Document.addNamespace(ns)							
					
					ns = new Namespace('ds','http://www.w3.org/2000/09/xmldsig#')
					Document.addNamespace(ns)
					
					ns = new Namespace('schemaLocation', 'urn:ticketbai:emision ticketBaiV12.xsd ')
					Document.addNamespace(ns)
					
					ns = new Namespace('xsi','http://www.w3.org/2001/XMLSchema-instance')
					Document.addNamespace(ns)
					*/
					Cabecera = <Cabecera/>
						IDVersion = <IDVersion/>
						IDVersion.appendChild('0.1')
						ObligadoEmision = <ObligadoEmision/>
							NombreRazon = <NombreRazon/>
							NombreRazon.appendChild(globals.GCQuitarCaracteresEspeciales(gcparametrosaplicacion_to_parametrosaplicacion.empresa))
							NIF = <NIF/>
							NIF.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.cif)
							//NombreRazonRepresentante = <NombreRazonRepresentante/>
							//NombreRazonRepresentante.appendChild(child)
							//NIFRepresentante = <NIFRepresentante/>
							//NIFRepresentante.appendChild(child)
						ObligadoEmision.appendChild(NombreRazon)
						ObligadoEmision.appendChild(NIF)
						//ObligadoEmision.appendChild(NombreRazonRepresentante)
						//ObligadoEmision.appendChild(NIFRepresentante)
					Cabecera.appendChild(IDVersion)
					Cabecera.appendChild(ObligadoEmision)
					Document.appendChild(Cabecera)
					Document2.appendChild(Cabecera)
					RegistroAltaFacturas = <RegistroAltaFacturas/>
						RegistroFacturacion = <RegistroFacturacion/>
							PeriodoLiquidacion = <PeriodoLiquidacion/>
								Ejercicio = <Ejercicio/>
								var fechfra = dataset.getValue(1,26);
								if(!fechfra) fechfra = new Date();
								Ejercicio.appendChild(fechfra.getFullYear())
								/*1T	1º Trimestre
								2T	2º Trimestre
								3T	3º Trimestre
								4T	4º Trimestre*/
								Periodo = <Periodo/>
								if(fechfra.getMonth() == 0 || fechfra.getMonth() == 1 ||
								fechfra.getMonth() == 2){
									Periodo.appendChild('1T');
								}
								else if(fechfra.getMonth() == 3 || fechfra.getMonth() == 4 ||
								fechfra.getMonth() == 5){
									Periodo.appendChild('2T');
								}
								else if(fechfra.getMonth() == 6 || fechfra.getMonth() == 7 ||
								fechfra.getMonth() == 8){
									Periodo.appendChild('3T');
								}
								else {
									Periodo.appendChild('4T');
								}
							PeriodoLiquidacion.appendChild(Ejercicio)
							PeriodoLiquidacion.appendChild(Periodo)
							IDFactura = <IDFactura/>
								IDEmisorFactura = <IDEmisorFactura/>
									NIF = <NIF/>
									NIF.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.cif)
								IDEmisorFactura.appendChild(NIF)
								NumSerieFacturaEmisor = <NumSerieFacturaEmisor/>
								NumSerieFacturaEmisor.appendChild(dataset.getValue(1,23)+utils.numberFormat(dataset.getValue(1,25),'00000')+dataset.getValue(1,24))
								FechaExpedicionFacturaEmisor = <FechaExpedicionFacturaEmisor/>
								FechaExpedicionFacturaEmisor.appendChild(utils.dateFormat(fechfra,'dd-MM-yyyy'))
							IDFactura.appendChild(IDEmisorFactura)
							IDFactura.appendChild(NumSerieFacturaEmisor)
							IDFactura.appendChild(FechaExpedicionFacturaEmisor)
							/*F1	Factura (art. 6, 7.2 y 7.3 del RD 1619/2012)
							F2	Factura Simplificada y Facturas sin identificación del destinatario art. 6.1.d) RD 1619/2012
							F3	Factura emitida en sustitución de facturas simplificadas facturadas y declaradas
							R1	Factura Rectificativa (Error fundado en derecho y Art. 80 Uno Dos y Seis LIVA)
							R2	Factura Rectificativa (Art. 80.3)
							R3	Factura Rectificativa (Art. 80.4)
							R4	Factura Rectificativa (Resto)
							R5	Factura Rectificativa en facturas simplificadas
							*/
							TipoFactura = <TipoFactura/>
							TipoFactura.appendChild('F1')
							//Aqui van los nodos de las facturas rectificativas
							DescripcionOperacion = <DescripcionOperacion/>
							if(dataset.getValue(1,33)) DescripcionOperacion.appendChild(globals.GCQuitarCaracteresEspeciales(utils.stringLeft(dataset.getValue(1,33),250)))
							else DescripcionOperacion.appendChild(globals.GCQuitarCaracteresEspeciales("FACTURA "+dataset.getValue(1,23)+utils.numberFormat(dataset.getValue(1,25),'00000')+dataset.getValue(1,24)))
							Tercero = <Tercero/>
								NombreRazon = <NombreRazon/>
								NombreRazon.appendChild(globals.GCQuitarCaracteresEspeciales(gcparametrosaplicacion_to_parametrosaplicacion.empresa))
								NIF = <NIF/>
								NIF.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.cif)
							Tercero.appendChild(NombreRazon)
							Tercero.appendChild(NIF)
							Contraparte = <Contraparte/>
							cifempresa = utils.stringRight(cifcliente,9)//cifcliente//forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.cif;
								NombreRazon = <NombreRazon/>
								razonsocial = globals.GCQuitarCaracteresEspeciales(utils.stringLeft(desccliente,120))
								NombreRazon.appendChild(razonsocial)
								NIF = <NIF/>
								NIF = <NIF/>
								NIF.appendChild(cifempresa)
								IDOtro = <IDOtro/>
									CodigoPais = <CodigoPais/>
									CodigoPais.appendChild(paiscliente)
									IDType = <IDType/>
									/*02 NIF-IVA.
									  03 Pasaporte
									  04 Documento oficial de identificación expedido por el país o territorio de residencia.
									  05 Certificado de residencia.
									  06 Otro documento probatorio
									  07 No Censado*/
									if(UE.indexOf(paiscliente) != -1) IDType.appendChild('02')
									else IDType.appendChild('04')
									ID = <ID/>
									ID.appendChild(cifcliente)
								IDOtro.appendChild(CodigoPais)
								IDOtro.appendChild(IDType)
								IDOtro.appendChild(ID)								
							Contraparte.appendChild(NombreRazon)
							Contraparte.appendChild(NIF)
							Contraparte.appendChild(IDOtro)
							Desglose = <Desglose/>
							application.output('Lineas')	
							for(var i=1;i<=rows;i++)
							{
								DetalleDesglose = <DetalleDesglose/>
									/*01	Operación de régimen general.
									02	Exportación.
									03	Operaciones a las que se aplique el régimen especial de bienes usados, objetos de arte, antigüedades y objetos de colección.
									04	Régimen especial del oro de inversión.
									05	Régimen especial de las agencias de viajes.
									06	Régimen especial grupo de entidades en IVA (Nivel Avanzado)
									07	Régimen especial del criterio de caja.
									08	Operaciones sujetas al IPSI  / IGIC (Impuesto sobre la Producción, los Servicios y la Importación  / Impuesto General Indirecto Canario).
									09	Facturación de las prestaciones de servicios de agencias de viaje que actúan como mediadoras en nombre y por cuenta ajena (D.A.4ª RD1619/2012)
									10	Cobros por cuenta de terceros de honorarios profesionales o de derechos derivados de la propiedad industrial, de autor u otros por cuenta de sus socios, asociados o colegiados efectuados por sociedades, asociaciones, colegios profesionales u otras entidades que realicen estas funciones de cobro.
									11	Operaciones de arrendamiento de local de negocio.
									12	Factura con IVA pendiente de devengo en certificaciones de obra cuyo destinatario sea una Administración Pública.
									13	Factura con IVA pendiente de devengo en operaciones de tracto sucesivo.
									14	Régimen simplificado
									15	Recargo de equivalencia.
									16	Régimen especial de la agricultura*/
									ClaveRegimen = <ClaveRegimen/>
									if(paiscliente && paiscliente == 'ES') ClaveRegimen.appendChild('01')
									else ClaveRegimen.appendChild('02')
									
									/*S1	 Operación Sujeta y No exenta - Sin inversión del sujeto pasivo.
									S2	Operación Sujeta y No exenta - Con Inversión del sujeto pasivo
									N1	Operación No Sujeta artículo 7, 14, otros.
									N2	Operación No Sujeta por Reglas de localización.*/
									CalificacionOperacion = <CalificacionOperacion/>
									if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.pais &&
									forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.pais != 'ES')
									{
										forms.FrmFacturasGC.sujetaexentaivasii = 'E';
									}
									else if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal &&
											(utils.stringLeft(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '35' ||
											utils.stringLeft(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '38' ||
											utils.stringLeft(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '51' ||
											utils.stringLeft(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '52'))
									{
										forms.FrmFacturasGC.sujetaexentaivasii = 'NS';
									}
									else
									{
										forms.FrmFacturasGC.sujetaexentaivasii = 'NE';
									}
									if(forms.FrmFacturasGC.sujetaexentaivasii == 'E')
									{
										/*E0	Exenta sin especificar causa
										E1	Exenta por el artículo 20
										E2	Exenta por el artículo 21
										E3	Exenta por el artículo 22
										E4	Exenta por los artículos 23 y 24
										E5	Exenta por el artículo 25
										E6	Exenta por otros*/
										CalificacionOperacion.appendChild('E0')
									}
									else if(forms.FrmFacturasGC.sujetaexentaivasii == 'NS' && 
									codpostalcliente && (utils.stringLeft(codpostalcliente,2) == '35' ||
									utils.stringLeft(codpostalcliente,2) == '38'||
									utils.stringLeft(codpostalcliente,2) == '51'||
									utils.stringLeft(codpostalcliente,2) == '52'))
									{
										CalificacionOperacion.appendChild('N2')
									}
									else
									{
										CalificacionOperacion.appendChild('S1')
									}
									if(forms.FrmFacturasGC.sujetaexentaivasii == 'E')
									{
										/*E0	Exenta sin especificar causa
										E1	Exenta por el artículo 20
										E2	Exenta por el artículo 21
										E3	Exenta por el artículo 22
										E4	Exenta por los artículos 23 y 24
										E5	Exenta por el artículo 25
										E6	Exenta por otros
										 */
										 OperacionExenta = <OperacionExenta/>
										 OperacionExenta.appendChild('E0')
										 
									}
									//var c = dataset.getValue(i,64);
									//var impuni = dataset.getValue(i,65);
									var implin = dataset.getValue(i,73);
									var imptot = dataset.getValue(i,74);
									//var impdto = dataset.getValue(i,69);
									var pivalin = dataset.getValue(i,67);
									var cuotalin = globals.GCROUND(imptot - implin,2);
									var query999 = "select [aplicarre] FROM [tbMaestroClientes] WHERE [idcliente] = "+cliente;
									var dataset999 = databaseManager.getDataSetByQuery(globals.GCconex, query999, null, 1)
									if(dataset999.getValue(1,1) == 1)
									{
										query999 = "select [IvaRE] FROM [tbMaestroTipoIva] WHERE [Factor] = "+pivalin;
										dataset999 = databaseManager.getDataSetByQuery(globals.GCconex, query999, null, 1)
										var trelin = dataset999.getValue(1,1);
										var relin = globals.GCROUND(implin*trelin*0.01,2)
										//reimpuni = globals.GCROUND(impuni*trelin*0.01,2)
									}
									imptot = imptot + relin;
									TipoImpositivo = <TipoImpositivo/>
									TipoImpositivo.appendChild(pivalin)
									BaseImponibleOimporteNoSujeto = <BaseImponibleOimporteNoSujeto/>
									BaseImponibleOimporteNoSujeto.appendChild(implin)
									//BaseImponibleACoste = <BaseImponibleACoste/>
									//BaseImponibleACoste.appendChild('')
									CuotaRepercutida = <CuotaRepercutida/>
									CuotaRepercutida.appendChild(cuotalin)
									if(dataset999.getValue(1,1) == 1)
									{
										TipoRecargoEquivalencia = <TipoRecargoEquivalencia/>
										TipoRecargoEquivalencia.appendChild(trelin)
										CuotaRecargoEquivalencia = <CuotaRecargoEquivalencia/>
										CuotaRecargoEquivalencia.appendChild(relin)
									}
									
								DetalleDesglose.appendChild(ClaveRegimen)
								DetalleDesglose.appendChild(CalificacionOperacion)
								if(forms.FrmFacturasGC.sujetaexentaivasii == 'E') DetalleDesglose.appendChild(OperacionExenta)
								DetalleDesglose.appendChild(TipoImpositivo)
								DetalleDesglose.appendChild(BaseImponibleOimporteNoSujeto)
								//DetalleDesglose.appendChild(BaseImponibleACoste)
								DetalleDesglose.appendChild(CuotaRepercutida)
								if(dataset999.getValue(1,1) == 1)
								{
									DetalleDesglose.appendChild(TipoRecargoEquivalencia)
									DetalleDesglose.appendChild(CuotaRecargoEquivalencia)
								}
							}
							Desglose.appendChild(DetalleDesglose)	
							ImporteTotal = <ImporteTotal/>
							var importetotalfactura = dataset.getValue(1,49);
							if(!importetotalfactura) importetotalfactura = 0;
							ImporteTotal.appendChild(importetotalfactura)
							EncadenamientoFacturaAnterior = <EncadenamientoFacturaAnterior/>
								IDEmisorFacturaAnterior = <IDEmisorFacturaAnterior/>
								IDEmisorFacturaAnterior.appendChild(gcparametrosaplicacion_to_parametrosaplicacion.cif)
								//consulto el nº de facturas generadas en este ejercicio. Dependiendo de si es la primera o no hago una consulta u otra
								 var eje = dataset.getValue(1,23);
								var nup = dataset.getValue(1,25);
								//var uuidfraanterior = null;
								//var ser = dataset.getValue(1,24);
							
								query = "select count(*) from tbFacturaCabecera where eje_cfa = "+eje+" and nup_cfa != "+nup
							    var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1);
							    if(dataset2.getValue(1,1) > 0)
							    {
							    	//consulto la primera factura con fecha de envío a TicketBAI en este ejercicio o anteriores
									query = "select top 1 b.ID, b.eje_cfa, b.nup_cfa, b.fechaenviofichero, b.firmafactura, b.fecha_cfa "+
											"from tbFacturaCabecera a inner join tbFacturaCabecera b "+
											"on b.fechaenviofichero < isnull(a.fechaenviofichero, GETDATE()) "+
											"where a.eje_cfa = "+eje+" and a.nup_cfa = "+nup+
											" order by a.fechaenviofichero, b.fechaenviofichero desc,b.nup_cfa desc"	
							    }
							    else
							    {
							    	//consulto la primera factura del ejercicio anterior con fecha de envío a TicketBAI
							    	query = "select top 1 ID, eje_cfa, nup_cfa, fechaenviofichero, firmafactura, fecha_cfa from tbFacturaCabecera "+
							    			"where eje_cfa < "+eje+" and fechaenviofichero is not null order by fechaenviofichero desc, nup_cfa desc"
							    }
										
								dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1);
								//var uuidfraanterior = dataset2.getValue(1,1);
								var fechafraanterior = dataset2.getValue(1,6);
								var ejefraanterior = dataset2.getValue(1,2);
								var nupfraanterior = dataset2.getValue(1,3);
								//var fechenvfraanterior = dataset2.getValue(1,4);
								var firmafraanterior = dataset2.getValue(1,5);
								NumSerieFacturaAnterior = <NumSerieFacturaAnterior/>
								NumSerieFacturaAnterior.appendChild(ejefraanterior+utils.numberFormat(nupfraanterior,'00000'))
								FechaExpedicionFacturaAnterior = <FechaExpedicionFacturaAnterior/>
								//FechaExpedicionFacturaAnterior.appendChild(utils.dateFormat(fechenvfraanterior,'dd-MM-yyyy'))
								FechaExpedicionFacturaAnterior.appendChild(utils.dateFormat(fechafraanterior,'dd-MM-yyyy'))
								HuellaFacturaAnterior = <HuellaFacturaAnterior/>
								HuellaFacturaAnterior.appendChild(firmafraanterior)
							EncadenamientoFacturaAnterior.appendChild(IDEmisorFacturaAnterior)
							EncadenamientoFacturaAnterior.appendChild(NumSerieFacturaAnterior)
							EncadenamientoFacturaAnterior.appendChild(FechaExpedicionFacturaAnterior)
							EncadenamientoFacturaAnterior.appendChild(HuellaFacturaAnterior)
							SistemaInformatico = <SistemaInformatico/>
								NombreRazon = <NombreRazon/>
								NombreRazon.appendChild('AG INFORMÁTICA Y SERVICIOS S.A.')
								NIF = <NIF/>
								NIF.appendChild('A20170254')
								IdSistemaInformatico = <IdSistemaInformatico/>
								IdSistemaInformatico.appendChild('ERP_AG')
								Version = <Version/>
								if(gcparametrosaplicacion_to_parametrosaplicacion.empresa) Version.appendChild(new Date().getFullYear()+'-'+utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.empresa,14));	
								/*if(globals.GCconex == 'conexiongestioncomercialag') Version.appendChild(new Date().getFullYear()+'-AG');	
								else if(globals.GCconex == 'conexiongestionmlegazpipruebas') Version.appendChild(new Date().getFullYear()+'-MLEGAZPI');	
								else if(globals.GCconex == 'conexiongestiontmendizabalpruebas') Version.appendChild(new Date().getFullYear()+'-TMENDIZABAL');	
								else if(globals.GCconex == 'conexiongestionolabemarpruebas') Version.appendChild(new Date().getFullYear()+'-OLABEMAR');	
								else if(globals.GCconex == 'conexiongestioncomercialagdemo') Version.appendChild(new Date().getFullYear()+'-DEMO');	
								else if(globals.GCconex == 'conexiongestioncomercialagdemo2') Version.appendChild(new Date().getFullYear()+'-DEMO2');	
								else if(globals.GCconex == 'conexiongestionzusipruebas') Version.appendChild(new Date().getFullYear()+'-ZUSI');*/	
								else Version.appendChild(new Date().getFullYear()+'-')
								NumeroInstalacion = <NumeroInstalacion/>
								NumeroInstalacion.appendChild('1')
								/*01	Solo funciona en modo VERIFACTU
								02	Solo funciona en modo no-VERIFACTU (cumpliendo Reglamento)
								03	Funciona tanto en modo VERIFACTU como no-VERIFACTU (cumpliendo Reglamento)
								04	Otros
								*/
								TipoUsoSistema = <TipoUsoSistema/>
								TipoUsoSistema.appendChild('01')
							SistemaInformatico.appendChild(NombreRazon)
							SistemaInformatico.appendChild(NIF)
							SistemaInformatico.appendChild(IdSistemaInformatico)
							SistemaInformatico.appendChild(Version)
							SistemaInformatico.appendChild(NumeroInstalacion)
							SistemaInformatico.appendChild(TipoUsoSistema)
						RegistroFacturacion.appendChild(PeriodoLiquidacion)
						RegistroFacturacion.appendChild(IDFactura)
						RegistroFacturacion.appendChild(TipoFactura)
						//datos factura rectificativa
						RegistroFacturacion.appendChild(DescripcionOperacion)
						RegistroFacturacion.appendChild(Tercero)
						RegistroFacturacion.appendChild(Contraparte)
						RegistroFacturacion.appendChild(Desglose)
						RegistroFacturacion.appendChild(ImporteTotal)
						RegistroFacturacion.appendChild(EncadenamientoFacturaAnterior)
						RegistroFacturacion.appendChild(SistemaInformatico)
						RegistroAltaFacturas.appendChild(RegistroFacturacion)
						Document2.appendChild(RegistroAltaFacturas)
						xml2 += Document2
						newxml = xml2.toString().replace(' xmlns=""','')
						//newxml = utils.stringReplace(xml.toString(),'<TicketBai','<T:TicketBai')
						//newxml = utils.stringReplace(newxml,'</TicketBai','</T:TicketBai')
						newxml = utils.stringReplace(newxml,'<AltaFactuSistemaFacturacion>','<SistemaFacturacionAltaFact xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/TR/xmldsig-core/xmldsig-core-schema.xsd">')
						//newxml = utils.stringReplace(newxml,'<T:TicketBai>','<T:TicketBai xmlns:T="urn:ticketbai:emision" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:ticketbai:emision ticketBaiV1-2.xsd"> ')
					
						newxml = utils.stringReplace(newxml,' xmlns=""','')
						newxml = utils.stringReplace(newxml,'\n','')
						//var xml2 = new XML(newxml)
						application.output(newxml); 
						//var x = scopes.NCRYPT.HMAC(scopes.NCRYPT.SHA256,newxml,"some key", { asBytes: true })
						//var y = scopes.NCRYPT.util.bytesToBase64(x)
						var huellaverifactuhashSHA256 = sha265(newxml);
						//var huellaverifactuhashSHA256_2 = utils.stringMD5HashBase64(newxml);
						//var huellaverifactuhashSHA256_3 = utils.stringPBKDF2Hash(newxml);
						//var huellaverifactuhashSHA256_4 = globals.GCcryptString(newxml,globals.GCcryptKey,'C');
						//application.output(y)
						application.output(huellaverifactuhashSHA256)
						//application.output(huellaverifactuhashSHA256_2)
						//application.output(huellaverifactuhashSHA256_3)
						//application.output(huellaverifactuhashSHA256_4)
						var fechaverifactuhashSHA256 = new Date();
						var horaVF = utils.dateFormat(fechaverifactuhashSHA256,'hh:mm ss') 
						horaVF = utils.stringReplace(horaVF,' ',':')
						DatosControl = <DatosControl/>							
							Huella = <Huella/>
							Huella.appendChild(huellaverifactuhashSHA256)
							/*01	SHA-256*/
							TipoHash = <TipoHash/>
							TipoHash.appendChild('01')
							FechaGenRegistro = <FechaGenRegistro/>
							FechaGenRegistro.appendChild(utils.dateFormat(fechaverifactuhashSHA256,'dd-MM-yyyy'))
							HoraGenRegistro = <HoraGenRegistro/>
							HoraGenRegistro.appendChild(horaVF)
							/*01	GMT+0
							02	GMT+1
							03	GMT+2*/
							HusoHorarioGenRegistro = <HusoHorarioGenRegistro/>
							HusoHorarioGenRegistro.appendChild('02')
						DatosControl.appendChild(Huella)
						DatosControl.appendChild(TipoHash)
						DatosControl.appendChild(FechaGenRegistro)
						DatosControl.appendChild(HoraGenRegistro)
						DatosControl.appendChild(HusoHorarioGenRegistro)
					RegistroAltaFacturas.appendChild(DatosControl)	
					Document.appendChild(RegistroAltaFacturas)
										
				
				xml += Document
				newxml = xml.toString().replace(' xmlns=""','')
				//newxml = utils.stringReplace(xml.toString(),'<TicketBai','<T:TicketBai')
				//newxml = utils.stringReplace(newxml,'</TicketBai','</T:TicketBai')
				newxml = utils.stringReplace(newxml,'<AltaFactuSistemaFacturacion>','<SistemaFacturacionAltaFact xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/TR/xmldsig-core/xmldsig-core-schema.xsd">')
				//newxml = utils.stringReplace(newxml,'<T:TicketBai>','<T:TicketBai xmlns:T="urn:ticketbai:emision" xmlns:ds="http://www.w3.org/2000/09/xmldsig#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:ticketbai:emision ticketBaiV1-2.xsd"> ')
				
				newxml = utils.stringReplace(newxml,' xmlns=""','')
				//var xml2 = new XML(newxml)
				application.output(newxml);
				htm = newxml
				var nfactura = dataset.getValue(1,23)+utils.numberFormat(dataset.getValue(1,25),'00000')+dataset.getValue(1,24);
				/*if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
				{
					var js = plugins.file.showFileSaveDialog("VERIFACTU"+nfactura+".xml", 'Selecciona localización para salvar el fichero');
					if (!js) return;			
										
					ok = 1
					// Write the file in the selected location
					plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');
				}
				else
				{*/
					ok = 1
							/*js = application.getServerURL()  + "\\uploads\\FacturaE32.xml"
							plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');	*/
							
							var jsFile = plugins.file.createTempFile('VERIFACTU'+nfactura,'.xml');
							
							var success = plugins.file.writeXMLFile(jsFile , newxml.toString());
							if (!success) application.output('Could not write file.');
							
							//plugins.file.streamFilesToServer(jsFile)
							//plugins.file.openFile(jsFile,"_blank",'application/xml')
							else plugins.file.openFile('VERIFACTU'+nfactura+'.xml',jsFile.getBytes(),'application/txt')
				//}
			}
		}
	}
	catch (e) 
	{
		application.output("catched exception");
		application.output(e);
	} 
	finally 
	{
		if(ok == 1)
		{
			application.output('Fichero XML generado correctamente')
			//application.getWindow('Impresion Facturas').hide();
			//globals.GCenableBgElements();
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param v_event
 *
 * @SuppressWarnings(deprecated)
 *
 *
 * @SuppressWarnings(unused)
 *
 *
 * @properties={typeid:24,uuid:"87EC9FAE-97EC-420B-A8E2-6FF64C1FA5FD"}
 */
function handle_shortCutGC(v_event)
{
	globals.GCevento = null
	//var fname = controller.getName()
	var frm = currentcontroller.getName();
	if(v_event.getType() == 'control F10')
	{
		elements.xmltbai.enabled = true;
		elements.anulatbai.enabled = true;
		elements.modificartbai.enabled = true;
	}
	else if(v_event.getType() == 'control alt B' && (gcfechalimite_usuarios.taop_019 == '1'/*globals.GCNombreUsuario == 'ADMINISTRADOR' || globals.GCNombreUsuario == 'JAVI'*/))
	{
		var methd = 'forms.dlg_ImpresionFacturasTBAIGC.BorrarDatosTicketBAI(event)'
		globals.GCshowQuestionDialog("¿Desea borrar realmente los datos de TicketBAI?",methd,'No','Si',null,null)		
	}
	else if(v_event.getType() == 'control alt V' && (gcfechalimite_usuarios.taop_019 == '1'/*globals.GCNombreUsuario == 'ADMINISTRADOR' || globals.GCNombreUsuario == 'JAVI'*/))
	{
		elements.btn_editardatosTBAI.enabled = true;
		elements.btn_borrardatosTBAI.enabled = true;	
		elements.btn_importardatosTBAI.enabled = true;	
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {JSEvent} event
 *
 *
 *
 * @properties={typeid:24,uuid:"14626D3E-26A9-4740-822D-740830CBE0D7"}
 */
function BorrarDatosTicketBAI(event)
{
	if(globals.core_dlg_buttonPressed == 'Si')
	{
		forms.FrmFacturasGC.mac = null;
		forms.FrmFacturasGC.ctbai = null;
		forms.FrmFacturasGC.cqr = null;
		forms.FrmFacturasGC.fechaenviofichero = null;
		forms.FrmFacturasGC.firmafactura = null;
		forms.FrmFacturasGC.mac = null;
		forms.FrmFacturasGC.fichero_respuesta_tbai = null;
		databaseManager.saveData(forms.FrmFacturasGC.foundset)
	}
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 *
 * @properties={typeid:24,uuid:"E3F59B3B-71AD-4DBC-8D0A-408122826ED2"}
 */
function onDataChangemodificartbai() {
	if(modificartbai == 1)
	{
		xmltbai = 0;
		anulatbai = 0;
	}	
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 * @properties={typeid:24,uuid:"65EC6B2B-743C-49E7-81B0-FA1A4FDF91A7"}
 */
function onDataChangeanulatbai() {
	if(anulatbai == 1)
	{
		xmltbai = 0;
		modificartbai = 0;
	}	
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 *
 * @properties={typeid:24,uuid:"835D4CF3-8379-4477-9084-D54D7E415841"}
 */
function onDataChangexmltbai() {
	if(xmltbai == 1)
	{
		anulatbai = 0;
		modificartbai = 0;
	}	
}

/**
* @param {plugins.file.JSFile} _oFile
*
 *
 *
 * @SuppressWarnings(unused)
 *
 *
 * @properties={typeid:24,uuid:"58B673BD-F778-4557-85EE-7450BF0BDF71"}
 */
function uploadCallbackFunction2(_oFile) {
    // Streaming the file to the server and call the callback method when this is done
   var monitor = plugins.file.streamFilesToServer(_oFile, Visualizar);
	
}

/**
 * @properties={typeid:24,uuid:"5FB4B26B-5BCF-43A8-8353-8A905BF6851F"}
 */
function btn_previsualizar_factura()
{	
	var desdeeje = forms.dlg_ImpresionFacturasTBAIGC.DesdeEje;
	if(desdeeje == null || desdeeje == '') desdeeje = 0;
	var desdeser = forms.dlg_ImpresionFacturasTBAIGC.DesdeSer;
	if(desdeser == null || desdeser == '') desdeser = '';
	var desdenup = forms.dlg_ImpresionFacturasTBAIGC.DesdeNup;
	if(desdenup == null || desdenup == '') desdenup = 1;
	var hastaeje = forms.dlg_ImpresionFacturasTBAIGC.HastaEje;
	if(hastaeje == null || hastaeje == '') hastaeje = 9999;
	var hastaser = forms.dlg_ImpresionFacturasTBAIGC.HastaSer;
	if(hastaser == null || hastaser == '') hastaser = 'ZZ';
	var hastanup = forms.dlg_ImpresionFacturasTBAIGC.HastaNup;
	if(hastanup == null || hastanup == '') hastanup = 999999999;
	var desdecli = forms.dlg_ImpresionFacturasTBAIGC.DesdeCliente;
	if(desdecli == null || desdecli == '') desdecli = 1;
	var hastacli = forms.dlg_ImpresionFacturasTBAIGC.HastaCliente;
	if(hastacli == null || hastacli == '') hastacli = 9999999999;
	if(forms.dlg_ImpresionFacturasTBAIGC.FormatoFactura == 1) var ffra = 1;
	else if(forms.dlg_ImpresionFacturasTBAIGC.FormatoFactura2 == 1) ffra = 2;
	else if(forms.dlg_ImpresionFacturasTBAIGC.FormatoFactura3 == 1) ffra = 3;
	
	
	globals.btn_runJasperReportPrevFacturaVentasTBAI(desdeeje,desdeser,desdenup,hastaeje,hastaser,hastanup,desdecli,hastacli,ffra)
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {plugins.file.JSFile} _oFile
 *
 *
 *
 * @properties={typeid:24,uuid:"BD2DE444-6237-4EA7-ACBE-9D84889B8B0E"}
 * @SuppressWarnings(unused)
 * @SuppressWarnings(wrongparameters)
 */
function Visualizar(_oFile)
{
	var ext = _oFile.getContentType()
	if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
	{
		var sw = 0;
		
		//create a temporary file that will be auto-deleted by Servoy when client is exited
		var fname = plugins.file.createTempFile('_salida','.xml')

		//write the binary data out to disk at the temporary file location
		plugins.file.writeFile(fname,frtbai); 
		
		var vLocalFilePath = fname.getAbsolutePath();
		//windows
        if (utils.stringMiddle(application.getOSName(), 1, 7) == "Windows") {
        	sw = 1;
            var success = application.executeProgram('rundll32', ['url.dll,FileProtocolHandler', vLocalFilePath])
        }
        //FreeBSD or Linux
        else if (utils.stringMiddle(application.getOSName(), 1, 7) == "FreeBSD" || utils.stringMiddle(application.getOSName(), 1, 5) == "Linux") {
        	sw = 1;
            success = application.executeProgram('mozilla', [vLocalFilePath])
        }
        //Mac OSX
        else if (application.getOSName().match("Mac")) {
        	sw = 1;
            success = application.executeProgram('open', [vLocalFilePath])
        }
        if(sw == 1)
        {
        	//var msg = "¿Desea borrar de la Base de Datos este documento?"
        	//var methd = 'forms.lst_AsientoContable_Lineas.BorradoPDF()'
        	//globals.CONTAshowQuestionDialog(msg,methd,'No','Si',null,null)
        }
	}
	else
	{
		if(ext == null) ext='text/plain'
			else if(ext == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || ext == 'application/vnd.ms-excel' ||
					ext == 'application/vnd.ms-excel.sheet.binary.macroenabled.12') ext = 'application/msexcel'
			else if(ext == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') ext = 'application/msword'
		if(ext == 'application/msexcel' || ext == 'application/msword')
		{
			serverURL = application.getServerURL() 
			application.showURL(serverURL + "uploads/" + _oFile.getName());
			//plugins.WebClientUtils.executeClientSideJS('location.reload();');
			
		}
		else
		{
			serverURL = application.getServerURL() 
		    application.showURL(serverURL + "uploads/" + _oFile.getName()+'?nodebug=true','_blank','height=600,width=800,status=yes,toolbar=no,menubar=no,location=no')
			//plugins.WebClientUtils.executeClientSideJS('location.reload();');
			
		}
	}
}

/**
* @param {plugins.file.JSFile} _oFile
*
 *
 *
 * @SuppressWarnings(unused)
 *
 *
 *
 * @properties={typeid:24,uuid:"C54F5EE6-E76A-4633-8B3E-150DA8E771E1"}
 */
function uploadCallbackFunction99(_oFile) {
    // Streaming the file to the server and call the callback method when this is done
   var monitor = plugins.file.streamFilesToServer(_oFile, Visualizar99);
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {plugins.file.JSFile} _oFile
 *
 *
 *
 * @SuppressWarnings(unused)
 * @SuppressWarnings(wrongparameters)
 *
 * @properties={typeid:24,uuid:"0BE75F4B-3E76-477A-B7B9-D012538DCDCE"}
 */
function Visualizar99(_oFile)
{
	var ext = _oFile.getContentType()
	if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
	{
		var sw = 0;
		
		//create a temporary file that will be auto-deleted by Servoy when client is exited
		var fname = plugins.file.createTempFile('_XMLEnvioTBAI','.xml')

		//write the binary data out to disk at the temporary file location
		plugins.file.writeFile(fname,fichxmlenvtbai); 
		
		var vLocalFilePath = fname.getAbsolutePath();
		//windows
        if (utils.stringMiddle(application.getOSName(), 1, 7) == "Windows") {
        	sw = 1;
            var success = application.executeProgram('rundll32', ['url.dll,FileProtocolHandler', vLocalFilePath])
        }
        //FreeBSD or Linux
        else if (utils.stringMiddle(application.getOSName(), 1, 7) == "FreeBSD" || utils.stringMiddle(application.getOSName(), 1, 5) == "Linux") {
        	sw = 1;
            success = application.executeProgram('mozilla', [vLocalFilePath])
        }
        //Mac OSX
        else if (application.getOSName().match("Mac")) {
        	sw = 1;
            success = application.executeProgram('open', [vLocalFilePath])
        }
        if(sw == 1)
        {
        	//var msg = "¿Desea borrar de la Base de Datos este documento?"
        	//var methd = 'forms.lst_AsientoContable_Lineas.BorradoPDF()'
        	//globals.CONTAshowQuestionDialog(msg,methd,'No','Si',null,null)
        }
	}
	else
	{
		if(ext == null) ext='text/plain'
			else if(ext == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || ext == 'application/vnd.ms-excel' ||
					ext == 'application/vnd.ms-excel.sheet.binary.macroenabled.12') ext = 'application/msexcel'
			else if(ext == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') ext = 'application/msword'
		if(ext == 'application/msexcel' || ext == 'application/msword')
		{
			serverURL = application.getServerURL() 
			application.showURL(serverURL + "uploads/" + _oFile.getName());
			//plugins.WebClientUtils.executeClientSideJS('location.reload();');
			 
		}
		else
		{
			serverURL = application.getServerURL() 
		    application.showURL(serverURL + "uploads/" + _oFile.getName()+'?nodebug=true','_blank','height=600,width=800,status=yes,toolbar=no,menubar=no,location=no')
			//plugins.WebClientUtils.executeClientSideJS('location.reload();');
			
		}
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"7E8422FD-6FD8-454B-8820-77C96D2A6644"}
 */
function onActionFormatoFactura1(event) {
	// TODO Auto-generated method stub	
		FormatoFactura = 1;
		FormatoFactura2 = null;		
		FormatoFactura3 = null;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"EA73B819-BA1E-4E83-9848-F5D315E5C0F8"}
 */
function onActionFormatoFactura2(event) {
	// TODO Auto-generated method stub	
		FormatoFactura2 = 1;
		FormatoFactura = null;
		FormatoFactura3 = null;
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 *
 * @properties={typeid:24,uuid:"3F700E83-C9C0-47C3-B4C2-F52412A93985"}
 */
function onActionFormatoFactura3(event) {
	// TODO Auto-generated method stub	
		FormatoFactura2 = null;
		FormatoFactura = null;
		FormatoFactura3 = 1;
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"8C8CC90D-987E-4B27-AAA6-70E569F65599"}
 */
function onActionborrardatosTicketBAI(event) {
	//if(globals.GCNombreUsuario == 'ADMINISTRADOR' || globals.GCNombreUsuario == 'JAVI')
	if(gcfechalimite_usuarios.taop_019 == '1')
	{
		var methd = 'forms.dlg_ImpresionFacturasTBAIGC.BorrarDatosTicketBAI(event)'
		globals.GCshowQuestionDialog("¿Desea borrar realmente los datos de TicketBAI?",methd,'No','Si',null,null)		
	}
	else
	{
		globals.GCshowErrorDialog("Este usuario no dispone de permisos para borrar datos TicketBAI.", null, null, null, null, null)
	}
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"E51546BE-5AD2-442B-B22F-4318D3642792"}
 */
function onActionimportardatosTicketBAI(event) {
	//if(globals.GCNombreUsuario == 'ADMINISTRADOR' || globals.GCNombreUsuario == 'JAVI')
	if(gcfechalimite_usuarios.taop_019 == '1')
	{
		globals.GCFormulario = null;
		globals.GCshowImportarDatosTBAI('Importar Datos TBAI desde .csv', 1, null, null, true, null, null, null, null, null);
	}
	else
	{
		globals.GCshowErrorDialog("Este usuario no dispone de permisos para importar datos TicketBAI.", null, null, null, null, null)
	}
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"D16637E9-1F74-4933-9A40-93AB3A32E605"}
 */
function onActioneditardatosTicketBAI(event) {
	//if(globals.GCNombreUsuario == 'ADMINISTRADOR' || globals.GCNombreUsuario == 'JAVI')
	if(gcfechalimite_usuarios.taop_019 == '1')
	{
		globals.GCFormulario = null;
		var uid = forms.FrmFacturasGC.id
		/*forms.dlgEditarDatosTBAI.foundset.loadAllRecords()
		var result = forms.dlgEditarDatosTBAI.foundset.selectRecord(uid)
		var fsCount = databaseManager.getFoundSetCount(forms.dlgEditarDatosTBAI.foundset);
		while(result==false)
		{
			if(fsCount == forms.dlgEditarDatosTBAI.foundset.getSize())return;
			forms.dlgEditarDatosTBAI.foundset.setSelectedIndex(forms.dlgEditarDatosTBAI.foundset.getSize());
			result = forms.dlgEditarDatosTBAI.foundset.selectRecord(uid);
		}*/
		var bool = forms.dlgEditarDatosTBAI.foundset.loadRecords(databaseManager.convertToDataSet([uid]))
		if(bool == true)
		{
			//start a transaction
			if(!globals.GCisEditing()) globals.GCstartEditing()
		
			
			
			globals.GCshowDialogEditarDatosTBAI('Editar Datos TicketBAI', 1, null, null, true, null, null, null, null, null);
		}	
	}	
	else
	{
		globals.GCshowErrorDialog("Este usuario no dispone de permisos para editar datos TicketBAI.", null, null, null, null, null)
	}
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 *
 *
 * @properties={typeid:24,uuid:"1751AC39-4426-4E72-B7AB-C61EBF11A07E"}
 */
function onDataChangeCRC() {
	if(crcurl)
	{
		codcrc =   scopes.netticketbaiCRC8.calculate(crcurl)
		application.showURL(crcurl+'&cr='+codcrc)		
	}
	else codcrc = null;
}

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"9B48746A-F9C3-439B-A1CC-3A842C6CB82A"}
 */
var cifempresa = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"B1B386F4-D4F6-4F83-887E-0A3CEE6391CE"}
 */
var tipopersona = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"E3BC6BF4-96BB-4BDD-89F6-CCB73B3D553F"}
 */
var pais = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"9643DB9F-90DC-406D-9CA4-71AD7171040B"}
 */
var razonsocial = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"8F49B29C-35D9-4831-AD18-88FF74B0E7AA"}
 */
var regmercantil = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"B215E440-2546-4ECC-8E20-36521DADF195"}
 */
var hoja = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"239F7D30-41C2-4F81-99CB-CFC06925B586"}
 */
var folio = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"FF348104-0D56-4172-BDAA-C07DA09B7455"}
 */
var seccion = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"6A5C7AB4-E5DA-496D-BD81-2034663D7C6D"}
 */
var tomo = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"5AD203DB-520E-417C-8234-3A26D42910C7"}
 */
var direccion = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"13E47261-220E-4796-B294-D331A3AEC92C"}
 */
var codigopostal = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"6367223C-7019-4235-A06E-610814DA9C88"}
 */
var ciudad = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"8D7B32D6-29A7-498A-A0EC-93B9FC3314B7"}
 */
var provincia = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"E82AF96B-381E-48BE-8489-D90C4F7290D1"}
 */
var telefono = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"2FF203A4-55E8-4534-B826-7873222C0C52"}
 */
var fax = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"1EF3046B-8353-438E-86BE-64CCDA9C9535"}
 */
var web = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"7C3E5A6D-4A28-4E7F-981C-F16E6A27E3E4"}
 */
var correo = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"123CC7DA-2F3D-4F13-BB54-1B87BE2D2980"}
 */
var primerafactura = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"51217EE3-5CB5-4C73-A1A0-5D109D76015E"}
 */
var ultimafactura = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"38BBB74A-DE77-44C9-90A8-6769EA2A3303"}
 */
var cifcliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"50A7DD38-D777-4C2C-987C-1042C3F9147E"}
 */
var tipopersonacliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"6AE09B8C-FA86-47C3-A927-ABDFDF02B632"}
 */
var paiscliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"11E2F732-C314-49F0-9BD4-1B8820B14A0A"}
 */
var desccliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"131BBD1B-2D9E-4FA5-9ACD-54888874A1F4"}
 */
var direccioncliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"08009C86-A9EC-4813-840C-D3A754A2CA9F"}
 */
var poblacioncliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"EDDA25F9-26A0-46AD-9747-020A6F72150A"}
 */
var provinciacliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"1889F77F-9397-4721-A12F-07533038F5D0"}
 */
var codpostalcliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"64628AE3-EB45-4B53-A4F3-4922836DD42C"}
 */
var razonsocialcliente = '';

/**
 * @type {Date}
 *
 *
 * @properties={typeid:35,uuid:"D696BDC3-2D39-4B39-A2E8-6163283C7E96",variableType:93}
 */
var fechacobro;

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"09945F10-6E7A-4527-A28E-E409413D13DD"}
 */
var cuentaabono = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"A51D34FE-3364-41F2-91EA-ECD5B99843D7"}
 */
var bic = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"A823160A-9F02-4BA2-8753-1F3E8A2FF4FB"}
 */
var uuid1 = '';

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} DEJE
 * @param {String} DSER
 * @param {Number} DNUP
 * @param {Number} HEJE
 * @param {String} HSER
 * @param {Number} HNUP
 * @param {Number} DCLI
 * @param {Number} HCLI
 *
 *
 * @properties={typeid:24,uuid:"0601FCE0-E930-4FEF-AEE0-CBCD83EABE0D"}
 */
function datosempresa(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)
{
	var query = "SELECT ParametrosAplicacion.NºEmpresa,ParametrosAplicacion.Propiedad,"+
    "ParametrosAplicacion.Empresa,ParametrosAplicacion.CodPostal,"+
    "ParametrosAplicacion.Direccion,ParametrosAplicacion.Poblacion,"+
    "ParametrosAplicacion.Provincia,ParametrosAplicacion.CIF,"+
    "ParametrosAplicacion.Telefono,ParametrosAplicacion.Fax,"+
    "ParametrosAplicacion.Mail,ParametrosAplicacion.Web,"+
    "ParametrosAplicacion.Logo,ParametrosAplicacion.Logo2,"+
    "ParametrosAplicacion.TelAux,ParametrosAplicacion.CtaBancaria,"+
    "ParametrosAplicacion.Registro,ParametrosAplicacion.Tomo,"+
    "ParametrosAplicacion.Folio,ParametrosAplicacion.HojaRegistral,"+
    "ParametrosAplicacion.pais,"+
    "tbFacturaCabecera.ID,tbFacturaCabecera.eje_cfa,"+
    "tbFacturaCabecera.ser_cfa,tbFacturaCabecera.nup_cfa,"+
    "tbFacturaCabecera.fecha_cfa,tbFacturaCabecera.fechcobro_cfa,"+
    "tbFacturaCabecera.fechconta_cfa,tbFacturaCabecera.clie_cfa,"+
    "tbFacturaCabecera.cfpa_cfa,tbFacturaCabecera.desccfpa_cfa,"+
    "tbFacturaCabecera.repr_cfa,tbFacturaCabecera.obse_cfa,"+
    "tbFacturaCabecera.fenvio,tbFacturaCabecera.situconta,"+
    "tbFacturaCabecera.situ,tbFacturaCabecera.impbre_cfa,"+
    "tbFacturaCabecera.depp_cfa,tbFacturaCabecera.pgfi_cfa,"+
    "tbFacturaCabecera.impbie_cfa,tbFacturaCabecera.piva_cfa,"+
    "tbFacturaCabecera.cuotaiva_cfa,tbFacturaCabecera.impbie2_cfa,"+
    "tbFacturaCabecera.piva2_cfa,tbFacturaCabecera.cuotaiva2_cfa,"+
    "tbFacturaCabecera.impbie3_cfa,tbFacturaCabecera.piva3_cfa,"+
    "tbFacturaCabecera.cuotaiva3_cfa,tbFacturaCabecera.impnee_cfa,"+
    "tbFacturaCabecera.gtosfinan_cfa,tbFacturaCabecera.impgtosfinan,"+
    "tbFacturaCabecera.impre,tbFacturaCabecera.impre2,"+
    "tbFacturaCabecera.impre3,tbFacturaLinea.ID,tbFacturaLinea.eje_lfa,"+
    "tbFacturaLinea.ser_lfa,tbFacturaLinea.nup_lfa,tbFacturaLinea.nli_lfa,"+
    "tbFacturaLinea.nalb_lfa,tbFacturaLinea.lalb_lfa,"+
    "tbFacturaLinea.ref_lfa,tbFacturaLinea.concep_lfa,"+
    "tbFacturaLinea.cant1_lfa,tbFacturaLinea.prec_lfa,"+
    "tbFacturaLinea.unme_lfa,tbFacturaLinea.piva_lfa,"+
    "tbFacturaLinea.dto_lfa,tbFacturaLinea.impdto_lfa,"+
    "tbFacturaLinea.clie_lfa,tbFacturaLinea.situ_lfa,"+
    "tbFacturaLinea.precuni_lfa,tbFacturaLinea.impor_lfa,"+
    "tbFacturaLinea.importot_lfa,tbFacturaLinea.fecha_lfa,"+
    "tbFacturaLinea.nprograma_lfa,tbMaestroClientes.ID,"+
    "tbMaestroClientes.IdCliente,tbMaestroClientes.DescCliente,"+
    "tbMaestroClientes.Direccion,tbMaestroClientes.Poblacion,"+
    "tbMaestroClientes.Provincia,tbMaestroClientes.CodPostal,"+
    "tbMaestroClientes.RazonSocial,tbMaestroClientes.PersContacto,"+
    "tbMaestroClientes.EmailContacto,tbMaestroClientes.Telf1,"+
    "tbMaestroClientes.Telf2,tbMaestroClientes.Fax,"+
    "tbMaestroClientes.CIF,tbMaestroClientes.NumProveedor,"+
    "tbMaestroClientes.CuentaContable,tbMaestroClientes.IdFormaPago,"+
    "tbMaestroClientes.TipoIva,tbMaestroClientes.IdMoneda,"+
    "tbMaestroClientes.DiaPago1,tbMaestroClientes.DiaPago2,tbMaestroClientes.DiaPago3,"+
    "tbMaestroClientes.Pais,tbMaestroClientes.Observaciones,"+
    "tbMaestroClientes.CodigoBanco,tbMaestroClientes.CodigoSucursal,"+
    "tbMaestroClientes.Codigo1DC,tbMaestroClientes.CodigoCuenta,"+
    "tbMaestroArticulos.RefCliente,tbMaestroformpago.denom_fp,ParametrosAplicacion.bic "+
    "FROM tbFacturaCabecera tbFacturaCabecera LEFT JOIN dbo.tbFacturaLinea tbFacturaLinea ON "+
	 "tbFacturaCabecera.eje_cfa = tbFacturaLinea.eje_lfa "+
    "AND tbFacturaCabecera.nup_cfa = tbFacturaLinea.nup_lfa "+
    "AND tbFacturaCabecera.ser_cfa = tbFacturaLinea.ser_lfa "+
    "LEFT JOIN dbo.tbMaestroClientes tbMaestroClientes ON "+
	 "tbFacturaCabecera.clie_cfa = tbMaestroClientes.IdCliente "+
    "LEFT JOIN dbo.tbMaestroformpago tbMaestroformpago ON "+
	 "tbFacturaCabecera.cfpa_cfa = tbMaestroformpago.codig_fp "+
    "LEFT JOIN dbo.tbMaestroArticulos tbMaestroArticulos ON "+
	 "tbFacturaLinea.ref_lfa = tbMaestroArticulos.Codigo,"+
    "dbo.ParametrosAplicacion ParametrosAplicacion "+
    "WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
    " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
    "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
    "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
    "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
    " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
    "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+") "+
    "ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
    "tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,99999999)
	
				uuid1 = dataset.getValue(1,22);
				cifempresa = globals.GCQuitarCaracteresEspeciales(utils.stringTrim(utils.stringReplace(dataset.getValue(1,8),' ','')));
				tipopersona = globals.GCQuitarCaracteresEspeciales(TipoPersona(cifempresa));					
				pais = utils.stringTrim(dataset.getValue(1,21));
				razonsocial = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,3));
				regmercantil = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,17));
				hoja = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,20));
				folio = dataset.getValue(1,19);
				seccion = '';
				tomo = dataset.getValue(1,18);
				direccion = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,5));
				codigopostal = dataset.getValue(1,4);
				ciudad = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,6));
				provincia = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,7));
				telefono = dataset.getValue(1,9);
				fax = dataset.getValue(1,10);
				web = dataset.getValue(1,12);
				correo = dataset.getValue(1,11);
				primerafactura = DEJE.toString() + utils.numberFormat(DNUP,'00000') + DSER;
				ultimafactura = HEJE.toString() + utils.numberFormat(HNUP,'00000') + HSER;
				cifcliente = utils.stringTrim(utils.stringReplace(dataset.getValue(1,90),' ',''));
				tipopersonacliente = globals.GCQuitarCaracteresEspeciales(TipoPersona(cifcliente))	
				paiscliente = dataset.getValue(1,99);
				if(!paiscliente) paiscliente = 'ES';
				//var contactocliente = dataset.getValue(1,85);
				desccliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,79));
				if(!desccliente) desccliente = ' ';
				direccioncliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,80));
				if(!direccioncliente) direccioncliente = ' ';
				poblacioncliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,81));
				if(!poblacioncliente) poblacioncliente = ' ';
				provinciacliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,82));
				if(!provinciacliente) provinciacliente = ' ';
				codpostalcliente = dataset.getValue(1,83);
				if(!codpostalcliente) codpostalcliente = '00000'
				razonsocialcliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,84));
				if(!razonsocialcliente) razonsocialcliente = ' ';
				fechacobro = dataset.getValue(1,27);
				//var formapago = dataset.getValue(1,30);
				cuentaabono = dataset.getValue(1,16);
				bic = dataset.getValue(1,107);
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} CIF
 * @return {String}
 *
 *
 * @properties={typeid:24,uuid:"670A8555-76FB-44D0-BE18-9204253D7B08"}
 */
function TipoPersona(CIF)
{
	var l = utils.stringLeft(CIF,1)
	var Letr = 'NO'
	var tippers = ''
	for(var i=0;i<Letras.length;i++)
	{
		if(Letras[i] == l)
		{
			Letr = 'SI'
			break;
		}
	}					
	if(Letr == 'SI')
	{
		tippers = 'J'//Persona Juridica
	}
	else if(Letr == 'NO')
	{
		tippers = 'F'//Persona Física
	}
	return tippers
}

/**
 * @type {Array}
 *
 *
 * @properties={typeid:35,uuid:"FB6F635E-8E0A-4550-BB2B-2830913B9B82",variableType:-4}
 */
var Letras = new Array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'Ñ', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z');

/**
 * @type {Array}
 *
 *
 * @properties={typeid:35,uuid:"B0C69DF2-7EFC-4642-97DD-E9EFFC4E4124",variableType:-4}
 */
var UE = new Array('DE','AT','BE','BG','CY','HR','DK','SK','SI','EE','FI','FR','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','CZ','RO','SE');

//,'GB'

/**
* SHA-256 String encoding
*
* @param {String} string
* @return {String}
*
 * @properties={typeid:24,uuid:"8D8C1814-2524-435A-ABEF-634097F6A3EB"}
 */
function sha265(string){
   
   var  text = new Packages.java.lang.String(string);
   var md = Packages.java.security.MessageDigest.getInstance("SHA-256");
   md.update(text.getBytes("UTF-8"));
   
   /** @type {Array<byte>} */
   var bytes = md.digest();
   
   return Packages.org.apache.commons.codec.binary.Base64.encodeBase64URLSafeString(bytes);
}
