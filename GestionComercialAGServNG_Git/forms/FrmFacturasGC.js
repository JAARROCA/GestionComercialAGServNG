/**
 *
 * @type {Array}
 *
 * @properties={typeid:35,uuid:"80CB7D60-E72C-49CF-89CD-C3A2CF0D165B",variableType:-4}
 */
var Letras = new Array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'Ñ', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z');

//,'GB'

/**
 *
 * @type {Array}
 *
 * @properties={typeid:35,uuid:"1F6A955E-E43C-4804-9438-EBA267266203",variableType:-4}
 */
var UE = new Array('DE','AT','BE','BG','CY','HR','DK','SK','SI','EE','FI','FR','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','CZ','RO','SE');

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"EB6019FF-416F-4B96-8091-3377BDD4D568",variableType:-4}
 */
var SchemaVersion;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"436E2E6F-9404-4DF5-99C7-F77992F335FC",variableType:-4}
 */
var InvoiceIssuerType;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DBF069CD-D0D0-4444-8E86-810E969E471F",variableType:-4}
 */
var BatchIdentifier;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"64CDE2C8-B75D-441A-B6CA-1C88881C0352",variableType:-4}
 */
var InvoicesCount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"65CF1696-8D76-4DEF-AA68-365BBE8E1C68",variableType:-4}
 */
var TotalInvoicesAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"A2F6074C-D90B-4F1B-AB69-E40F0444E94F",variableType:-4}
 */
var TotalAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"14B0B5D5-52C8-4816-9CD2-6FC120CE2C34",variableType:-4}
 */
var TotalOutstandingAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"157CE33A-ECF6-4ABE-B7E0-2EEE0D7CF2A1",variableType:-4}
 */
var TotalExecutableAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"EE0ECD9F-7A4D-4DCF-962A-B59E74E70C32",variableType:-4}
 */
var InvoiceCurrencyCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"6F61AE73-E167-4861-9A03-3E4E9B8A3AAD",variableType:-4}
 */
var Parties;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4070EDCD-55C4-4E27-90FE-620415E743CA",variableType:-4}
 */
var SellerParty;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"839711B6-6C30-4B22-BF07-BC2EDC894DA7",variableType:-4}
 */
var TaxIdentification;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"31AE70DC-EA48-40BC-959F-9FDC701DE304",variableType:-4}
 */
var PersonTypeCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"15F4F8BC-B014-4F95-B5C2-671D858E6802",variableType:-4}
 */
var ResidenceTypeCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"776F23A6-BD96-4AA1-A617-AE80BF9043E1",variableType:-4}
 */
var TaxIdentificationNumber;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"0C4E8D1E-9CF8-49AE-8783-EF7D7C4653F1",variableType:-4}
 */
var LegalEntity;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"BB7B0A7D-0B5B-4896-9B31-BB57F0AA220E",variableType:-4}
 */
var CorporateName;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D604AD33-2D9B-426E-B849-6019BDDBEB6F",variableType:-4}
 */
var TradeName;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"A2A60217-67FD-4A9E-B99C-12672F6477BE",variableType:-4}
 */
var RegistrationData;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"B2165736-E8A6-491C-A7B2-FD31E9C34241",variableType:-4}
 */
var Book;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"36E1AB0C-61F5-450E-B5B9-369C43BD0272",variableType:-4}
 */
var RegisterOfCompaniesLocation;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1B7C2BFE-1527-40BA-8391-55028A2962FB",variableType:-4}
 */
var Sheet;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"120CF83D-D26A-4D0F-9160-E8FF6D5651CE",variableType:-4}
 */
var Folio;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"FE0EA10C-C7C0-4853-A6C1-9ECD9A5B154D",variableType:-4}
 */
var Section;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1D44280B-BFAC-481A-AE27-63753DB44F8E",variableType:-4}
 */
var Volume;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"8EC7A4D4-405D-4586-8C77-2EEC401ADAE2",variableType:-4}
 */
var AdditionalRegistrationData;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"6DB7BDA7-0F99-47FC-BB61-FF6357876E86",variableType:-4}
 */
var AddressInSpain;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"120F5AA9-3670-49AD-B992-983EBFA78338",variableType:-4}
 */
var Address;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"6215A423-00B1-4A27-8437-A7F3379C10F1",variableType:-4}
 */
var PostCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DDB579E5-E2E1-46EA-9799-7BD58B1FE1F0",variableType:-4}
 */
var Town;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2C9A17DB-7EB5-451D-99C6-A1AE0475C5A8",variableType:-4}
 */
var Province;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"64DED123-DFC7-485B-894D-E3D49151FB3B",variableType:-4}
 */
var CountryCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"879CC1AA-C04F-4962-A9EB-F046FC7B5AC9",variableType:-4}
 */
var ContactDetails;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"BAAFD759-CB1D-4572-BC1F-AFDC7EFF3ED2",variableType:-4}
 */
var Telephone;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1B29DF58-5486-4E41-8E1B-672A485F65D5",variableType:-4}
 */
var TeleFax;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DF8A7D2D-B5D5-47E9-83A1-FB1FB1C9A119",variableType:-4}
 */
var WebAddress;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5E35853A-4217-46F7-9A3A-86DB2FD1720B",variableType:-4}
 */
var ElectronicMail;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"B395F38D-565C-4864-AF6F-9D452C44FE1E",variableType:-4}
 */
var BuyerParty;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"280D7EEE-26F4-4572-96CC-3543B8025B37",variableType:-4}
 */
var AdministrativeCentres;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D127CC2B-6771-4484-A353-281B834A30AC",variableType:-4}
 */
var AdministrativeCentre;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DB33B561-EC0F-4FA5-8CB6-8F3C328149EF",variableType:-4}
 */
var Name;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"065B5C76-354C-4B98-A1DD-6EF4368BC592",variableType:-4}
 */
var OverseasAddress;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4791812C-92FA-4830-9878-E536B5F5B42E",variableType:-4}
 */
var PostCodeAndTown;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"181EFB70-F3CB-44A1-B598-A473FE90D0BA",variableType:-4}
 */
var Individual;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5500F9F8-DAC1-4274-8610-1EFFBAB11936",variableType:-4}
 */
var FirstSurname;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4F0545F4-4DD8-492A-8DF6-AC6490F66697",variableType:-4}
 */
var Invoices;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"33D8752D-1216-4C68-A102-B957E4CC8DB3",variableType:-4}
 */
var PaymentDetails;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C9908737-AD41-42A8-BB34-5820003137CD",variableType:-4}
 */
var Installment;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1D54744C-A60B-4DB7-BB7C-804D71BE9E44",variableType:-4}
 */
var InstallmentDueDate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C85E97EE-2B27-409C-9C66-0142FEFD6A3A",variableType:-4}
 */
var InstallmentAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"723FA34F-A909-4BD4-BACB-5783BD2D5CEE",variableType:-4}
 */
var PaymentMeans;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C2DB1F6D-2530-4C9C-BBFB-C6CBB15C2E32",variableType:-4}
 */
var AccountToBeCredited;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2B3E63E5-0C91-4E8E-B64C-9A64CC8C9F9E",variableType:-4}
 */
var IBAN;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"72101CF2-190E-4B01-8177-F24FFBDA29DF",variableType:-4}
 */
var BIC;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D0121469-5BAE-4C23-8977-C89601D9377F",variableType:-4}
 */
var Invoice;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5B32E040-6251-42B2-8342-BBAF18B2349F",variableType:-4}
 */
var InvoiceHeader;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C0D6AE51-7AFF-4397-ADE9-2A71912E5D4D",variableType:-4}
 */
var InvoiceNumber;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"9F6AE6F0-8D33-42AD-A191-398EE0A96B09",variableType:-4}
 */
var InvoiceSeriesCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"9C375118-F1D8-45B8-8EE2-A34D3491F20E",variableType:-4}
 */
var InvoiceDocumentType;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"6F67B7F4-1020-460F-A8FB-A77F7056A818",variableType:-4}
 */
var InvoiceClass;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"7459B983-D1D8-439C-BAFB-19DF8F09D520",variableType:-4}
 */
var InvoiceIssueData;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"302CE1B6-CAF8-48F3-8559-DD0E919ECC82",variableType:-4}
 */
var IssueDate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"FD30E70D-D2DE-4F49-A041-8859D9EE2C78",variableType:-4}
 */
var OperationDate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"0ABA874F-9645-410C-A6B5-14B5177D5F08",variableType:-4}
 */
var PlaceOfIssue;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C17EED6B-9516-499C-80F9-A170BC442D2C",variableType:-4}
 */
var PlaceOfIssueDescription;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"61F4F698-7B14-4EC0-B928-103512A8B16C",variableType:-4}
 */
var TaxCurrencyCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"18FAD0BB-9830-4DDF-9D0C-B2644FA3DE4A",variableType:-4}
 */
var LanguageName;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D5A9FF4A-7239-4FC9-9876-19AC737EB2A2",variableType:-4}
 */
var TaxesOutputs;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"CEF1AEC0-2876-48AE-883A-128036CE1694",variableType:-4}
 */
var Tax;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"BC84FB6E-46D2-412C-9DF7-7FB89D2C737C",variableType:-4}
 */
var TaxTypeCode;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"52141F61-5AFB-4EA3-B97D-E69E991E5D37",variableType:-4}
 */
var TaxRate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"78EEC489-D49E-4145-88D6-349DD93D5322",variableType:-4}
 */
var TaxableBase;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4929FE37-4DDC-4F1D-A510-D14947859C29",variableType:-4}
 */
var TaxAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"71CCBD69-041F-4206-9AD1-B56D1D11504F",variableType:-4}
 */
var EquivalenceSurcharge;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"44BF1092-0696-449D-8ADF-C2951CDB8C2F",variableType:-4}
 */
var EquivalenceSurchargeAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"7029A785-82ED-468C-825D-7DA23C7590FC",variableType:-4}
 */
var InvoiceTotals;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"A6ED6B42-098D-4AAB-B217-13A5BFE238AA",variableType:-4}
 */
var TotalGrossAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"678ADC45-0DB6-4F3C-976E-C5923A37129A",variableType:-4}
 */
var TotalGeneralDiscounts;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5646561D-6512-4713-9692-1A9410A66D12",variableType:-4}
 */
var TotalGeneralSurcharges;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5CCD76F2-4F23-48C4-AC8C-41F403E5891C",variableType:-4}
 */
var TotalGrossAmountBeforeTaxes;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"C0EB3E83-17EC-4E8B-A90F-063EE8117CA9",variableType:-4}
 */
var TotalTaxOutputs;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"535318FE-A85E-41AF-9629-44E2DC2A4E08",variableType:-4}
 */
var TotalTaxesWithheld;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"808CCE31-6109-4C4C-95C4-FD350CF2AF4D",variableType:-4}
 */
var InvoiceTotal;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DDE946EF-B579-4F63-8CF0-E7C8AFC4F0D7",variableType:-4}
 */
var InvoiceLine;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"9EA51616-7A20-45BB-B227-FD766B422E82",variableType:-4}
 */
var ItemDescription;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1E78761C-FAFA-4CBA-8C72-E1B4F9DAE3AF",variableType:-4}
 */
var Quantity;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"F06BD6E2-B045-497F-9E49-1F12BAE19B4A",variableType:-4}
 */
var UnitOfMeasure;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"2F896AF7-B422-4D40-8A7D-63DD24CCED88",variableType:-4}
 */
var UnitPriceWithoutTax;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4F607A3D-8A87-4678-9DA9-085B1339FF3C",variableType:-4}
 */
var TotalCost;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"BE0ADDDD-8959-4FEB-82E5-6B53716899A0",variableType:-4}
 */
var DiscountsAndRebates;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"4E210A05-2DBE-4703-A4D8-57B06D23D60C",variableType:-4}
 */
var Discount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"1A12B525-1FB5-4FF9-B1C3-135B9FEF8E26",variableType:-4}
 */
var DiscountReason;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"DACC06F4-48BF-4795-9C84-777C8EEC973D",variableType:-4}
 */
var DiscountRate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"8FD26EFD-ED59-4875-9B39-4256B973C30E",variableType:-4}
 */
var DiscountAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"3C7A383B-0FFF-4015-9147-01B61DF0DB04",variableType:-4}
 */
var Charges;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"5172B7CB-34BF-4D61-9028-B2B5C141A424",variableType:-4}
 */
var Charge;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"D4C8E9B5-3F67-42C5-87A1-7EA508FDD886",variableType:-4}
 */
var ChargeReason;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"E4A851CE-1355-46E2-A2FF-85DF905880F6",variableType:-4}
 */
var ChargeRate;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"E4771862-46B2-49C9-AB35-06C3D5CF5117",variableType:-4}
 */
var ChargeAmount;

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"91181736-569B-48B4-8A01-05A67C60EFC0",variableType:-4}
 */
var GrossAmount;

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"D8BF76BF-43BB-43C2-8C1C-C18F58C38CC6"}
 */
var newxml = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"6284A1B4-B98D-4C09-86AC-D9D2F35E35A0"}
 */
var htm = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"2C440844-5E83-44F4-B055-BBB8FAC29EE8"}
 */
var serverURL = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"0EE6BB04-116A-4972-9A56-0C1A968BC3DB"}
 */
var nom = '';

/**
 * @type {XML}
 *
 *
 * @properties={typeid:35,uuid:"65967AE3-8148-43C9-96C1-F55F68B28FC5",variableType:-4}
 */
var Document;

/**
 * @type {XML}
 *
 * @properties={typeid:35,uuid:"DFBC564D-53E9-44E1-A9B4-A82C14045F48",variableType:-4}
 */
var FileHeader;

/**
 * Callback method when form is (re)loaded.
 *
 * @param {JSEvent} event the event that triggered the action
 * 
 * @properties={typeid:24,uuid:"9E982250-18E0-4566-816E-9D4D0DF0A7EF"}
 */
function onLoad(event) {
	plugins.window.createShortcut('control F10', handle_shortCut);
	plugins.window.createShortcut('control E', handle_shortCut);
	plugins.window.createShortcut('control shift I', handle_shortCut);
	plugins.window.createShortcut('control shift T', handle_shortCut);
	
	//plugins.window.createShortcut('control alt F12', handle_shortCut);
	if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT) globals.LoadingGC()
}

/**
 * @properties={typeid:24,uuid:"170642C8-8C03-4D94-B49E-49DC21F888C7"}
 * @SuppressWarnings(deprecated)
 */
function onRecordSelect()
{	
	//setup the record status
	globals.GCsetupRecordStatus();
	
	//set the global curID_company to the current company_id
	globals.GCcurID_Factura = id;
	if(globals.GCRegistroNuevo == 1)
	{
		if(globals.GCisEditing())
		{
			btn_cancel()
			doEdit()
		}
	}
	//databaseManager.acquireLock(foundset, 0);
	onDataChangefechconta()
	situcontacolor()
	situcobrocolor()
	situFraEmail()
	ocultarcampos()
	//notasclientes()
	if(!mac /*&& cqr*/&& fechaenviofichero)
	{
		elements.txtenviotbai.text = 'ANULADA';
		//elements.txtenviotbai.fgcolor = '#ff8080';
	}
	else 
	{
		elements.txtenviotbai.text = 'ENVÍO';
		//elements.txtenviotbai.fgcolor = '#000000';
	}
	//elements.tabs_mainPanelfacturas.tabIndex = 0;
	if(GCtbfacturacabecera_to_tbfacturalinea)
	{
		if(GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0)
		{
			/*var e = forms.FrmFacturasGC.eje_cfa;
			var s = forms.FrmFacturasGC.ser_cfa;
			var n = forms.FrmFacturasGC.nup_cfa;	
			var query = "select ID from tbFacturaLinea "+
			"where eje_lfa ='"+e+"' and nup_lfa = "+n+" and "+
			"ser_lfa = '"+s+"' order by nli_lfa asc";
			var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 99999999)			
			var Linea = 0;
			var rows = dataset.getMaxRowIndex()
			for(var i=1;i<=rows;i++)
			{
				var uuid = dataset.getValue(i,1)
				
				forms.lst_Factura_LineasGC.foundset.loadAllRecords()
				var result = forms.lst_Factura_LineasGC.foundset.selectRecord(uuid)
				var fsCount = databaseManager.getFoundSetCount(forms.lst_Factura_LineasGC.foundset);
				while(result==false)
				{
					if(fsCount == forms.lst_Factura_LineasGC.foundset.getSize())
					{
						return;
					}
				forms.lst_Factura_LineasGC.foundset.setSelectedIndex(forms.lst_Factura_LineasGC.foundset.getSize());
				result = forms.lst_Factura_LineasGC.foundset.selectRecord(uuid);
				}
				Linea += 1  
				if(forms.lst_Factura_LineasGC.foundset.nli_lfa != Linea)
				{
					forms.lst_Factura_LineasGC.foundset.nli_lfa = Linea
					databaseManager.saveData(forms.lst_Factura_LineasGC.foundset)
				}
				*/
				/*var vSet = databaseManager.getFoundSet(globals.GCconex, 'tbfacturalinea')  
		  
				//load record by ID in foundset  
				vSet.loadRecords(databaseManager.convertToDataSet([uuid]))  
				var record = forms.lst_Factura_LineasGC.foundset.getSelectedRecord();
				Linea += 1  
				if(record && record.nli_lfa != Linea)
				{
					record.nli_lfa = Linea
					databaseManager.saveData(record)
				}*/
			//}
			//forms.lst_Factura_LineasGC.foundset.setSelectedIndex(1)
			forms.lst_FacturaLineasGCNG.elements.table_FacturaLineas.myFoundset.foundset.setSelectedIndex(1)
			forms.lst_FacturaLineasGCNG.elements.table_FacturaLineas.myFoundset.foundset.sort('nli_lfa asc')
		}
	}	
}

/**
 * 
 * @param {JSEvent} event the event that triggered the action
 * 
 * @properties={typeid:24,uuid:"F4A3F067-3A08-4BB6-8976-FC663973EEEA"}
 * @SuppressWarnings(deprecated)
 */
function btn_save(event)
{
	var query = 'select savefactura from [usuarios] where [cod_us] ='+ globals.GClogin_usuario
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	var save = dataset.getValue(1, 1)
	if(save != '1')
	{
		scopes.svyCustomDialogs.showErrorDialog('Error','Este usuario no dispone de permiso para grabar Facturas.','Aceptar')
		//globals.GCshowErrorDialog('Este usuario no dispone de permiso para grabar Facturas.',null,'Aceptar',null,null,null)
	}
	else
	{
		var editRecs = new Array()
		editRecs = databaseManager.getEditedRecords(foundset)
		if(situconta == 'C' && forms.FrmFacturasGC.elements.situconta.readOnly == true)
		{
			var btn = scopes.svyCustomDialogs.showErrorDialog('Error','Factura ya contabilizada. No se puede modificar.','Aceptar')
			if(btn == 'Aceptar') forms.FrmFacturasGC.btn_cancel();
			
			//var methd = 'forms.FrmFacturasGC.btn_cancel()'
			//globals.GCshowErrorDialog('Factura ya contabilizada. No se puede modificar.',methd,'Aceptar',null,null,null)
		}
		else if(!fecha_cfa)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','Falta introducir la fecha de la factura.','Aceptar')
			//globals.GCshowErrorDialog('Falta introducir la fecha de la factura.',null,'Aceptar',null,null,null)
		}
		else if(!clie_cfa)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','Falta introducir el cliente de la factura.','Aceptar')
			//globals.GCshowErrorDialog('Falta introducir el cliente de la factura.',null,'Aceptar',null,null,null)
		}
		else if(!GCtbfacturacabecera_to_tbmaestroclientes)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','Falta introducir el cliente de la factura.','Aceptar')
			//globals.GCshowErrorDialog('Falta introducir el cliente de la factura.',null,'Aceptar',null,null,null)
		}
		else if(!GCtbfacturacabecera_to_tbmaestroclientes.id)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','Falta introducir el cliente de la factura.','Aceptar')
			//globals.GCshowErrorDialog('Falta introducir el cliente de la factura.',null,'Aceptar',null,null,null)
		}
		else if(!GCtbfacturacabecera_to_tbmaestroclientes.cif)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','El cliente de la factura no dispone de CIF.','Aceptar')
			//globals.GCshowErrorDialog('El cliente de la factura no dispone de CIF.',null,'Aceptar',null,null,null)
		}
		else if(fechcobro_cfa != null && fechcobro_cfa != '' && fechcobro_cfa < fecha_cfa)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','La fecha de cobro no puede ser inferior a la fecha de factura.','Aceptar')
			//globals.GCshowErrorDialog('La fecha de cobro no puede ser inferior a la fecha de factura.',null,'Aceptar',null,null,null)
		}	
		else if((ser_cfa == 'R' && !fraoriginal) || (ser_cfa == 'R' && !causarect))
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','En las facturas Rectificativas es obligatorio indicar el Nº de Factura Original y la Causa de la Rectificación.','Aceptar')
			//globals.GCshowErrorDialog('En las facturas Rectificativas es obligatorio indicar el Nº de Factura Original y la Causa de la Rectificación.',null,'Aceptar',null,null,null)
		}
		//else if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbai && mac && fechaenviofichero && editRecs.length > 0)
		else if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbai && mac && fechaenviofichero && editRecs.length > 0 &&
		forms.FrmFacturasGC.elements.situconta.readOnly == true)
		{
			var msg = 'Esta factura está marcado como enviada a TicketBAI.<br> No se puede modificar.';
			scopes.svyCustomDialogs.showErrorDialog('Error',msg,'Aceptar')
			if(btn == 'Aceptar') forms.FrmFacturasGC.btn_cancel();
			//methd = 'forms.FrmFacturasGC.btn_cancel()'
			//globals.GCshowErrorDialog('Esta factura está marcado como enviada a TicketBAI.\n No se puede modificar.',methd,'Aceptar',null,null,null)
		}		
		else
		{
			if(globals.GCRegistroNuevo == 1)
			{
				
					if(ser_cfa == null || ser_cfa == '')
					{
						query = 'select [NumFactura] from [ParametrosAplicacion]'
						dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
						nup_cfa = dataset.getValue(1, 1) + 1
					}
					else if(ser_cfa == 'R')
					{
						query = 'select [NumFacturaRect] from [ParametrosAplicacion]'
						dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
						nup_cfa = dataset.getValue(1, 1) + 1		
					}
					else if(ser_cfa == 'C')
					{
						query = 'select [NumFacturaCargo] from [ParametrosAplicacion]'
						dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
						nup_cfa = dataset.getValue(1, 1) + 1
					}
					else if(ser_cfa == 'A')
					{
						query = 'select [NumFacturaAbono] from [ParametrosAplicacion]'
						dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
						nup_cfa = dataset.getValue(1, 1) + 1		
					}
				
			}
			for (var x=0;x<editRecs.length;x++)
			{
				if(editRecs[x]['situconta'] == 'C' && elements.situconta.readOnly == true)
				{
					var vSet = databaseManager.getFoundSet(globals.GCconex, 'tbfacturacabecera')  
					  
					vSet.loadRecords(databaseManager.convertToDataSet([editRecs[x]['id']])) 
					var rec = vSet.getSelectedRecord()
					if(rec)
					{
						var ds = rec.getChangedData()
						for( var i = 1 ; i <= dataset.getMaxRowIndex() ; i++ )
						{
							var col = ds.getValue(i,1);
							rec[col] = ds.getValue(i,2);
							databaseManager.saveData(rec)
						}
					}
				}
				
			}
			/*var Agno = new Date()
			Agno= Agno.getFullYear().toString()
			Agno = Agno.substr(2,2)*/
			if(cfpa_cfa == '')  cfpa_cfa = null
			if(GCtbfacturacabecera_to_tbfacturalinea)
			{
				var rows = GCtbfacturacabecera_to_tbfacturalinea.getSize();
				for(i=1;i<=rows;i++)
				{
					var record = GCtbfacturacabecera_to_tbfacturalinea.getRecord(i);
					if(record.clie_lfa != clie_cfa)
					{
						record.clie_lfa = clie_cfa;		
						databaseManager.saveData(record)
					}				
				}	
				if(rows > 0)
				{
					Generacion_Efecto_Factura()
				}
			}
			if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes)
			{
				if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.comisionista && GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes)
				{
					Generacion_FacturaComision()
				}
			}
			
			_super.btn_save()
			var Agno = new Date()
			Agno= Agno.getFullYear()
			var a = new String()
			a = Agno.toString()
			a= a.substr(2,2)
			
			if(forms.FrmFacturasGC.ser_cfa == '')
				{
					query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa]  = '' order by [nup_cfa] desc"			
					dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
					var n = dataset.getValue(1,1)
					if(n == null) n = 0;
					
					gcparametrosaplicacion_to_parametrosaplicacion.numfactura = n;
					/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
					var result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
					var fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
					while(result==false)
					{
						if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
						{
						return;
						}
					forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
					}
					
					forms.dlg_ParametroAplicacionGC.numfactura = n;*/
					databaseManager.saveData()
				}
				else if(forms.FrmFacturasGC.ser_cfa == 'R')
				{
					query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'R' order by [nup_cfa] desc"			
					dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
					n = dataset.getValue(1,1)
					if(n == null) n = 0;
					gcparametrosaplicacion_to_parametrosaplicacion.numfacturarect = n;
					/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
					fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
					while(result==false)
					{
						if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
						{
						return;
						}
					forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
					}
					
					forms.dlg_ParametroAplicacionGC.numfacturarect = n;*/
					databaseManager.saveData()
					
					//var mthd = 'forms.FrmFacturasGC.AgregarlineasFacturarectificada(event)'
					//globals.GCshowQuestionDialog("¿Desea añadir automaticamente las líneas de la factura indicada a rectificar("+fraoriginal+")?",mthd,'No','Si',null,null)
					var custom_dlg = scopes.svyCustomDialogs.showQuestionDialog(globals.GCNombreEmpresa,"¿Desea añadir automaticamente las líneas de la factura indicada a rectificar("+fraoriginal+")?",'Si','No')
					if(custom_dlg == "Si") 
					{
						globals.core_dlg_buttonPressed = 'Si';
						AgregarlineasFacturarectificada(event)
					}
				}
				else if(forms.FrmFacturasGC.ser_cfa == 'C')
				{
					query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'C' order by [nup_cfa] desc"			
					dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
					n = dataset.getValue(1,1)
					if(n == null) n = 0;
					gcparametrosaplicacion_to_parametrosaplicacion.numfacturacargo = n;
					/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
					fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
					while(result==false)
					{
						if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
						{
						return;
						}
					forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
					}
					
					forms.dlg_ParametroAplicacionGC.numfacturacargo = n;*/
					databaseManager.saveData()
				}
				else if(forms.FrmFacturasGC.ser_cfa == 'A')
				{
					query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'A' order by [nup_cfa] desc"			
					dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
					n = dataset.getValue(1,1)
					if(n == null) n = 0;
					gcparametrosaplicacion_to_parametrosaplicacion.numfacturaabono = n;
					/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
					fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
					while(result==false)
					{
						if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
						{
						return;
						}
					forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
					result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
					}
					
					forms.dlg_ParametroAplicacionGC.numfacturaabono = n;*/
					databaseManager.saveData()
				}
			
			globals.GCRegistroNuevo = null	
				
			elements.situconta.bgcolor = '#f0f0f0'
			elements.situconta.readOnly = true	
			elements.situconta.visible = false
			elements.lblsituconta.visible = true
			elements.emailenviada.bgcolor = '#f0f0f0'
			elements.emailenviada.readOnly = true		
			situcontacolor()
			situcobrocolor()
			situFraEmail()
			ocultarcampos()
			//notasclientes()
			onDataChangefechconta()
			elements.ser_cfa.bgcolor = '#f0f0f0'
			elements.ser_cfa.readOnly= true
			elements.BtnCliente.visible = false
			elements.BtnAddCliente.visible = false
			elements.btn_googlemaps.visible = true
			elements.BtnFormaPago.visible = false
			elements.BtnObservacion.visible = false
			elements.BtnAñadirObs.visible = false
			elements.BtnAñadirFP.visible = false
			elements.BtnTransportes.visible = false
			elements.btn_DatosRegistrales.visible = true
			elements.btn_EnvMail.visible = true
			elements.btn_sendEmail.visible = true
			elements.btn_contabilizarfacturas.visible = true
			elements.btn_actcobros.visible = true
			elements.btn_Cliente.visible = true
			elements.btn_DirFacturacion.visible = true
			elements.btnUltimaFactura.visible = true
			forms.lst_top5FacturasGC.elements.btn_topventas.enabled = true
			elements.eje_cfa.visible = false
			elements.lbleje_cfa.visible = true
			elements.ser_cfa.visible = false
			elements.lblser_cfa.visible = true
			elements.nup_cfa.visible = false
			elements.lblnup_cfa.visible = true
			elements.fld_fecha_cfa.visible = false
			elements.lblfecha_cfa.visible = true
			elements.fld_clie_cfa.visible = false
			elements.lbl_clie_cfa.visible = true
			elements.fld_fechacobro_cfa.visible = false
			elements.lblfechcobro_cfa.visible = true	
			elements.logofacturae.visible = true;
			
			databaseManager.refreshRecordFromDatabase(foundset,-1)
				
			if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT)
			{
				/** @type Number*/
				/*var idx = elements.tabs_mainPanel.tabIndex;
				var frm =  elements.tabs_mainPanel.getTabFormNameAt(idx)
				forms[frm].controller.enabled = true
				forms[frm].controller.readOnly = false*/
			}
			
			
		}
	}
}

/**
 * @properties={typeid:24,uuid:"45531151-B2B2-47D6-9677-D4D2C65EFD2E"}
 */
function doEditser_cfa()
{
	ser_cfa ='';	
	elements.ser_cfa.bgcolor = '#feffe4'
	elements.ser_cfa.readOnly= false
}

/**
 * @properties={typeid:24,uuid:"49E1B6AC-FE02-4BF9-ABA6-097E7205E298"}
 */
function doEdit()
{
	_super.doEdit()
	//hide the non combobox fields
	/*elements.fld_companyCategory.visible = false
	elements.fld_companyIndustry.visible = false
	elements.fld_companyType.visible = false
	elements.fld_accountmanager.visible = false
	elements.fld_status.visible = false

	//show the comboboxes
	elements.fld_companyCategoryc.visible = true
	elements.fld_companyIndustryc.visible = true
	elements.fld_companyTypec.visible = true
	elements.fld_accountmanagerc.visible = true
	elements.fld_statusc.visible = true

	//hide the buttons that will mess things up
	elements.btn_openURL.visible = false
	elements.btn_sendEmail.visible = false

	//disable the navpanel at the bottom
	elements.tabs_mainPanel.enabled = false*/
	
	//for web client - disable the form showing in the tabpanel at the bottom
	elements.BtnCliente.visible = true
	elements.BtnAddCliente.visible = true
	elements.btn_googlemaps.visible = false
	elements.BtnFormaPago.visible = true
	elements.BtnObservacion.visible = true
	elements.BtnAñadirObs.visible = true
	elements.BtnAñadirFP.visible = true
	elements.BtnTransportes.visible = true
	elements.btn_DatosRegistrales.visible = false
	elements.btn_EnvMail.visible = false
	elements.btn_sendEmail.enabled = false
	elements.btn_contabilizarfacturas.visible = false
	elements.btn_actcobros.visible = false
	elements.btn_Cliente.visible = false
	elements.btn_DirFacturacion.visible = false
	elements.btnUltimaFactura.visible = false
	elements.BtnNotasCliente.visible = false
	forms.lst_top5FacturasGC.elements.btn_topventas.enabled = false
	elements.fld_fecha_cfa.visible = true
	elements.lblfecha_cfa.visible = false
	elements.fld_clie_cfa.visible = true
	elements.lbl_clie_cfa.visible = false
	elements.fld_fechacobro_cfa.visible = true
	elements.lblfechcobro_cfa.visible = false
	elements.situconta.visible = true
	elements.lblsituconta.visible = false
	elements.fld_fecha_cfa.bgcolor = '#FFFF00';
	elements.fld_clie_cfa.bgcolor = '#FFFF00';
	elements.fld_fraoriginal.bgcolor = '#FFFF00';
	elements.fld_causarect.bgcolor = '#FFFF00';
	elements.logofacturae.visible = false;
	
	elements.fld_fecha_cfa.requestFocus()
	
	if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT)
	{
		/** @type Number*/
		/*var idx = elements.tabs_mainPanel.tabIndex;
		var frm =  elements.tabs_mainPanel.getTabFormNameAt(idx)
		forms[frm].controller.enabled = false
		forms[frm].controller.readOnly = true*/
	}
	
	
}

/**
 * @properties={typeid:24,uuid:"6712AF1D-6A07-45DE-8685-33BA88715789"}
 */
function btn_cancel()
{
	globals.GCRegistroNuevo = null	
	_super.btn_cancel()
	elements.situconta.bgcolor = '#f0f0f0'
	elements.situconta.readOnly = true		
	elements.emailenviada.bgcolor = '#f0f0f0'
	elements.emailenviada.readOnly = true
	elements.situconta.visible = false
	elements.lblsituconta.visible = true
	situcontacolor()
	situcobrocolor()
	ocultarcampos()
	//notasclientes()
	onDataChangefechconta()
	elements.ser_cfa.bgcolor = '#f0f0f0'
	elements.ser_cfa.readOnly= true
	elements.BtnFormaPago.visible = false
	elements.BtnObservacion.visible = false
	elements.BtnAñadirObs.visible = false
	elements.BtnAñadirFP.visible = false
	elements.BtnTransportes.visible = false
	elements.BtnCliente.visible = false
	elements.BtnAddCliente.visible = false
	elements.btn_googlemaps.visible = true
	elements.btn_DatosRegistrales.visible = true
	elements.btn_EnvMail.visible = true
	elements.btn_sendEmail.enabled = true
	elements.btn_contabilizarfacturas.visible = true
	elements.btn_actcobros.visible = true
	elements.btn_Cliente.visible = true
	elements.btn_DirFacturacion.visible = true
	elements.btnUltimaFactura.visible = true
	forms.lst_top5FacturasGC.elements.btn_topventas.enabled = true
	elements.eje_cfa.visible = false
	elements.lbleje_cfa.visible = true
	elements.ser_cfa.visible = false
	elements.lblser_cfa.visible = true
	elements.nup_cfa.visible = false
	elements.lblnup_cfa.visible = true
	elements.eje_cfa.visible = false
	elements.lbleje_cfa.visible = true
	elements.ser_cfa.visible = false
	elements.lblser_cfa.visible = true
	elements.lblnup_cfa.visible = true
	elements.fld_fecha_cfa.visible = false
	elements.lblfecha_cfa.visible = true
	elements.fld_clie_cfa.visible = false
	elements.lbl_clie_cfa.visible = true
	elements.fld_fechacobro_cfa.visible = false
	elements.lblfechcobro_cfa.visible = true
	elements.logofacturae.visible = true;
	
	if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT)
	{
		/** @type Number*/
		/*var idx = elements.tabs_mainPanel.tabIndex;
		var frm =  elements.tabs_mainPanel.getTabFormNameAt(idx)
		forms[frm].controller.enabled = true
		forms[frm].controller.readOnly = false*/		
	}
	
	
}

/**
 * 
 * @param {Boolean} firstShow
 * @param {JSEvent} event
 * @properties={typeid:24,uuid:"1FFA7022-A988-4669-8C5D-EF6AFE3B0A10"}
 * @AllowToRunInFind
 */
function onShow(firstShow,event)
{
	/*var win = application.getWindow('Conta')
	//setup the record status
	if(win != null)
	{
		win.destroy();
	}*/
	
	//make read only
	if(!globals.GClogin_usuario) globals.btn_SalirGC(event)
	btn_cancel();
	onLoad(event)
	//globals.reallyLoadAllRecordsGC(foundset)
	/*
	var query = 'select empresasii from ParametrosAplicacion where NºEmpresa = 1'
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	var empresasii = dataset.getValue(1, 1);
	*/
	var empresatbai = gcparametrosaplicacion_to_parametrosaplicacion.ticketbai;
	var empresasii = gcparametrosaplicacion_to_parametrosaplicacion.empresasii;
	globals.GCnav_search = null
	//forms.frm_nav_buttons_facturasGC.btn_showAll();
	btn_UltimaFactura(event)
	//foundset.loadAllRecords()
	controller.readOnly = true
	//if(controller.getSelectedIndex() != 1) controller.setSelectedIndex(1)
	elements.tabs_mainPanelfacturas.tabIndex = 0;
	if(empresasii){
		elements.logoSII.visible = true;
		elements.logoSII2.visible = true;
		elements.lbl_fraexiva.visible = true;
		elements.lbl_tipofacturasii.visible = true;
		elements.lbl_tipooperacionsii.visible = true;
		elements.fld_sujetaexentaivasii.visible = true;
		elements.fld_tipofacturasii.visible = true;
		elements.fld_tipooperacionsii.visible = true;
		elements.logofacturae.visible = true;
	}
	else{
		elements.logoSII.visible = false;
		elements.logoSII2.visible = false;
		elements.lbl_fraexiva.visible = false;
		elements.lbl_tipofacturasii.visible = false;
		elements.lbl_tipooperacionsii.visible = false;
		elements.fld_sujetaexentaivasii.visible = false;
		elements.fld_tipofacturasii.visible = false;
		elements.fld_tipooperacionsii.visible = false;
		elements.logofacturae.visible = false;
	}
	if(empresatbai){
		elements.logotbai.visible = true;
		elements.lbl_enviadatbai.visible = true;
		elements.txtenviotbai.visible = true;
		if(gcparametrosaplicacion_to_parametrosaplicacion.osatu){
			elements.txtenvioosatu.visible = true;
			elements.lbl_enviadatbaiosatu.visible = true;
			elements.lbl_enviadatbaiosatu.enabled = true;
		}
		else{
			elements.txtenvioosatu.visible = false;
			elements.lbl_enviadatbaiosatu.visible = false;
			elements.lbl_enviadatbaiosatu.enabled = false;
		}
	}
	else{
		elements.logotbai.visible = false;
		elements.lbl_enviadatbai.visible = false;
		elements.txtenviotbai.visible = false;
		elements.txtenvioosatu.visible = false;
		elements.lbl_enviadatbaiosatu.visible = false;
		elements.lbl_enviadatbaiosatu.enabled = false;
	}
	situFraEmail()
	//hide save/cancel btsn
	elements.btn_save.visible = false
	elements.btn_cancel.visible = false
	elements.BtnCliente.visible = false
	elements.BtnAddCliente.visible = false
	elements.BtnFormaPago.visible = false
	elements.BtnObservacion.visible = false
	elements.BtnAñadirObs.visible = false
	elements.BtnAñadirFP.visible = false
	elements.BtnTransportes.visible = false
	elements.btn_DatosRegistrales.enabled = true
	elements.btn_EnvMail.enabled = true
	elements.btn_contabilizarfacturas.enabled = true
	elements.btn_actcobros.enabled = true
	elements.btn_Cliente.enabled = true
	elements.btn_DirFacturacion.enabled = true
	elements.btnUltimaFactura.visible = true
	elements.eje_cfa.visible = false
	elements.lbleje_cfa.visible = true
	elements.ser_cfa.visible = false
	elements.lblser_cfa.visible = true
	elements.nup_cfa.visible = false
	elements.lblnup_cfa.visible = true
	elements.fld_fecha_cfa.visible = false
	elements.lblfecha_cfa.visible = true
	elements.fld_fechacobro_cfa.visible = false
	elements.lblfechcobro_cfa.visible = true
	elements.situconta.visible = false
	elements.lblsituconta.visible = true
	globals.GCRegistroNuevo = null	
	forms.frm_nav_buttons_facturasGC.elements.btn_duplicate.enabled = true;
	forms.frm_nav_buttons_facturasGC.elements.lbl_duplicate.enabled = true;
	
	

		if(globals.GCFormulario)	
		{
			if(globals.GCFormulario == 'FrmClientesGC')
			{
				if(forms.lst_ClientesFactura_LineasGC.gctbfacturalinea_to_tbfacturacabecera)
				{			
					if(forms.lst_ClientesFactura_LineasGC.gctbfacturalinea_to_tbfacturacabecera.id)
					{
						var uuid = forms.lst_ClientesFactura_LineasGC.gctbfacturalinea_to_tbfacturacabecera.id
						var result = foundset.selectRecord(uuid)
						var fsCount = databaseManager.getFoundSetCount(foundset);
						while(result==false)
						{
							if(fsCount == foundset.getSize()) return;
							foundset.setSelectedIndex(foundset.getSize());
							result = foundset.selectRecord(uuid);
						}	
					}
				}
			}
		}
		
}

/**
 * @properties={typeid:24,uuid:"FA9DE534-F39B-4010-8637-74B0FC4BF7F4"}
 */
function sub_setNewNumeroFacturaOrd()
{
	var query = 'select [NumFactura] from [ParametrosAplicacion]'
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	nup_cfa = dataset.getValue(1, 1) + 1	
	
	var Fecha = new Date()
	fecha_cfa = Fecha
}

/**
 * @properties={typeid:24,uuid:"1F89FD30-CD6B-4959-9412-EB5B16D697E7"}
 */
function sub_setNewNumeroFacturaRect()
{
	var query = 'select [NumFacturaRect] from [ParametrosAplicacion]'
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	nup_cfa = dataset.getValue(1, 1) + 1		
}

/**
 * @properties={typeid:24,uuid:"7B8F6CA8-B4D7-46E8-AAF7-529D3737521E"}
 */
function sub_setNewNumeroFacturaCargo()
{
	var query = 'select [NumFacturaCargo] from [ParametrosAplicacion]'
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	nup_cfa = dataset.getValue(1, 1) + 1		
}

/**
 *
 * @properties={typeid:24,uuid:"AE55F190-53CB-4405-9953-48A4C018388A"}
 */
function sub_setNewNumeroFacturaAbono()
{
	var query = 'select [NumFacturaAbono] from [ParametrosAplicacion]'
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	nup_cfa = dataset.getValue(1, 1) + 1		
}

/**
 * @properties={typeid:24,uuid:"62A922EF-7A73-4B73-9067-373D5668E489"}
 */
function sub_setEjercicio()
{
	var Agno = new Date()
	Agno= Agno.getFullYear()
	var a = new String()
	a = Agno.toString()
	a= a.substr(2,2)
	eje_cfa = a
}

/**
 * @properties={typeid:24,uuid:"90DEFA76-6791-4B96-B0B2-8F687EA0AACF"}
 */
function sub_setFecha()
{
	var fecha=new Date();
	
	var d = fecha.getDate()
	var m = fecha.getMonth()+1
	var y = fecha.getFullYear()
	fecha = d + "-" + m + "-" + y
	fecha_cfa = fecha;
}

/**
 * @properties={typeid:24,uuid:"B03E9B08-A4DA-4C20-8FFB-54724A993585"}
 */
function validate_autoEnter()
{
	globals.GCRegistroNuevo = 1	
	elements.eje_cfa.visible = false
	elements.lbleje_cfa.visible = true
	elements.ser_cfa.visible = true
	elements.lblser_cfa.visible = false
	elements.nup_cfa.visible = false
	elements.lblnup_cfa.visible = true
	id = application.getUUID()
	usu_cfa = globals.GClogin_usuario
	sub_setEjercicio();
	doEditser_cfa()
	sub_setNewNumeroFacturaOrd();	
	var fech = utils.dateFormat(new Date(),'dd-MM-yyyy')
	fecha_cfa = utils.parseDate(fech,'dd-MM-yyyy')
	/*
	var vServer = plugins.UserManager.Client();
	mac = vServer.macAddress;
	
	 var hfolder = plugins.file.getHomeFolder()+"\\.servoy\\";
	var rutabat = hfolder+"Comando_numero_serie.bat";
	//var rutabat = "c:\\Servoy\\Comando_numero_serie.bat";
	var f = plugins.file.convertToJSFile(rutabat);
	
	if(f && f.exists() && application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
	{
		var str = application.executeProgram(rutabat);
		str = str.replace("SerialNumber","")
		str = str.trim();
		mac = str;
		if(!mac) mac = vServer.macAddress;
	}
	*/
	
	
	
	//if(gcparametrosaplicacion_to_parametrosaplicacion.empresasii){
		tipofacturasii = 'F1';
		tipooperacionsii = 'PS';
		sujetaexentaivasii = 'NE'
	//}
}

/**
* @param {plugins.file.JSFile} _oFile
*
*
*
 * @properties={typeid:24,uuid:"AB16D1EB-9652-42B8-AAC3-F320392FBB0F"}
 */
function uploadCallbackFunction(_oFile) {
    // Streaming the file to the server and call the callback method when this is done
    plugins.file.streamFilesToServer(_oFile, doImportFile);
}

/**
* @param {plugins.file.JSFile} _oFile
*
*
 *
 * @properties={typeid:24,uuid:"EE61A712-7BD7-43BF-A0F6-E64CC94471C1"}
 */
function doImportFile(_oFile) {
    // We need to add the upload path defined in the Servoy-Admin pages to the filename 
    
	globals.FicheroImportar =  _oFile.getName();
	if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT)
	{
		var rutapred = plugins.file.getDefaultUploadLocation()
	    _oFile = rutapred + '/' +_oFile.getName();
		globals.RutaFicheroImportar = _oFile
	}
	else
	{
		_oFile = "C:\\Servoy\\mac\\macAddress.txt"//globals.RutaFicheroImportar
	}

    //
    // Use BufferedReader so we don't have to read the whole file into memory
    //
    var _oFR = new Packages.java.io.FileInputStream(_oFile),
        _oIR = new Packages.java.io.InputStreamReader(_oFR, "UTF8"),
        _oBR = new Packages.java.io.BufferedReader(_oIR),
        _sLine = "dummy",
        _nReadLine = 0;

    // using a database transaction (might/will) speed things up
    databaseManager.startTransaction();

    try {
        while (_sLine) {
            _sLine = _oBR.readLine();
            _nReadLine++;

            if (_sLine) {

                // Put your processing code here
            }
        }
        // Save any unsaved data
       // databaseManager.saveData();

        //
        //do NOT forget this close! to prevent memory leaks
        //
        _oBR.close();

        // Close the database transaction
        databaseManager.commitTransaction();
       
    } catch (_oErr) {
    	globals.GCFichero43 = null
		globals.GCRutaFichero43 = null
        _oBR.close();
    	if(application.getApplicationType() == APPLICATION_TYPES.NG_CLIENT)
    	{
    		plugins.webnotificationsToastr.error("ERROR: " + _oFile.getName() + " at row " + _nReadLine+'\n'+LOGGINGLEVEL.ERROR,'¡Error!')
			plugins.webnotificationsToastr.error("ERROR: " + _oErr+'\n'+LOGGINGLEVEL.ERROR,'¡Error!')
    	}
		else 
		{
        globals.GCshowErrorDialog("ERROR: " + _oFile.getName() + " at row " + _nReadLine+'\n'+
        						LOGGINGLEVEL.ERROR,null,'Aceptar',null,null,null)
        //application.output("ERROR: " + _oFile.getName() + " at row " + _nReadLine, LOGGINGLEVEL.ERROR);
        globals.GCshowErrorDialog("ERROR: " + _oErr+'\n'+
        						LOGGINGLEVEL.ERROR,null,'Aceptar',null,null,null)
		}
        //application.output("ERROR: " + _oErr, LOGGINGLEVEL.ERROR);
        databaseManager.rollbackTransaction();
    } finally {
        //
        // garbage collection
        //
        _oFR = null;
        _oIR = null;
        _oBR = null;
        var i = 0;
        var filename = application.getServerURL()+"uploads/macAddress.txt";
    	var jsFile = plugins.file.convertToJSFile(filename);
    	if (jsFile.exists()) {
    	var texto = new Array();
    	_oFR = new Packages.java.io.FileInputStream(filename),
            _oIR = new Packages.java.io.InputStreamReader(_oFR, "UTF8"),
            _oBR = new Packages.java.io.BufferedReader(_oIR),
            //_sLine = "dummy",
            i = 0;
    	    while ((texto[i] = _oBR.readLine()) != null) 
    	    {
                //texto[i] = _oBR.readLine();
                i++;            
            }
    	    
            _oBR.close();
            mac = texto[0]
    	}
        application.updateUI()
		
    }
}

/** @return {Number} 
 * @properties={typeid:24,uuid:"BCCB2299-BAC4-4C8B-BA98-ACBFB40EA25F"}
 */
function validate_beforeDelete()
{
	var query = 'select savefactura from [usuarios] where [cod_us] ='+ globals.GClogin_usuario
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	var save = dataset.getValue(1, 1)
	
	if(save != '1')
	{
		scopes.svyCustomDialogs.showErrorDialog('Error','Este usuario no dispone de permiso para borrar Facturas.','Aceptar');
		//globals.GCshowErrorDialog('Este usuario no dispone de permiso para borrar Facturas.',null,'Aceptar',null,null,null)
		return 1
	}
	else if(situconta == 'C')
	{
			//show dialog and return 1
			//show the tabpanel "dialog"
		scopes.svyCustomDialogs.showErrorDialog('Error','Esta factura ya está contabilizada. No se puede borrar.','Aceptar');
		//globals.GCshowErrorDialog("Esta factura ya está contabilizada. No se puede borrar. ", null,'Aceptar', null, null, null);
		return 1
	}
	else if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbai && mac && fechaenviofichero)
	{
		scopes.svyCustomDialogs.showErrorDialog('Error','Esta factura está marcado como enviada a TicketBAI. No se puede borrar.','Aceptar');
		//globals.GCshowErrorDialog("Esta factura está marcado como enviada a TicketBAI.\nNo se puede borrar. ", null,'Aceptar', null, null, null);
		return 1
	}
	else
	{
		return 0
	}			
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"93397EC9-FB0C-4484-AFE2-B59FBAFFE3BD"}
 */
function onActionBtnCliente(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'FrmFacturas';
	//globals.GCshowDialogClientes('BD Clientes', 1, null, null, true, null, null, null, null, null);
	var win = application.getWindow('Clientes')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Clientes", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Clientes';
	//win.resizable = true;
	win.show(forms.dlgClientesGC)
	//win.show(forms.dialog_ClientesGC)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 *
 * @properties={typeid:24,uuid:"906BD88F-EFE3-4F0B-B027-BE60811808C6"}
 */
function onActionBtnFormasPago(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'FrmFacturas';
	//globals.GCshowDialogFormasPago('Formas de Pago', 1, null, null, true,null, null, null, null, null);
	var win = application.getWindow('Formas Pago')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Formas Pago", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Formas de Pago';
	//win.resizable = true;
	win.show(forms.dlgFormasPagoGCNG)
	//win.show(forms.dialog_FormasPagoGC)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 *
 * @properties={typeid:24,uuid:"64AD2759-A3DA-4347-BA02-2E5AD8E10BCF"}
 */
function onActionObservacion(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'FrmFacturasGC';
	//globals.GCshowDialogObservacion('BD Observaciones', 1, null, null, true,null, null, null, null, null);
	var win = application.getWindow('Observaciones')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Observaciones", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Observaciones';
	//win.resizable = true;
	win.show(forms.dlgObservacionGCNG)
	//win.show(forms.dialog_ObservacionGC)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 *
 *
 * @properties={typeid:24,uuid:"6DFB6386-71D4-4E7B-866C-5F1FC6031DBD"}
 */
function onActionBtnTransportes(event) {
	// TODO Auto-generated method stub
	globals.GCFormulario = 'FrmFacturas';
	//globals.GCshowDialogTransportistas('Transportistas', 1, null, null, true,null, null, null, null, null);
	var win = application.getWindow('Transportistas')
	if(win != null) win.destroy();
	 
	win = application.createWindow("Transportistas", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'BD Transportistas';
	//win.resizable = true;
	win.show(forms.dlgTransportesGCNG)
	//win.show(forms.dialog_TransportistasGC)
}

/**
 * @properties={typeid:24,uuid:"157EE3D7-217A-45DD-A8F5-9FEAA09BB2BC"}
 */
function print_default()
{
	
	//Generacion_Efecto_Factura();
	forms.frm_nav_buttons_facturasGC.btn_showAll();
	if(foundset.getSize() > 0) rpt_Factura_list();
}

/**
 * @properties={typeid:24,uuid:"CA097051-ABA0-499D-81DB-E7762BE63A9B"}
 * @AllowToRunInFind
 */
function rpt_Factura_list()
{
	try
	{
		/*var query = 'select ticketbai from ParametrosAplicacion where NºEmpresa = 1'
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
		var tbai = dataset.getValue(1, 1);*/
		var tbai = gcparametrosaplicacion_to_parametrosaplicacion.ticketbai;
		var verifactu = gcparametrosaplicacion_to_parametrosaplicacion.verifactu;
		if(forms.FrmFacturasGC.foundset.getSize() == 0){
			scopes.svyCustomDialogs.showErrorDialog('Error','No se ha registrado aún ninguna factura.','Aceptar');
			//globals.GCshowErrorDialog('No se ha registrado aún ninguna factura.',null,'Aceptar',null,null,null)
		}
		else if(forms.FrmFacturasGC.id && tbai){
			if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0){ 
			//forms.FrmFacturasGC.GCtbfacturacabecera_to_tbfacturalinea.sum_impor_lfa != 0){
				//globals.GCshowInfoDialog('Desarrollando módulo TicketBai!\n\nPóngase en contacto con el AG', null, null, null, null, null)
				forms.dlg_ImpresionFacturasTBAIGC.DesdeEje = eje_cfa
				forms.dlg_ImpresionFacturasTBAIGC.HastaEje = eje_cfa
				forms.dlg_ImpresionFacturasTBAIGC.DesdeSer = ser_cfa
				forms.dlg_ImpresionFacturasTBAIGC.HastaSer = ser_cfa
				forms.dlg_ImpresionFacturasTBAIGC.DesdeNup = nup_cfa
				forms.dlg_ImpresionFacturasTBAIGC.HastaNup = nup_cfa
				forms.dlg_ImpresionFacturasTBAIGC.DesdeCliente = null
				forms.dlg_ImpresionFacturasTBAIGC.DescDesdeCliente = null
				//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeDesdeCliente()
				forms.dlg_ImpresionFacturasTBAIGC.HastaCliente = null
				forms.dlg_ImpresionFacturasTBAIGC.HastaDescCliente = null
				//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeHastaCliente()
				globals.GCshowDialogImpresionFacturasTBAI('Impresión de Facturas TBAI',1,null,null,null,null,null,null,null,null)
			}
		}
		else if(forms.FrmFacturasGC.foundset.getSize() > 0 && verifactu){
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeEje = forms.FrmFacturasGC.eje_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaEje = forms.FrmFacturasGC.eje_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeSer = forms.FrmFacturasGC.ser_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaSer = forms.FrmFacturasGC.ser_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeNup = forms.FrmFacturasGC.nup_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaNup = forms.FrmFacturasGC.nup_cfa;
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeCliente = null
			forms.dlg_ImpresionFacturasVERIFACTUGC.DescDesdeCliente = null
			//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeDesdeCliente()
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaCliente = null
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaDescCliente = null
			globals.GCshowDialogImpresionFacturasVERIFACTU('Impresión de Facturas VERIFACTU',1,null,null,null,null,null,null,null,null)
			
		}
		else{			
			forms.dlg_ImpresionFacturasGC.DesdeEje = eje_cfa
			forms.dlg_ImpresionFacturasGC.HastaEje = eje_cfa
			forms.dlg_ImpresionFacturasGC.DesdeSer = ser_cfa
			forms.dlg_ImpresionFacturasGC.HastaSer = ser_cfa
			forms.dlg_ImpresionFacturasGC.DesdeNup = nup_cfa
			forms.dlg_ImpresionFacturasGC.HastaNup = nup_cfa
			forms.dlg_ImpresionFacturasGC.DesdeCliente = null
			forms.dlg_ImpresionFacturasTBAIGC.DescDesdeCliente = null
			//forms.dlg_ImpresionFacturasGC.onDataChangeDesdeCliente()
			forms.dlg_ImpresionFacturasGC.HastaCliente = null
			forms.dlg_ImpresionFacturasTBAIGC.HastaDescCliente = null
			//forms.dlg_ImpresionFacturasGC.onDataChangeHastaCliente()
			forms.dlg_ImpresionFacturasGC.FacturaProForma = null
			forms.dlg_ImpresionFacturasGC.FacturaE = null
			globals.GCshowDialogImpresionFacturas('Impresión de Facturas',1,null,null,null,null,null,null,null,null)
			//globals.btn_runJasperReportFacturaVentas(eje_cfa,ser_cfa,nup_cfa,eje_cfa,ser_cfa,nup_cfa,clie_cfa,clie_cfa)
			
			
			/*forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeEje = eje_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaEje = eje_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeSer = ser_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaSer = ser_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeNup = nup_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaNup = nup_cfa
			forms.dlg_ImpresionFacturasVERIFACTUGC.DesdeCliente = null
			forms.dlg_ImpresionFacturasVERIFACTUGC.DescDesdeCliente = null
			//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeDesdeCliente()
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaCliente = null
			forms.dlg_ImpresionFacturasVERIFACTUGC.HastaDescCliente = null
			globals.GCshowDialogImpresionFacturasVERIFACTU('Impresión de Facturas VERIFACTU',1,null,null,null,null,null,null,null,null)
			*/
		}
		
	}
	catch (e) 
	{
	   //plugins.dialogs.showErrorDialog('Error',e.toString(),'Ok')
	   application.output(e);   
	   return;
	}
}

/**
*
*
 * @properties={typeid:24,uuid:"A21EB125-5DE6-499B-83DF-BFDD6DB80F9A"}
 */
function sub_doDelete()
{
	if(globals.core_dlg_buttonPressed == 'Borrar')
	{
		//check to make sure that the address in question isn't used on any orders
		/*var bAdrCnt = addresses_to_orders_billing.getSize()
		var sAdrCnt = addresses_to_orders_shipping.getSize()

		if(bAdrCnt == 0 && sAdrCnt == 0)
		{*/
		var Agno = new Date()
		Agno= Agno.getFullYear()
		var a = new String()
		a = Agno.toString()
		a= a.substr(2,2)
		var ser = forms.FrmFacturasGC.ser_cfa;
		foundset.deleteRecord()
		/*}
		else
		{
			//there are orders that use this address
			var msg = 'There are orders that use this address as a shipping or billing address.' +
			' Change the orders to a new address, then you can delete this address.'
			globals.GCshowErrorDialog(msg,'forms.frm_company.sub_showCompanyOrders()','OK', null, null, null)
		}*/
		if(ser == '')
		{
			var query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa]  = '' order by [nup_cfa] desc"			
			var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			var n = dataset.getValue(1,1)
			if(n == null) n = 0;
			/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
			var result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
			var fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
			while(result==false)
			{
				if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
				{
				return;
				}
			forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
			}
			
			forms.dlg_ParametroAplicacionGC.numfactura = n;*/
			gcparametrosaplicacion_to_parametrosaplicacion.numfactura = n;
			databaseManager.saveData()
		}
		else if(ser == 'R')
		{
			query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'R' order by [nup_cfa] desc"			
			dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			n = dataset.getValue(1,1)
			if(n == null) n = 0;
			/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
			fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
			while(result==false)
			{
				if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
				{
				return;
				}
			forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
			}
			
			forms.dlg_ParametroAplicacionGC.numfacturarect = n;*/
			gcparametrosaplicacion_to_parametrosaplicacion.numfacturarect = n;
			databaseManager.saveData()
		}
		else if(ser == 'C')
		{
			query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'C' order by [nup_cfa] desc"			
			dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			n = dataset.getValue(1,1)
			if(n == null) n = 0;
			/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
			fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
			while(result==false)
			{
				if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
				{
				return;
				}
			forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
			}
			
			forms.dlg_ParametroAplicacionGC.numfacturacargo = n;*/
			gcparametrosaplicacion_to_parametrosaplicacion.numfacturacargo = n;
			databaseManager.saveData()
		}
		else if(ser == 'A')
		{
			query = "select [nup_cfa] from [tbFacturaCabecera] WHERE eje_cfa = "+a+" and [ser_cfa] = 'A' order by [nup_cfa] desc"			
			dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			n = dataset.getValue(1,1)
			if(n == null) n = 0;
			/*forms.dlg_ParametroAplicacionGC.foundset.loadAllRecords()
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1)
			fsCount = databaseManager.getFoundSetCount(forms.dlg_ParametroAplicacionGC.foundset);
			while(result==false)
			{
				if(fsCount == forms.dlg_ParametroAplicacionGC.foundset.getSize())
				{
				return;
				}
			forms.dlg_ParametroAplicacionGC.foundset.setSelectedIndex(forms.dlg_ParametroAplicacionGC.foundset.getSize());
			result = forms.dlg_ParametroAplicacionGC.foundset.selectRecord(1);
			}
			
			forms.dlg_ParametroAplicacionGC.numfacturaabono = n;*/
			gcparametrosaplicacion_to_parametrosaplicacion.numfacturaabono = n;
			databaseManager.saveData()
		}	
		
	}
}

/**
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"34024DA7-1594-49F0-A055-817C35103CBF"}
 */
function Generacion_FacturaComision()
{
	var ejer = forms.FrmFacturasGC.eje_cfa
	var ser = forms.FrmFacturasGC.ser_cfa
	var nup = forms.FrmFacturasGC.nup_cfa
	var importe = forms.FrmFacturasGC.impbie_cfa + forms.FrmFacturasGC.impbie2_cfa + forms.FrmFacturasGC.impbie3_cfa;
	forms.FrmFacturasGC.gctbfacturacabecera_to_tbfacturacomision.loadAllRecords()
	forms.FrmFacturasGC.gctbfacturacabecera_to_tbfacturacomision.deleteAllRecords()
	
	if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes)
	{
		if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.comisionista && GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes)
		{
			if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes.porccomision &&
			forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes.porccomision != 0 &&
			importe)
			{
				var agente = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes.idagente;
				var porc = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes.porccomision;
				//var pirpf = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroagentes.pirpf;
				var impor = globals.GCROUND(importe * porc * 0.01,2)
				
				forms.lst_FacturaComision.foundset.newRecord()
				forms.lst_FacturaComision.foundset.id = application.getUUID()
				forms.lst_FacturaComision.foundset.eje_cfa = ejer;
				forms.lst_FacturaComision.foundset.ser_cfa = ser;
				forms.lst_FacturaComision.foundset.nup_cfa = nup;
				forms.lst_FacturaComision.foundset.comisionista_cfa = agente;
				forms.lst_FacturaComision.foundset.porccomision_cfa = porc;
				forms.lst_FacturaComision.foundset.impcomision_cfa = impor;
				
				databaseManager.saveData(forms.lst_FacturaComision.foundset)
				
			}
		}
	}
	
}

/**
 * @properties={typeid:24,uuid:"9811C79D-B072-40FF-B88D-EA96978AEC58"}
 * @AllowToRunInFind
 */
function Generacion_Efecto_Factura()
{
	//if(gctbfacturacabecera_to_efectos && gctbfacturacabecera_to_efectos.getSize()==0)
	var ejer = eje_cfa
	var ser = ser_cfa
	var nup = nup_cfa
	var cfpa = cfpa_cfa
	var fechaefec = fecha_cfa
	var importe = impnee_cfa
	gctbfacturacabecera_to_efectos.loadAllRecords()
	gctbfacturacabecera_to_efectos.deleteAllRecords()
	if(cfpa_cfa)
	{
		if(GCtbfacturacabecera_to_tbmaestroformpago)
		{
			var nefectos = GCtbfacturacabecera_to_tbmaestroformpago.ngiro_fp
			var mesvenc = GCtbfacturacabecera_to_tbmaestroformpago.mefec_fp
			var tipomesvenc = GCtbfacturacabecera_to_tbmaestroformpago.tipocuentaefec_fp
			var diasvenc = GCtbfacturacabecera_to_tbmaestroformpago.mprve_fp
			var tipodiasvenc = GCtbfacturacabecera_to_tbmaestroformpago.tipocuentavenc
		}
			if(nefectos == null || nefectos == 0 || nefectos == 'Undefined')
			{
				nefectos = 1;
			}
			if(mesvenc == null || mesvenc == 0 || mesvenc == 'Undefined')
			{
				mesvenc = 0;
			}
			if(diasvenc == null || diasvenc == 0 || diasvenc == 'Undefined')
			{
				diasvenc = 0;
			}
			
			
			
				
				var importeefec = globals.GCROUND(impnee_cfa / nefectos,2)
				
				for(var i=1;i<=nefectos;i++)
				{
					if(importe-importeefec >= 0)
					{
						importe -= importeefec
					}
					else
					{
						importeefec = importe
						importe -= importeefec
					}
					
					var porc =  globals.GCROUND(100 / nefectos,2)
					
					var Linea = sub_setNewNumeroLineaEfecto()
					
					if(i==1)
					{
						if(tipodiasvenc == 'D')
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth(),fechaefec.getDate() + diasvenc)			
						}
						else
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth() + diasvenc,fechaefec.getDate() )					
						}
						
					}
					else
					{
						if(tipomesvenc == 'D')
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth(),fechaefec.getDate() + mesvenc)												
						}
						else
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth() + mesvenc,fechaefec.getDate() )						
						}			
					}
					var clidiapago = GCtbfacturacabecera_to_tbmaestroclientes.diapago1;
					var clidiapago2 = GCtbfacturacabecera_to_tbmaestroclientes.diapago2;
					var clidiapago3 = GCtbfacturacabecera_to_tbmaestroclientes.diapago3;
					
	 				if(clidiapago != 0 && clidiapago != null)
					{
						if(fechaefec.getDate() <= clidiapago)
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth(),clidiapago)
						}
						else if(clidiapago2 != 0 && clidiapago2 != null)
						{
							if(fechaefec.getDate() <= clidiapago2)
							{
								fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth(),clidiapago2)
							}
							else if(clidiapago3 != 0 && clidiapago3 != null)
							{
								if(fechaefec.getDate() <= clidiapago3)
								{
									fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth(),clidiapago3)
								}
								else
								{
									fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth()+1,clidiapago)
								}
							}
							else
							{
								fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth()+1,clidiapago)
							}
						}
						else
						{
							fechaefec = new Date(fechaefec.getFullYear(),fechaefec.getMonth()+1,clidiapago)
						}
					}
					
					var query = "select [fechapagos] from [tbMaestroClientesVacaciones] WHERE idcliente = "+clie_cfa+
					" and ('"+utils.dateFormat(fechaefec,'dd-MM-yyyy')+"' between [fechainicio] and [fechafin]) order by nperiodo"			
					var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1);
					var fechpagoscli = dataset.getValue(1,1);
					if(fechpagoscli) fechaefec = fechpagoscli;
					
					fechcobro_cfa = fechaefec
					databaseManager.saveData(foundset)
					
						
					forms.lst_EfectosFacturaGC.foundset.newRecord(true)
					forms.lst_EfectosFacturaGC.id = application.getUUID()
					forms.lst_EfectosFacturaGC.eje_ef = ejer
					forms.lst_EfectosFacturaGC.ser_ef = ser
					forms.lst_EfectosFacturaGC.nup_ef = nup
					forms.lst_EfectosFacturaGC.nli_ef = Linea
					forms.lst_EfectosFacturaGC.fecha_ef = fechaefec
					forms.lst_EfectosFacturaGC.cfpa_ef = cfpa
					forms.lst_EfectosFacturaGC.porc_ef = porc
					forms.lst_EfectosFacturaGC.impo_ef = importeefec
				
					databaseManager.saveData();
					
					
				}
	}
	else if(fechcobro_cfa != null && fechcobro_cfa != '')
	{
		query = "select [fechapagos] from [tbMaestroClientesVacaciones] WHERE idcliente = "+clie_cfa+
		" and ('"+utils.dateFormat(fechcobro_cfa,'dd-MM-yyyy')+"' between [fechainicio] and [fechafin]) order by nperiodo"			
		dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1);
		fechpagoscli = dataset.getValue(1,1);
		if(fechpagoscli) fechcobro_cfa = fechpagoscli;
		

		forms.lst_EfectosFacturaGC.foundset.newRecord(true)
		forms.lst_EfectosFacturaGC.id = application.getUUID()
		forms.lst_EfectosFacturaGC.eje_ef = ejer
		forms.lst_EfectosFacturaGC.ser_ef = ser
		forms.lst_EfectosFacturaGC.nup_ef = nup
		Linea = sub_setNewNumeroLineaEfecto()
		forms.lst_EfectosFacturaGC.nli_ef = Linea
		forms.lst_EfectosFacturaGC.fecha_ef = fechcobro_cfa
		forms.lst_EfectosFacturaGC.cfpa_ef = null
		forms.lst_EfectosFacturaGC.porc_ef = 100
		forms.lst_EfectosFacturaGC.impo_ef = importe
	
		databaseManager.saveData();
		
	}
	else
	{
		query = "select [fechapagos] from [tbMaestroClientesVacaciones] WHERE idcliente = "+clie_cfa+
		" and ('"+utils.dateFormat(fecha_cfa,'dd-MM-yyyy')+"' between [fechainicio] and [fechafin]) order by nperiodo"			
		dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1);
		fechpagoscli = dataset.getValue(1,1);
		if(fechpagoscli) fechcobro_cfa = fechpagoscli;
		else fechcobro_cfa = fecha_cfa;
		
		forms.lst_EfectosFacturaGC.foundset.newRecord(true)
		forms.lst_EfectosFacturaGC.id = application.getUUID()
		forms.lst_EfectosFacturaGC.eje_ef = ejer
		forms.lst_EfectosFacturaGC.ser_ef = ser
		forms.lst_EfectosFacturaGC.nup_ef = nup
		Linea = sub_setNewNumeroLineaEfecto()
		forms.lst_EfectosFacturaGC.nli_ef = Linea
		forms.lst_EfectosFacturaGC.fecha_ef = fechcobro_cfa
		forms.lst_EfectosFacturaGC.cfpa_ef = null
		forms.lst_EfectosFacturaGC.porc_ef = 100
		forms.lst_EfectosFacturaGC.impo_ef = importe
	
		databaseManager.saveData();
	}
}

/**
 * @return {Number}
 * 
 * @properties={typeid:24,uuid:"D4D1423A-B3DA-4AB4-8B8A-99233223BB9E"}
 */
function sub_setNewNumeroLineaEfecto()
{
	var query = "select nli_ef from [efectos] where eje_ef = " + eje_cfa +
	" and ser_ef = '"+ ser_cfa +"' and nup_ef = " + nup_cfa + " order by nli_ef desc"
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	var Linea = dataset.getValue(1, 1) + 1
	return Linea
}

/**
 * Handle changed data.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"7261F6C8-DDE8-47FE-84AA-6FE667D4ECE4"}
 */
function onDataChangeSerie(event) {
	// TODO Auto-generated method stub
	if(ser_cfa == null || ser_cfa == '')
	{
		sub_setNewNumeroFacturaOrd();
	}
	else if(ser_cfa == 'R')
	{
		sub_setNewNumeroFacturaRect()
	}
	else if(ser_cfa == 'C')
	{
		sub_setNewNumeroFacturaCargo()
	}
	else if(ser_cfa == 'A')
	{
		sub_setNewNumeroFacturaAbono()
	}
	ocultarcampos()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"9133790C-20D7-40C7-854F-BE0058F41837"}
 */
function onActionfecha(event) {
	// TODO Auto-generated method stub
	onDataChangefecha()
	elements.fld_clie_cfa.requestFocus()
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"CDC6C9EC-4DE9-4122-A9A6-AE9F5EBE00B1"}
 */
function btn_BDCliente(event) {
	// TODO Auto-generated method stub
	if(globals.GCisEditing()) forms.FrmFacturasGC.btn_cancel()
	if(clie_cfa)
	{
		/*var win = application.getWindow('Maestros')
		//setup the record status
		if(win != null)
		{
			win.destroy();
		}
		
		win = application.createWindow("Maestros", JSWindow.MODAL_DIALOG);
		win.setInitialBounds(10, 10, 1100, 600);
		win.title = 'BD Clientes';
		globals.GCnav_search = null;
		globals.GCFormulario = 'FrmFacturasGC';
		forms.FrmClientesGC.controller.show(win);
		forms.lst_solution_navigation_maestrosGC.controller.setSelectedIndex(1) */
		
		var query = "select [ID] from [tbMaestroClientes] where [IdCliente] = " + clie_cfa
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
		
		var result = forms.dlg_ClientesGC.foundset.selectRecord(dataset.getValue(1,1))
		var fsCount = databaseManager.getFoundSetCount(forms.dlg_ClientesGC.foundset);
		while(result==false)
		{
			if(fsCount == forms.dlg_ClientesGC.foundset.getSize()) return;
			forms.dlg_ClientesGC.foundset.setSelectedIndex(forms.dlg_ClientesGC.foundset.getSize());
			result = forms.dlg_ClientesGC.foundset.selectRecord(dataset.getValue(1,1));
		}
		if(!globals.GCisEditing()) globals.GCstartEditing()
		forms.dlg_ClientesGC.elements.idcodigo.bgcolor = '#f0f0f0';
		forms.dlg_ClientesGC.elements.idcodigo.readOnly = true;
		forms.dlg_ClientesGC.elements.idcodigo.visible = false;
		forms.dlg_ClientesGC.elements.lblidcodigo.visible = true;
		forms.dlg_ClientesGC.elements.btn_print.enabled = true;
		globals.GCshowDialogCliente('BD Clientes', 1, null, null, true, null, null, null, null, null);
		
	}
	else
	{
		/*win = application.getWindow('Maestros')
		//setup the record status
		if(win != null)
		{
			win.destroy();
		}
		
		win = application.createWindow("Maestros", JSWindow.MODAL_DIALOG);
		win.setInitialBounds(10, 10, 1100, 600);
		win.title = 'BD Clientes';
		globals.GCnav_search = null;
		globals.GCFormulario = 'FrmFacturasGC';
		forms.FrmClientesGC.controller.show(win);
		forms.lst_solution_navigation_maestrosGC.controller.setSelectedIndex(1) */
		forms.dlg_ClientesGC.foundset.setSelectedIndex(1)
		if(!globals.GCisEditing()) globals.GCstartEditing()
		forms.dlg_ClientesGC.elements.idcodigo.readOnly = true;
		forms.dlg_ClientesGC.elements.idcodigo.bgcolor = '#f0f0f0';
		forms.dlg_ClientesGC.elements.idcodigo.visible = false;
		forms.dlg_ClientesGC.elements.lblidcodigo.visible = true;
		forms.dlg_ClientesGC.elements.btn_print.enabled = true;
		globals.GCshowDialogCliente('BD Cliente', 1, null, null, true, null, null, null, null, null);
		
	}
}

/**
 * Handle focus lost event of the element.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"0412B39C-6EEE-4DA7-A431-BD32A4733033"}
 */
function onFocusLostDtoPP(event) {
	// TODO Auto-generated method stub
	impbie_cfa = null;
	cuotaiva_cfa = null;
	impbie2_cfa = null;
	cuotaiva2_cfa = null;
	impbie3_cfa = null;
	cuotaiva3_cfa = null;
	impre = null;
	impre2 = null;
	impre3 = null;
	if(ser_cfa == null) var ser = 'IS NULL';
	else ser = "= '"+ser_cfa+"'";
	
	var query = "select DISTINCT(piva_lfa), ISNULL(SUM(impor_lfa),0),ISNULL(SUM(importot_lfa),0)-ISNULL(SUM(impor_lfa),0) as IVAlinea "+
				"FROM tbFacturaLinea WHERE eje_lfa = "+eje_cfa+
				" AND ser_lfa "+ser+" AND nup_lfa = "+nup_cfa+
				" GROUP BY piva_lfa"+
				" ORDER BY piva_lfa DESC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 3)
	var rows = dataset.getMaxRowIndex()
	for(var i=1;i<=rows;i++)
	{
		if(i == 1) 
		{
			piva_cfa = dataset.getValue(i,1);
			impbie_cfa = dataset.getValue(i,2);
			var Dtopp = impbie_cfa * depp_cfa * 0.01;
			if(GCtbfacturacabecera_to_tbmaestroclientes.aplicarre == 1)
			{
				query = "select [IvaRE] FROM [tbMaestroTipoIva] WHERE [Factor] = "+piva_cfa;
				var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
				var re = dataset2.getValue(1,1);
				impre = globals.GCROUND(((impbie_cfa - Dtopp) * re * 0.01),2);
				//impbie_cfa = impbie_cfa + impre
			}
			else
			{
				impre = null;
			}
			impbie_cfa = globals.GCROUND(impbie_cfa - Dtopp,2);
			if(dataset.getValue(i,3)) cuotaiva_cfa = globals.GCROUND(dataset.getValue(i,3),2);
			else cuotaiva_cfa = globals.GCROUND(impbie_cfa * piva_cfa * 0.01,2);
			//cuotaiva_cfa =globals.GCROUND(cuotaiva_cfa,2)
			if(impbie_cfa == 0) 
			{
				impbie_cfa = null;
				cuotaiva_cfa = null;
				piva_cfa = null;
				impre = null;
			}	
		}
		else if(i == 2) 
		{
			piva2_cfa = dataset.getValue(i,1);
			impbie2_cfa = dataset.getValue(i,2);
			Dtopp = impbie2_cfa * depp_cfa * 0.01;
			if(GCtbfacturacabecera_to_tbmaestroclientes.aplicarre == 1)
			{
				query = "select [IvaRE] FROM [tbMaestroTipoIva] WHERE [Factor] = "+piva2_cfa;
				dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
				re = dataset2.getValue(1,1);
				impre2 = globals.GCROUND(((impbie2_cfa - Dtopp) * re * 0.01),2);
			}
			else
			{
				impre2 = null;
			}
			impbie2_cfa = globals.GCROUND(impbie2_cfa - Dtopp,2);
			if(dataset.getValue(i,3)) cuotaiva2_cfa = globals.GCROUND(dataset.getValue(i,3),2);
			else cuotaiva2_cfa = globals.GCROUND(impbie2_cfa * piva2_cfa * 0.01,2);
			//cuotaiva2_cfa =globals.GCROUND(cuotaiva2_cfa,2)
			if(impbie2_cfa == 0) 
			{
				impbie2_cfa = null;
				cuotaiva2_cfa = null;
				piva2_cfa = null;
				impre2 = null;
			}			
			
		}
		else if(i == 3) 
		{
			piva3_cfa = dataset.getValue(i,1);
			impbie3_cfa = dataset.getValue(i,2);
			Dtopp = impbie3_cfa * depp_cfa * 0.01;
			if(GCtbfacturacabecera_to_tbmaestroclientes.aplicarre == 1)
			{
				query = "select [IvaRE] FROM [tbMaestroTipoIva] WHERE [Factor] = "+piva3_cfa;
				dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
				re = dataset2.getValue(1,1);
				impre3 = globals.GCROUND(((impbie_cfa - Dtopp) * re * 0.01),2);
			}
			else
			{
				impre3 = null;
			}
			impbie3_cfa = globals.GCROUND(impbie3_cfa - Dtopp,2);
			if(dataset.getValue(i,3)) cuotaiva3_cfa = globals.GCROUND(dataset.getValue(i,3),2);
			else cuotaiva3_cfa = globals.GCROUND(impbie3_cfa * piva3_cfa * 0.01,2);
			//cuotaiva3_cfa =globals.GCROUND(cuotaiva3_cfa,2)
			if(impbie3_cfa == 0) 
			{
				impbie3_cfa = null;
				cuotaiva3_cfa = null;
				piva3_cfa = null;
				impre3 = null;
			}	
		}
	}
	/*var Dtopp = impbre_cfa * depp_cfa * 0.01
	impbie_cfa = globals.GCROUND(impbre_cfa - Dtopp,2)
	cuotaiva_cfa = impbie_cfa * piva_cfa * 0.01
	cuotaiva_cfa =globals.GCROUND(cuotaiva_cfa,2)
	*/
	onFocusLostgtosfinan(event) 
	//impnee_cfa = impbie_cfa + impbie2_cfa + impbie2_cfa + cuotaiva_cfa  + cuotaiva2_cfa  + cuotaiva3_cfa + impgtosfinan
	//impnee_cfa = globals.GCROUND(impnee_cfa,2)
	
}

/**
 * Handle focus lost event of the element.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"BD39646B-3651-43AC-A3A4-D70D85E243C3"}
 */
function onFocusLostIva(event) {
	// TODO Auto-generated method stub
	onFocusLostDtoPP(event)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"557B0704-95DA-4153-B73E-236AE68B0C84"}
 */
function onActionanticipo(event) {
	// TODO Auto-generated method stub
	elements.fld_depp_cfa.requestFocus()
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"6E795B61-952F-4E1D-9401-1DBD40641915"}
 */
function onActiondto(event) {
	// TODO Auto-generated method stub
	elements.fld_gtosfinan_cfa.requestFocus()
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"DAFCFD36-2E1E-4CC9-AC5D-2FD98EF5DC89"}
 */
function onActiongtosfinan(event) {
	// TODO Auto-generated method stub
	onFocusLostgtosfinan(event)
	//elements.fld_pirpf.requestFocus()
	
}

/**
 * Handle focus lost event of the element.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"1EAB3835-9CD1-4C6E-AF06-E056EFF8B9CF"}
 */
function onFocusLostgtosfinan(event) {
	// TODO Auto-generated method stub
	impgtosfinan = globals.GCROUND((impbie_cfa + impbie2_cfa + impbie3_cfa) * gtosfinan_cfa  * 0.01, 2);
	//impgtosfinan = globals.GCROUND(impgtosfinan,2)
	if(impgtosfinan == 0) impgtosfinan = null;
	if(pirpf)
	{
		impirpf = globals.GCROUND((impbie_cfa + impbie2_cfa + impbie3_cfa /*- ImporDto*/) * pirpf * -0.01, 2);
		if(impirpf == 0) impirpf = null;
	}
	else
	{
		impirpf = null
	}
	//var Dtopp1 = impbie_cfa * depp_cfa * 0.01
	//var Dtopp2 = impbie2_cfa * depp_cfa * 0.01
	//var Dtopp3 = impbie3_cfa * depp_cfa * 0.01
	impnee_cfa = globals.GCROUND(impbie_cfa + impbie2_cfa + impbie3_cfa + cuotaiva_cfa  + cuotaiva2_cfa  + cuotaiva3_cfa + impre + impre2 + impre3 + impgtosfinan + impirpf /*- Dtopp1 - Dtopp2 - Dtopp3*/,2)
	//impnee_cfa = globals.GCROUND(impnee_cfa,2)
}

/**
 * Handle changed data.
 *
 * @properties={typeid:24,uuid:"77022A07-880D-4D3F-B5F5-B6AB1085632A"}
 */
function onDataChangeFP() {
	// TODO Auto-generated method stub
	var query = "select [denom_fp] from [tbMaestroformpago] where [codig_fp] = '" + cfpa_cfa +"'";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	desccfpa_cfa = dataset.getValue(1,1);	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"E1424A49-9BA3-4DEE-8208-722FB447C560"}
 */
function onActionEnviarEmail(event) {
	// TODO Auto-generated method stub
	if(globals.GCisEditing()) forms.FrmFacturasGC.btn_cancel()
	
	if(id)
	{
		var query = 'select [ServidorCorreoSMTP] from [ParametrosAplicacion]'
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
		var SMTP = dataset.getValue(1,1)
		if(!SMTP)
		{
			scopes.svyCustomDialogs.showErrorDialog('Error','No está definido el Servidor de Correo SMTP en los Parametros de la Aplicación.','Aceptar');
			//globals.GCshowErrorDialog('No está definido el Servidor de Correo SMTP en los Parametros de la Aplicación.',null,'Aceptar',null,null,null)
		}
		else
		{
			query = 'select imde_us,nuser_us,passw_us from [usuarios] WHERE [cod_us] = ' + globals.GClogin_usuario
			dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			var EmailFrom = dataset.getValue(1,1)
			var UserEmail = dataset.getValue(1,2)
			var PasswEmail = dataset.getValue(1,3)
			if(EmailFrom == null || EmailFrom == '')
			{
				scopes.svyCustomDialogs.showErrorDialog('Error','No están definidos los datos de la cuenta de correo del usuario en los Usuarios.','Aceptar');
				//globals.GCshowErrorDialog('No están definidos los datos de la cuenta de correo del usuario en los Usuarios.',null,'Aceptar',null,null,null)
			}
			else if(UserEmail == null || UserEmail == '')
			{
				scopes.svyCustomDialogs.showErrorDialog('Error','No están definidos los datos de la cuenta de correo del usuario en los Usuarios.','Aceptar');
				//globals.GCshowErrorDialog('No están definidos los datos de la cuenta de correo del usuario en los Usuarios.',null,'Aceptar',null,null,null)
			}
			else if(PasswEmail == null || PasswEmail == '')
			{
				scopes.svyCustomDialogs.showErrorDialog('Error','No están definidos los datos de la cuenta de correo del usuario en los Usuarios.','Aceptar');
				//globals.GCshowErrorDialog('No están definidos los datos de la cuenta de correo del usuario en los Usuarios.',null,'Aceptar',null,null,null)
			}
			else
			{
				var empresatbai = gcparametrosaplicacion_to_parametrosaplicacion.ticketbai;
				if(!empresatbai){
				/*if(application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
				{
					var reportName = 'FacturaVentaGC.jrxml';
					
					var params = new java.util.HashMap()
					params.put('DesdeEjer', forms.FrmFacturasGC.eje_cfa)
					params.put('HastaEjer', forms.FrmFacturasGC.eje_cfa)
					params.put('DesdeSer', forms.FrmFacturasGC.ser_cfa)
					params.put('HastaSer', forms.FrmFacturasGC.ser_cfa)
					params.put('DesdeNFact', forms.FrmFacturasGC.nup_cfa)
					params.put('HastaNFact', forms.FrmFacturasGC.nup_cfa)
					params.put('DesdeCliente', forms.FrmFacturasGC.clie_cfa)
					params.put('HastaCliente', forms.FrmFacturasGC.clie_cfa)
					var exportTo = 'pdf';//
					var temp_file = plugins.file.createTempFile('Fra'+forms.FrmFacturasGC.eje_cfa+utils.numberFormat(forms.FrmFacturasGC.nup_cfa,'00000')+forms.FrmFacturasGC.ser_cfa, '.'+exportTo);
					//_temp_file = plugins.file.createTempFile('NameTempFile', '.pdf')
			
				    var _attachment = temp_file.getParent() + '\\Fra' +forms.FrmFacturasGC.eje_cfa+utils.numberFormat(forms.FrmFacturasGC.nup_cfa,'00000')+forms.FrmFacturasGC.ser_cfa+'.pdf';
					//plugins.jasperPluginRMI.jasperReport(server_name,reportName,null,'view',params)	
					try{
					plugins.jasperPluginRMI.runReport(globals.GCconex,reportName,_attachment,exportTo,params);
					}
					catch(e)
				    {
				    	application.output(e.toString())
				    }
					//var url = 'mailto:your.friend@doesntexist.com?cc=another.friend@doesntexist.com,yetanother.friend@doesntexist.com&bcc=yourboss@doesntexist.com&reply-to=me@myadress.com&subject=mailto%20scheme&body=Hello%20Everybody'
					
					var url = 'mailto:'+forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.emailcontacto+'?subject=Notificación+envio+Factura+de+Venta&attachment='+_attachment
					//application.showURL(url)
					if(utils.stringMiddle(application.getOSName(),1,7) == "Windows")
					{
						application.executeProgram('rundll32', 'url.dll,FileProtocolHandler', url)
					}
				}
				else
				{*/
					globals.GCFormulario = 'FrmFacturas'
					globals.GCshowDialogEnvioMail('Impresión y Envio Factura',1,null,null,null,null,null,null,null,null)
				//}
				}
				else{
					if(mac && fechaenviofichero){
						globals.GCFormulario = 'FrmFacturas'
						globals.GCshowDialogEnvioMail('Impresión y Envio Factura',1,null,null,null,null,null,null,null,null)
					}
					else{
						var msg = '<html>Todavía no se ha realizado el envío a TicketBAI!<br>Pulse primero el botón de imprimir para realizar el envío al sistema TicketBAI.<br>Después podrá realizar el envío de la factura por email.</html>'
						scopes.svyCustomDialogs.showErrorDialog('Error',msg,'Aceptar');
						//scopes.svyCustomDialogs.showErrorDialog('Error','¡Todavía no se ha realizado el envío a TicketBAI!\nPulse primero el botón de imprimir para realizar el envío al sistema TicketBAI. Después podrá realizar el envío de la factura por email.','Aceptar');
						//globals.GCshowErrorDialog('¡Todavía no se ha realizado el envío a TicketBAI!\nPulse primero el botón de imprimir para realizar el envío al sistema TicketBAI. Después podrá realizar el envío de la factura por email.',null,'Aceptar',null,null,null)
					}
				}
			}
		}
	}
}

/**
 * Handle changed data.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"D94020B1-6BC8-45E6-AB88-E427EDB4D94D"}
 */
function onDataChangeCliente(event) {
	// TODO Auto-generated method stub
	if(clie_cfa)
	{
		if(GCtbfacturacabecera_to_tbmaestroclientes)
		{
			if(!GCtbfacturacabecera_to_tbmaestroclientes.idcliente)
			{
				scopes.svyCustomDialogs.showWarningDialog('Advertencia','Cliente inexistente.');
				//globals.GCshowWarningDialog('Cliente inexistente.',null,'Aceptar',null,null,null)
			}
			else
			{
				if(GCtbfacturacabecera_to_tbmaestroclientes.idformapago) cfpa_cfa = GCtbfacturacabecera_to_tbmaestroclientes.idformapago;
				if(cfpa_cfa) onDataChangeFP()
				if(GCtbfacturacabecera_to_tbmaestroclientes.tipoiva ||
				GCtbfacturacabecera_to_tbmaestroclientes.tipoiva == 0.0) piva_cfa = GCtbfacturacabecera_to_tbmaestroclientes.tipoiva;
				if(!piva_cfa) piva_cfa = 0;
				if(GCtbfacturacabecera_to_tbmaestroclientes.dto) depp_cfa = GCtbfacturacabecera_to_tbmaestroclientes.dto;
				if(depp_cfa) onFocusLostDtoPP(event)
				if(GCtbfacturacabecera_to_tbmaestroclientes.tiporetenirpf) pirpf = GCtbfacturacabecera_to_tbmaestroclientes.tiporetenirpf;
				if(pirpf) onFocusLostgtosfinan(event)
				if(impbre_cfa) onFocusLostIva(event)
				if(GCtbfacturacabecera_to_tbmaestroclientes.pais &&
				GCtbfacturacabecera_to_tbmaestroclientes.pais != 'ES')
				{
					tipooperacionsii = 'E';
					sujetaexentaivasii = 'E';
				}
				else if(GCtbfacturacabecera_to_tbmaestroclientes.codpostal &&
						(utils.stringLeft(GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '35' ||
						utils.stringLeft(GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '38'||
						utils.stringLeft(GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '51'||
						utils.stringLeft(GCtbfacturacabecera_to_tbmaestroclientes.codpostal,2) == '52'))
				{
					tipooperacionsii = 'E';
					sujetaexentaivasii = 'NS';
				}
				else
				{
					tipooperacionsii = 'E';
					sujetaexentaivasii = 'NE';
				}
				if(!GCtbfacturacabecera_to_tbmaestroclientes.cif)
				{
					scopes.svyCustomDialogs.showWarningDialog('Advertencia','En la ficha de este cliente falta indicar el cif. Agregaselo para que sea una factura legal.');
					//globals.GCshowWarningDialog('En la ficha de este cliente falta indicar el cif. Agregaselo para que sea una factura legal.',null,'Aceptar',null,null,null)
				}
				if(GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0)
				{
					if(forms.FrmFacturasGC.eje_cfa && forms.FrmFacturasGC.nup_cfa)
					{							
						if(forms.FrmFacturasGC.ser_cfa == null)
						{
							var ser = 'IS NULL'
						}
						else
						{
							ser = "= '"+forms.FrmFacturasGC.ser_cfa+"'"
						}	
						
						if(GCtbfacturacabecera_to_tbmaestroclientes.tipoiva) var pivacli = GCtbfacturacabecera_to_tbmaestroclientes.tipoiva;
						if(!pivacli) pivacli = 0;
						var query = "select id from tbFacturaLinea where eje_lfa="+forms.FrmFacturasGC.eje_cfa+
						" and ser_lfa "+ser+" and nup_lfa =" + forms.FrmFacturasGC.nup_cfa +
						" and piva_lfa != "+pivacli+
						" order by nli_lfa"
						var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
						if(dataset.getMaxRowIndex() > 0) {
							scopes.svyCustomDialogs.showWarningDialog('Advertencia','El IVA indicado en alguna de las líneas de la factura es distinto al indicado en la ficha de este cliente. Reviselo y recalcule los importes si hiciera falta.');
							//globals.GCshowWarningDialog('El IVA indicado en alguna de las líneas de la factura es distinto al indicado en la ficha de este cliente. Reviselo y recalcule los importes si hiciera falta.',null,'Aceptar',null,null,null)
						}
						/*var query = "select id from tbFacturaLinea where eje_lfa="+forms.FrmFacturasGC.eje_cfa+
									" and ser_lfa "+ser+" and nup_lfa =" + forms.FrmFacturasGC.nup_cfa +
									" order by nli_lfa"
						var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, -1)
						var rows = dataset.getMaxRowIndex()
						
						for(var i=1;i<=rows;i++)
						{
							var uuid = dataset.getValue(i,1)							
							var bool = forms.dlg_Linea_FacturaGC.foundset.loadRecords(databaseManager.convertToDataSet([uuid]))
							if(bool == true)
							{
								if(forms.dlg_Linea_FacturaGC.piva_lfa != GCtbfacturacabecera_to_tbmaestroclientes.tipoiva)
								{
									globals.GCshowWarningDialog('El IVA indicado en las líneas de la factura es distinto al indicado en la ficha de este cliente. Modifique el IVA en las líneas y recalcule los importe.',null,'Aceptar',null,null,null)
									break;
								}
							}
						}*/
					}
				}
			}
		}
		else
		{
			cfpa_cfa = null;
			piva_cfa = 0;
			depp_cfa = null;
		}
	}
	else
	{
		cfpa_cfa = null;
		piva_cfa = 0;
		depp_cfa = null;
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"B8D0261A-F362-4E76-B627-57EE4ABF7F64"}
 */
function onActioncli(event) {
	// TODO Auto-generated method stub
	onDataChangeCliente(event)
	elements.fld_fechacobro_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"6E437216-E033-4B97-8340-68EC2CF28F42"}
 */
function onActioncliexp(event) {
	// TODO Auto-generated method stub
	onDataChangeCliente(event)
	elements.fld_fechacobro_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"3C625DB7-01D8-4CF9-8716-72CA00D4A1C8"}
 */
function onActionfechacobro(event) {
	// TODO Auto-generated method stub
	onDataChangefechacobro()
	elements.fld_cfpa_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"005E27F2-446C-4E59-A51E-F4EB214548E9"}
 */
function onActionFP(event) {
	// TODO Auto-generated method stub
	//onDataChangeFP()
	elements.fld_desccfpa_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"9DC5E077-D498-482E-B24C-1525A91EC002"}
 */
function onActiondescFP(event) {
	// TODO Auto-generated method stub
	elements.fld_obse_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"7ECA311B-F739-42CA-BF96-D8D7DD93E1AF"}
 */
function onActionobse(event) {
	// TODO Auto-generated method stub
	elements.fld_fenvio.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"B2AA6C1E-6260-46BE-903E-5EE6446F92CD"}
 */
function onActionfenvio(event) {
	// TODO Auto-generated method stub
	elements.fld_depp_cfa.requestFocus()
}

/**
 * Handle changed data.
 *
 * @properties={typeid:24,uuid:"2F50D7AE-A777-491B-9248-BE79205C8EAF"}
 */
function onDataChangefecha() {
	// TODO Auto-generated method stub
	var agno = fecha_cfa.getFullYear();
	var a = new String()
	a = agno.toString()
	a= a.substr(2,2)
	var fech = utils.dateFormat(fecha_cfa,'dd-MM-yyyy')
	fecha_cfa = utils.parseDate(fech,'dd-MM-yyyy')	
	
	/*var rows = forms.FrmFacturasGC.foundset.GCtbfacturacabecera_to_tbfacturalinea.getSize();
	if(rows > 0)
	{
		for(var i=1;i<=rows;i++)
		{
			var record = forms.FrmFacturasGC.foundset.GCtbfacturacabecera_to_tbfacturalinea.getRecord(i);
			
			var fecha = record.fecha_lfa;
			if(fecha)
			{
				record.fecha_lfa = forms.FrmFacturasGC.foundset.fecha_cfa;
			}
			if(eje_cfa != a) 
			{		
				record.eje_lfa = a;				
			}
		}
		
		
		
	}*/
	eje_cfa = a;
}

/**
 * @AllowToRunInFind
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"694580CE-FBCC-4AD8-87E6-40671F482C04"}
 * @SuppressWarnings(deprecated)
 */
function btn_ContabilizarFacturas(event)
{
	if(globals.GCisEditing()) forms.FrmFacturasGC.btn_cancel()
	var popUpObj = plugins.window.createPopupMenu();
	var titulo = 'Asientos Conta AG Web';	
	titulo = titulo.toUpperCase()
	popUpObj.addMenuItem(titulo, globals.MenuFacturas, "media:///sm_earth.gif");
	titulo = 'Asientos Conta AG Win';	
	titulo = titulo.toUpperCase()
	popUpObj.addMenuItem(titulo, globals.MenuFacturas, "media:///LogoAGMin.gif");
	popUpObj.addSeparator();
	
	if (event.getSource()) {
		// display the popup over the component which is the source of the event
		popUpObj.show(event.getSource(),0,-75);				
	}
	
	
	
	//var query = 'select [EmpresaContable] from [ParametrosAplicacion]'
	//var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
	//var EC = dataset.getValue(1,1)
	/*var frm = currentcontroller.getName()
	var EC = gcparametrosaplicacion_to_parametrosaplicacion.empresacontable
	if(EC == null || EC == '')
	{
		globals.GCshowErrorDialog('No está definida la Empresa Contable en los Parametros de la Aplicación.',null,'Aceptar',null,null,null)
	}
	else
	{
		if(id)
		{
			if(frm == 'FrmFacturasGC')
			{
				forms.dlg_ActualizacionContableGC.DesdeEjer = forms.FrmFacturasGC.eje_cfa;
				forms.dlg_ActualizacionContableGC.HastaEjer = forms.FrmFacturasGC.eje_cfa;
				forms.dlg_ActualizacionContableGC.DesdeSer = forms.FrmFacturasGC.ser_cfa;
				forms.dlg_ActualizacionContableGC.HastaSer = forms.FrmFacturasGC.ser_cfa;
				forms.dlg_ActualizacionContableGC.DesdeNup = forms.FrmFacturasGC.nup_cfa;
				forms.dlg_ActualizacionContableGC.HastaNup = forms.FrmFacturasGC.nup_cfa;							
			}
			else
			{
				var A = new Date().getFullYear().toString()
				A = A.substr(2,4)
				forms.dlg_ActualizacionContableGC.DesdeEjer = A;
				forms.dlg_ActualizacionContableGC.HastaEjer = A;
				forms.dlg_ActualizacionContableGC.DesdeSer = '';
				forms.dlg_ActualizacionContableGC.HastaSer = '';
				forms.dlg_ActualizacionContableGC.DesdeNup = null;
				forms.dlg_ActualizacionContableGC.HastaNup = null;							
			}
			
			
			globals.GCshowDialogActualizacionContable('Actualización Contable',1,null,null,null,null,null,null,null,null)
		}
	}
	*/
}

/**
 * TODO generated, please specify type and doc for the params
 * @param v_event
 *
 * @SuppressWarnings(deprecated)
 *
 *
  * @SuppressWarnings(unused)
 *
 * @properties={typeid:24,uuid:"1A3D90C5-03C4-424B-8160-78F89265D485"}
 */
function handle_shortCut(v_event)
{
	var frm = currentcontroller.getName()
	if(frm == 'frm_nav_main_principalNGGC') {
		frm = forms.frm_nav_main_principalNGGC.elements.sidenav.containedForm;
	}
	globals.GCevento = null
	if(frm == 'FrmFacturasGC' && v_event.getType() == 'control F10')
	{
		if(globals.GCisEditing())
		{
			elements.situconta.bgcolor = '#feffe4'
			elements.situconta.readOnly = false
			elements.emailenviada.bgcolor = '#feffe4'
			elements.emailenviada.readOnly = false			
		}
	}
	else if(frm == 'FrmFacturasGC' && v_event.getType() == 'control E' && gcparametrosaplicacion_to_parametrosaplicacion.ticketbai == 1)
	{
		globals.GCshowExportacionDatosTBAI('Exportar Datos TBAI a .csv', 1, null, null, true, null, null, null, null, null);		
	}
	else if(frm == 'FrmFacturasGC' && v_event.getType() == 'control shift I' && gcparametrosaplicacion_to_parametrosaplicacion.ticketbai == 1)
	{
		globals.GCFormulario = null;
		globals.GCshowImportarDatosTBAI('Importar Datos TBAI desde .csv', 1, null, null, true, null, null, null, null, null);		
	}
	else if(frm == 'FrmFacturasGC' && v_event.getType() == 'control shift T' && 
			gcparametrosaplicacion_to_parametrosaplicacion.ticketbai == 1 && 
			application.getApplicationType() == APPLICATION_TYPES.SMART_CLIENT)
	{
		if(globals.GCisEditing())
		{
			mac = null;
			//ctbai = null;
			//cqr = null;
			//fechaenviofichero = null;
			//firmafactura = null;
			//fichero_respuesta_tbai = null;
		}
	}
	/*else if(frm == 'FrmFacturasGC' && v_event.getType() == 'control alt F12')
	{
		if(globals.GCisEditing())
		{
			elements.nup_cfa.visible = true
			elements.nup_cfa.bgcolor = '#feffe4'
			elements.nup_cfa.readOnly = false
		}
	}*/
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"0495CC37-FFA7-4895-A46B-D07900DD64A6"}
 */
function onActioniva1(event) {
	// TODO Auto-generated method stub
	elements.piva2_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"248B90D7-8508-4ED9-8BD3-EE62CDB97B92"}
 */
function onActioniva2(event) {
	// TODO Auto-generated method stub
	elements.piva3_cfa.requestFocus()
}

/**
 * Handle changed data.
 *
 * @properties={typeid:24,uuid:"C19AF4E4-6298-4A40-A84A-D198C60F0BCE"}
 */
function onDataChangefechacobro() {
	// TODO Auto-generated method stub
	if(fechcobro_cfa)
	{
		var fech = utils.dateFormat(fechcobro_cfa,'dd-MM-yyyy')
		fechcobro_cfa = utils.parseDate(fech,'dd-MM-yyyy')	
		
		if(fechcobro_cfa < fecha_cfa)
		{
			elements.fld_fechacobro_cfa.requestFocus()
			globals.GCshowErrorDialog('La fecha de cobro no puede ser inferior a la fecha Factura.',null,'Aceptar',null,null,null)			
		}
		else
		{
			if(GCtbfacturacabecera_to_tbmaestroclientes)
			{
				var clidiapago1 = GCtbfacturacabecera_to_tbmaestroclientes.diapago1;
				var clidiapago2 = GCtbfacturacabecera_to_tbmaestroclientes.diapago2;
				var clidiapago3 = GCtbfacturacabecera_to_tbmaestroclientes.diapago3;
				var diafechcobro = fechcobro_cfa.getDate()
				if(clidiapago1 != null && clidiapago1 != '')
				{
					if(diafechcobro != clidiapago1 && diafechcobro != clidiapago2 && diafechcobro != clidiapago3)
					{
						var d = clidiapago1;
						if(clidiapago2 != null && clidiapago2 != '')
						{
							d = d+' y el '+clidiapago2;
						}
						if(clidiapago3 != null && clidiapago3 != '')
						{
							d = d+' y el '+clidiapago3;
						}
						d = d+'. Cambie la fecha de cobro.'
						globals.GCshowInfoDialog('El cliente tiene días de pago el '+d, null, null, null, null, null)
						return
					}
				}
				var query = "select [fechapagos] from [tbMaestroClientesVacaciones] WHERE idcliente = "+clie_cfa+
					" and ('"+utils.dateFormat(fechcobro_cfa,'dd-MM-yyyy')+"' between [fechainicio] and [fechafin]) order by nperiodo"			
				var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1);
				var fechpagoscli = dataset.getValue(1,1);
				if(fechpagoscli)
				{
					fechcobro_cfa = fechpagoscli;
					globals.GCshowInfoDialog('La fecha de cobro introducida coincide con un periodo de Vacaciones del Cliente', null, null, null, null, null)
				}
			}			
		}
		
	}
}

/**
 * Handle changed data.
 *
 *
 * @properties={typeid:24,uuid:"BF2C4969-B7C2-4C80-ADC4-A2C23B3B1E36"}
 */
function onDataChangefechconta() {
	// TODO Auto-generated method stub
	if(situconta == 'C') 
	{
		elements.lblfechconta_cfa.visible = true;
		elements.fechconta_cfa.visible = true;
	}
	else
	{
		//fechconta_cfa = null
		elements.lblfechconta_cfa.visible = false;
		elements.fechconta_cfa.visible = false;
	}
	
}

/**
 * @properties={typeid:24,uuid:"224670D6-BD87-450F-9AFC-B99F809E9535"}
 */
function situcontacolor()
{
	if (situconta == 'C') {
	    elements.lblsituconta.fgcolor = '#00994C';
	} else {
		elements.lblsituconta.fgcolor = '#FF0000';
	} 
}

/**
 *
 * @properties={typeid:24,uuid:"599C1124-4983-44D2-97FB-A9727DDE7989"}
 */
function situcobrocolor()
{
	var situcob = SituacionCobro;
	if (situcob == 'NO COBRADA') {
	    elements.lblsitucobro.fgcolor = '#FF0000';
	} 
	else if (situcob == 'PARCIALMENTE COBRADA') {
	    elements.lblsitucobro.fgcolor = '#FF8000';
	} 
	else {
		elements.lblsitucobro.fgcolor = '#00994C';
	} 
}

/**
 *
 * @properties={typeid:24,uuid:"B0CDACA2-BDCA-4FE4-B2C2-9A2E7B35FC32"}
 */
function situFraEmail()
{
	if(GCtbfacturacabecera_to_tbmaestroclientes){
		if(GCtbfacturacabecera_to_tbmaestroclientes.envfraemail){
			elements.btn_sendEmail.visible = true
			elements.emailenviada.visible = true
			elements.btn_sendEmail.enabled = true
			elements.emailenviada.enabled = true
			elements.FraEmail.enabled = true
		}
		else{
			elements.btn_sendEmail.visible = false
			elements.emailenviada.visible = false
			elements.btn_sendEmail.enabled = false
			elements.emailenviada.enabled = false
			elements.FraEmail.enabled = false
		}
	}
	else{
		elements.btn_sendEmail.visible = false
		elements.emailenviada.visible = false
		elements.btn_sendEmail.enabled = false
		elements.emailenviada.enabled = false
		elements.FraEmail.enabled = false
	}
}

/**
*
*
*
 * @properties={typeid:24,uuid:"4495D00B-5451-4207-AC58-879911A6D2C6"}
 */
function ocultarcampos()
{
	if (ser_cfa == 'R') {
	    elements.fld_fraoriginal.visible = true;
	    elements.lbl_nfraoriginal.visible = true;
	    elements.fld_causarect.visible = true;
	    elements.lbl_causa.visible = true;	   	   
	} else {
		 elements.fld_fraoriginal.visible = false;
		 elements.lbl_nfraoriginal.visible = false;
		 elements.fld_causarect.visible = false;
		 elements.lbl_causa.visible = false;		
	} 
}

/**
 * @properties={typeid:24,uuid:"6CB5BA9C-DA2B-4DF6-9214-16C5F8DF7C02"}
 */
function notasclientes()
{
	if(clie_cfa && GCtbfacturacabecera_to_tbmaestroclientes)
	{
		if(GCtbfacturacabecera_to_tbmaestroclientes.tbmaestroclientes_to_tbmaestroclientesnotas &&
		GCtbfacturacabecera_to_tbmaestroclientes.tbmaestroclientes_to_tbmaestroclientesnotas.getSize() > 0)
		{
			elements.BtnNotasCliente.visible = true
		}
		else
		{
			elements.BtnNotasCliente.visible = false
		}
	}
	else
	{
		elements.BtnNotasCliente.visible = false
	}
}

/**
 * @properties={typeid:24,uuid:"B89F3B99-ADBF-4029-B51C-FA034F8EDE50"}
 */
function sub_asientos()
{
	if(globals.Empresa && globals.conexCONTA &&	globals.DesdeAsiento && globals.HastaAsiento)
	{
		globals.btn_runJasperReportDiarioAsientos()
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @AllowToRunInFind
 *
 * @properties={typeid:24,uuid:"05DA15E4-DF28-401B-9516-356F379DCBB0"}
 */
function btn_UltimaFactura(event) {
	// TODO Auto-generated method stub
	if(globals.GCisEditing()) btn_cancel()
	
		forms.lst_FacturasGC.foundset.loadAllRecords()
		forms.lst_FacturasGC.btn_sortDesc()
		if(controller.getSelectedIndex() != 1) controller.setSelectedIndex(1)
		if(forms.frm_nav_buttons_facturasGC.elements.btn_showAll.visible == true) 
		{
			forms.frm_nav_buttons_facturasGC.btn_showAll()
		}
	
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"A566031A-E930-4E2A-9D0B-F1F903752353"}
 * @SuppressWarnings(deprecated)
 */
function onActionDatosFactura(event) {
	// TODO Auto-generated method stub
	var frm = currentcontroller.getName()
	if(frm == 'frm_nav_main_principalNGGC') {
		frm = forms.frm_nav_main_principalNGGC.elements.sidenav.containedForm;
	}
	if(globals.GCisEditing()) forms[frm].btn_cancel()
	
	var query = "select NºEmpresa from ParametrosAplicacion where NºEmpresa = 1";
	if(globals.GCconex == null) var con = 'conexiongestioncomercialag'
	else con = globals.GCconex
	var dataset = databaseManager.getDataSetByQuery(con, query, null, 1)
	var emp = dataset.getValue(1,1);
	if(emp == null) 
	{
		forms.dlgDatosRegistro2GC.foundset.newRecord(true)
		    				
		forms.dlgDatosRegistro2GC.nºempresa = 1;
		forms.dlgDatosRegistro2GC.propiedad = 'AG Informática y Servicios S.A.'
		databaseManager.saveData()
	}
	forms.dlgDatosRegistro2GC.foundset.selectRecord(1)
	//start a transaction
	if(!globals.GCisEditing()) globals.GCstartEditing()
	
	globals.GCshowDialogDatosRegistro2('Datos del Registro Mercantil de la Sociedad', 1, null, null, true, null, null, null, null, null);
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"BCF7445A-FE01-42F5-B732-951886501BA1"}
 */
function btn_AddCliente(event) {
	// TODO Auto-generated method stub
	if(!globals.GCisEditing()) globals.GCstartEditing()	
	forms.dlg_ClientesGC.ClienteID = null;
	forms.dlg_ClientesGC.foundset.newRecord(true)
	forms.dlg_ClientesGC.id = application.getUUID()
	forms.dlg_ClientesGC.pais = 'ES'
	forms.dlg_ClientesGC.elements.idcodigo.editable = true
	forms.dlg_ClientesGC.elements.idcodigo.bgcolor = '#FFFF00'//'#ffffff'
	forms.dlg_ClientesGC.elements.idcodigo.visible = true
	forms.dlg_ClientesGC.elements.lblidcodigo.visible = false	
	forms.dlg_ClientesGC.elements.btn_print.enabled = false	
	forms.dlg_ClientesGC.elements.idcodigo.requestFocus()
	
	globals.GCshowDialogCliente('BD Cliente', 1, null, null, true, null, null, null, null, null);
}

/**
 * @AllowToRunInFind
 *
 *
 * @properties={typeid:24,uuid:"8123EF9C-04C2-4427-853D-1076DF207CD1"}
 */
function btn_DireccionFacturacion()
{
	if(globals.GCisEditing()) forms.FrmFacturasGC.btn_cancel()
	if(clie_cfa)
	{
		if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroclientesdirecfacturacion)
		{
			if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.gctbmaestroclientes_to_tbmaestroclientesdirecfacturacion.getSize() > 0)
			{
				forms.dlg_ClientesDireccionFacturacionGC.foundset.loadAllRecords()
				var result = forms.dlg_ClientesDireccionFacturacionGC.foundset.selectRecord(clie_cfa)
				var fsCount = databaseManager.getFoundSetCount(forms.dlg_ClientesDireccionFacturacionGC.foundset);
				while(result==false)
				{
					if(fsCount == forms.dlg_ClientesDireccionFacturacionGC.foundset.getSize()) return;
					forms.dlg_ClientesDireccionFacturacionGC.foundset.setSelectedIndex(forms.dlg_ClientesDireccionFacturacionGC.foundset.getSize());
					result = forms.dlg_ClientesDireccionFacturacionGC.foundset.selectRecord(clie_cfa);
				}
				//start a transaction
				if(!globals.GCisEditing()) globals.GCstartEditing()
			    //setup the method to execute when the dialog closes
				globals.GCdialog_performMethod = 'forms.FrmFacturasGC.sub_deleteDireccion()'
				
				//show the "fake" dialog
				globals.GCshowDialogClientesDireccionFacturacion('Editar Dirección', 1, null, null, true, 'Borrar Dirección', null, null, null, null);
			}
			else
			{
				if(clie_cfa)
				{
					if(!globals.GCisEditing()) 
					{	
						globals.GCstartEditing()
				
						//make a new record
						forms.dlg_ClientesDireccionFacturacionGC.foundset.newRecord(true)
					
						forms.dlg_ClientesDireccionFacturacionGC.idcliente = clie_cfa;
						forms.dlg_ClientesDireccionFacturacionGC.cif = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.cif;
						forms.dlg_ClientesDireccionFacturacionGC.razonsocial = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.desccliente;
						forms.dlg_ClientesDireccionFacturacionGC.direccionfiscal = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.direccion;
						forms.dlg_ClientesDireccionFacturacionGC.poblacion = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.poblacion;
						forms.dlg_ClientesDireccionFacturacionGC.provincia = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.provincia;			
						forms.dlg_ClientesDireccionFacturacionGC.codpostal = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal;			
						forms.dlg_ClientesDireccionFacturacionGC.pais = forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.GCtbmaestroclientes_to_pais.pai_nombre;
						
					
						//databaseManager.saveData();
					
						//show the "fake" dialog
						globals.GCshowDialogClientesDireccionFacturacion('Nueva Dirección', null, null, null, null, null, null, null, null, null);
					
						//go first field
						forms.dlg_ClientesDireccionFacturacionGC.elements.cif.requestFocus();
					}
				}
			}
		}
	}
}

/**
 *
 * @properties={typeid:24,uuid:"375CB6F9-9FA5-4AA0-BA9C-DB86CB5170DC"}
 */
function sub_deleteDireccion()
{
	if(globals.GCdialog_buttonPressed == 'Borrar Dirección')
	{
		//check to make sure that the address in question isn't used on any orders
		/*var bAdrCnt = addresses_to_orders_billing.getSize()
		var sAdrCnt = addresses_to_orders_shipping.getSize()

		if(bAdrCnt == 0 && sAdrCnt == 0)
		{*/
			forms.dlg_ClientesDireccionFacturacionGC.foundset.deleteRecord()
		/*}
		else
		{
			//there are orders that use this address
			var msg = 'There are orders that use this address as a shipping or billing address.' +
			' Change the orders to a new address, then you can delete this address.'
			globals.GCshowErrorDialog(msg,'forms.frm_company.sub_showCompanyOrders()','OK', null, null, null)
		}*/
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"E5A00845-E992-4943-A029-26CD90B137D3"}
 */
function onActionpirpf(event) {
	onFocusLostgtosfinan(event)
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"AC695A83-510F-4853-B71F-FD92A6DDF65D"}
 */
function onActionfraoriginal(event) {
	elements.fld_causarect.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"CDEE4F7A-6372-450C-90FA-F16695B4E8AF"}
 */
function onActioncausa(event) {
	elements.fld_fechacobro_cfa.requestFocus()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 *
 * @properties={typeid:24,uuid:"0A4C31CE-E01C-489E-9EA6-4D254449182C"}
 */
function btngooglemaps(event) {
	// TODO Auto-generated method stub
	if(GCtbfacturacabecera_to_tbmaestroclientes && GCtbfacturacabecera_to_tbmaestroclientes.direccion)
	{
		var dir = utils.stringReplace(GCtbfacturacabecera_to_tbmaestroclientes.direccion,' ','+')
		var pob = utils.stringReplace(GCtbfacturacabecera_to_tbmaestroclientes.poblacion,' ','+')
		application.showURL( 'https://maps.google.com/maps?q=' + dir + ','+pob,'_blank' );
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"EAB8B6AD-F37B-404C-A47B-1AFF0D25F386"}
 * @SuppressWarnings(unused)
 * @SuppressWarnings(deprecated)
 */
function btn_actCobros(event) {
	//var frm = currentcontroller.getName()
	if(globals.GCisEditing()) forms.FrmFacturasGC.btn_cancel()
	if(id)
	{
		forms.dlg_ActualizacionCarteraCobrosGC.DesdeEjer=forms.FrmFacturasGC.eje_cfa;
		forms.dlg_ActualizacionCarteraCobrosGC.HastaEjer=forms.FrmFacturasGC.eje_cfa;
		forms.dlg_ActualizacionCarteraCobrosGC.DesdeSer=forms.FrmFacturasGC.ser_cfa;
		forms.dlg_ActualizacionCarteraCobrosGC.HastaSer=forms.FrmFacturasGC.ser_cfa;
		forms.dlg_ActualizacionCarteraCobrosGC.DesdeNup=forms.FrmFacturasGC.nup_cfa;
		forms.dlg_ActualizacionCarteraCobrosGC.HastaNup=forms.FrmFacturasGC.nup_cfa;	
		globals.GCshowDialogActualizacionCarteraCobros('Actualización Cartera de Cobros',1,null,null,null,null,null,null,null,null)
	}
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"EDD95E44-41B4-49AF-8910-6A4BB9E633E5"}
 */
function btn_addobservacion(event) {
	// TODO Auto-generated method stub
	/*if(obse_cfa)
	{
		var query = "select id from [tbmaestroobservaciones] where [descripcion] ='"+ obse_cfa +"'"
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
		
		var uuid = dataset.getValue(1,1);
		
		if(!uuid)
		{
			forms.FrmObservacionGC.foundset.newRecord(true)
			forms.FrmObservacionGC.validate_autoEnter()
			forms.FrmObservacionGC.descripcion = obse_cfa;
			
			var bool = databaseManager.saveData(forms.FrmObservacionGC.foundset)
			
			if(bool == true) globals.GCshowInfoDialog('Observación añadida correctamente a la Base de Datos.',null,'Aceptar',null,null,null)
		}		
	}*/
	if(!globals.GCisEditing()) globals.GCstartEditing()
	forms.dlg_ObservacionesGC.foundset.newRecord(true)
	forms.dlg_ObservacionesGC.validate_autoEnter()
	if(obse_cfa)
	{
		var query = "select id from [tbmaestroobservaciones] where [descripcion] ='"+ obse_cfa +"'"
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)		
		var uuid = dataset.getValue(1,1);		
		if(!uuid)
		{
			forms.dlg_ObservacionesGC.descripcion = obse_cfa;
		}
	}
	
	//show the "fake" dialog
	globals.GCshowDialogObserv('Nueva Observación', null, null, null, null, null, null, null, null, null);

	//go first field
	forms.dlg_ObservacionesGC.controller.focusFirstField()
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 *
 * @properties={typeid:24,uuid:"DDCE2723-F74D-448A-8B8A-37E5C3553DF2"}
 */
function btn_addFP(event) {
	// TODO Auto-generated method stub
	if(!globals.GCisEditing()) globals.GCstartEditing()
	forms.dlg_FormaPagoGC.foundset.newRecord(true)
	forms.dlg_FormaPagoGC.validate_autoEnter()
	if(!cfpa_cfa && desccfpa_cfa)
	{
		forms.dlg_FormaPagoGC.denom_fp = desccfpa_cfa;		
	}
	
	//show the "fake" dialog
	globals.GCshowDialogFP('Nueva Forma de Pago', null, null, null, null, null, null, null, null, null);

	//go first field
	forms.dlg_FormaPagoGC.controller.focusFirstField()
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"69B0E4B5-A2D0-438A-B1D2-C924EB7BFE43"}
 */
function onActionTicketBAIQR(event) {
	if(/*mac &&*/ fechaenviofichero && cqr) application.showURL(cqr,'_blank')
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @properties={typeid:24,uuid:"938C1608-5FA7-4EF4-98AE-A9F8D7C53C3B"}
 */
function onActionExportarFacturaE(event) {
	/*if(id && GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0){
		forms.dlg_ExportarFacturasFacturaEGC.DesdeEje = eje_cfa
		forms.dlg_ExportarFacturasFacturaEGC.HastaEje = eje_cfa
		forms.dlg_ExportarFacturasFacturaEGC.DesdeSer = ser_cfa
		forms.dlg_ExportarFacturasFacturaEGC.HastaSer = ser_cfa
		forms.dlg_ExportarFacturasFacturaEGC.DesdeNup = nup_cfa
		forms.dlg_ExportarFacturasFacturaEGC.HastaNup = nup_cfa
		forms.dlg_ExportarFacturasFacturaEGC.DesdeCliente = null
		forms.dlg_ExportarFacturasFacturaEGC.DescDesdeCliente = null
		//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeDesdeCliente()
		forms.dlg_ExportarFacturasFacturaEGC.HastaCliente = null
		forms.dlg_ExportarFacturasFacturaEGC.HastaDescCliente = null
		//forms.dlg_ImpresionFacturasTBAIGC.onDataChangeHastaCliente()
		globals.GCshowDialogExportarFacturasFacturaE('Exportar Facturas formato FacturaE',1,null,null,null,null,null,null,null,null)
	}*/
	if(id && eje_cfa && nup_cfa && GCtbfacturacabecera_to_tbfacturalinea.getSize() > 0)
	{
		if(gcparametrosaplicacion_to_parametrosaplicacion.facturae)
		{
			GenerarXML32(eje_cfa,ser_cfa,nup_cfa,eje_cfa,ser_cfa,nup_cfa,clie_cfa,clie_cfa)
		}
		else
		{
			globals.GCshowErrorDialog('Este usuario no tiene permiso para exportar facturas a formato FacturaE!\n\nPóngase en contacto con el Administrador', null, null, null, null, null)
		}
	}
}

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} DEJE
 * @param {String} DSER
 * @param {Number} DNUP
 * @param {Number} HEJE
 * @param {String} HSER
 * @param {Number} HNUP
 * @param {Number} DCLI
 * @param {Number} HCLI
 *
 * @properties={typeid:24,uuid:"B5618B3E-1254-4162-883E-3BB3F64A429E"}
 */
function GenerarXML32(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)
{
	try
	{
		application.output('Inicio XML')
		var ok = null;
		nfacturas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)	
		/*query = "select count(*),isnull(sum(impnee_cfa),0) from tbfacturacabecera "+
				"WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
			     " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
			     "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
			     "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
			     "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
			     " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
			     "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+")";
		var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
		var numfacturas = dataset2.getValue(1,1);
		var sumfacturas = dataset2.getValue(1,2);*/
		
		var query = "SELECT ParametrosAplicacion.NºEmpresa,ParametrosAplicacion.Propiedad,"+
	     "ParametrosAplicacion.Empresa,ParametrosAplicacion.CodPostal,"+
	     "ParametrosAplicacion.Direccion,ParametrosAplicacion.Poblacion,"+
	     "ParametrosAplicacion.Provincia,ParametrosAplicacion.CIF,"+
	     "ParametrosAplicacion.Telefono,ParametrosAplicacion.Fax,"+
	     "ParametrosAplicacion.Mail,ParametrosAplicacion.Web,"+
	     "ParametrosAplicacion.Logo,ParametrosAplicacion.Logo2,"+
	     "ParametrosAplicacion.TelAux,ParametrosAplicacion.CtaBancaria,"+
	     "ParametrosAplicacion.Registro,ParametrosAplicacion.Tomo,"+
	     "ParametrosAplicacion.Folio,ParametrosAplicacion.HojaRegistral,"+
	     "ParametrosAplicacion.pais,"+
	     "tbFacturaCabecera.ID,tbFacturaCabecera.eje_cfa,"+
	     "tbFacturaCabecera.ser_cfa,tbFacturaCabecera.nup_cfa,"+
	     "tbFacturaCabecera.fecha_cfa,tbFacturaCabecera.fechcobro_cfa,"+
	     "tbFacturaCabecera.fechconta_cfa,tbFacturaCabecera.clie_cfa,"+
	     "tbFacturaCabecera.cfpa_cfa,tbFacturaCabecera.desccfpa_cfa,"+
	     "tbFacturaCabecera.repr_cfa,tbFacturaCabecera.obse_cfa,"+
	     "tbFacturaCabecera.fenvio,tbFacturaCabecera.situconta,"+
	     "tbFacturaCabecera.situ,tbFacturaCabecera.impbre_cfa,"+
	     "tbFacturaCabecera.depp_cfa,tbFacturaCabecera.pgfi_cfa,"+
	     "tbFacturaCabecera.impbie_cfa,tbFacturaCabecera.piva_cfa,"+
	     "tbFacturaCabecera.cuotaiva_cfa,tbFacturaCabecera.impbie2_cfa,"+
	     "tbFacturaCabecera.piva2_cfa,tbFacturaCabecera.cuotaiva2_cfa,"+
	     "tbFacturaCabecera.impbie3_cfa,tbFacturaCabecera.piva3_cfa,"+
	     "tbFacturaCabecera.cuotaiva3_cfa,tbFacturaCabecera.impnee_cfa,"+
	     "tbFacturaCabecera.gtosfinan_cfa,tbFacturaCabecera.impgtosfinan,"+
	     "tbFacturaCabecera.impre,tbFacturaCabecera.impre2,"+
	     "tbFacturaCabecera.impre3,tbFacturaLinea.ID,tbFacturaLinea.eje_lfa,"+
	     "tbFacturaLinea.ser_lfa,tbFacturaLinea.nup_lfa,tbFacturaLinea.nli_lfa,"+
	     "tbFacturaLinea.nalb_lfa,tbFacturaLinea.lalb_lfa,"+
	     "tbFacturaLinea.ref_lfa,tbFacturaLinea.concep_lfa,"+
	     "tbFacturaLinea.cant1_lfa,tbFacturaLinea.prec_lfa,"+
	     "tbFacturaLinea.unme_lfa,tbFacturaLinea.piva_lfa,"+
	     "tbFacturaLinea.dto_lfa,tbFacturaLinea.impdto_lfa,"+
	     "tbFacturaLinea.clie_lfa,tbFacturaLinea.situ_lfa,"+
	     "tbFacturaLinea.precuni_lfa,tbFacturaLinea.impor_lfa,"+
	     "tbFacturaLinea.importot_lfa,tbFacturaLinea.fecha_lfa,"+
	     "tbFacturaLinea.nprograma_lfa,tbMaestroClientes.ID,"+
	     "tbMaestroClientes.IdCliente,tbMaestroClientes.DescCliente,"+
	     "tbMaestroClientes.Direccion,tbMaestroClientes.Poblacion,"+
	     "tbMaestroClientes.Provincia,tbMaestroClientes.CodPostal,"+
	     "tbMaestroClientes.RazonSocial,tbMaestroClientes.PersContacto,"+
	     "tbMaestroClientes.EmailContacto,tbMaestroClientes.Telf1,"+
	     "tbMaestroClientes.Telf2,tbMaestroClientes.Fax,"+
	     "tbMaestroClientes.CIF,tbMaestroClientes.NumProveedor,"+
	     "tbMaestroClientes.CuentaContable,tbMaestroClientes.IdFormaPago,"+
	     "tbMaestroClientes.TipoIva,tbMaestroClientes.IdMoneda,"+
	     "tbMaestroClientes.DiaPago1,tbMaestroClientes.DiaPago2,tbMaestroClientes.DiaPago3,"+
	     "tbMaestroClientes.Pais,tbMaestroClientes.Observaciones,"+
	     "tbMaestroClientes.CodigoBanco,tbMaestroClientes.CodigoSucursal,"+
	     "tbMaestroClientes.Codigo1DC,tbMaestroClientes.CodigoCuenta,"+
	     "tbMaestroArticulos.RefCliente,tbMaestroformpago.denom_fp,ParametrosAplicacion.bic "+
	     "FROM tbFacturaCabecera tbFacturaCabecera LEFT JOIN dbo.tbFacturaLinea tbFacturaLinea ON "+
		 "tbFacturaCabecera.eje_cfa = tbFacturaLinea.eje_lfa "+
	     "AND tbFacturaCabecera.nup_cfa = tbFacturaLinea.nup_lfa "+
	     "AND tbFacturaCabecera.ser_cfa = tbFacturaLinea.ser_lfa "+
	     "LEFT JOIN dbo.tbMaestroClientes tbMaestroClientes ON "+
		 "tbFacturaCabecera.clie_cfa = tbMaestroClientes.IdCliente "+
	     "LEFT JOIN dbo.tbMaestroformpago tbMaestroformpago ON "+
		 "tbFacturaCabecera.cfpa_cfa = tbMaestroformpago.codig_fp "+
	     "LEFT JOIN dbo.tbMaestroArticulos tbMaestroArticulos ON "+
		 "tbFacturaLinea.ref_lfa = tbMaestroArticulos.Codigo,"+
	     "dbo.ParametrosAplicacion ParametrosAplicacion "+
	     "WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
	     " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
	     "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
	     "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
	     "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
	     " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
	     "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+") "+
	     "ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
	     "tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,99999999)
		if(dataset.getMaxRowIndex() > 0)
		{					
			/*var cifempresa = dataset.getValue(1,8);
			var tipopersona = TipoPersona(cifempresa);					
			var pais = dataset.getValue(1,21);
			var razonsocial = dataset.getValue(1,3);
			var regmercantil = dataset.getValue(1,17);
			var hoja = dataset.getValue(1,20);
			var folio = dataset.getValue(1,19);
			var seccion = '';
			var tomo = dataset.getValue(1,18);
			var direccion = dataset.getValue(1,5);
			var codigopostal = dataset.getValue(1,4);
			var ciudad = dataset.getValue(1,6);
			var provincia = dataset.getValue(1,7);
			var telefono = dataset.getValue(1,9);
			var fax = dataset.getValue(1,10);
			var web = dataset.getValue(1,12);
			var correo = dataset.getValue(1,11);
			var primerafactura = DEJE.toString() + utils.numberFormat(DNUP,'00000') + DSER;
			var ultimafactura = HEJE.toString() + utils.numberFormat(HNUP,'00000') + HSER;
			var cifcliente = dataset.getValue(1,90);
			var tipopersonacliente = TipoPersona(cifcliente)	
			var paiscliente = dataset.getValue(1,99);
			//var contactocliente = dataset.getValue(1,85);
			var desccliente = dataset.getValue(1,79);
			var direccioncliente = dataset.getValue(1,80);
			var poblacioncliente = dataset.getValue(1,81);
			var provinciacliente = dataset.getValue(1,82);
			var codpostalcliente = dataset.getValue(1,83);
			var razonsocialcliente = dataset.getValue(1,84);
			var fechacobro = dataset.getValue(1,27);
			//var formapago = dataset.getValue(1,30);
			var cuentaabono = dataset.getValue(1,16);
			var bic = dataset.getValue(1,107);
			*/
			datosempresa(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)
			//query = "select pai_iso3 from pais where pai_iso2 ='"+paiscliente+"'";				
			//var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
			//var paisclienteiso3 = dataset2.getValue(1,1)
			
			getpaiso3()
						
			var xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
			application.output('Cabecera')
			Document = <Facturae/>
			var ns = new Namespace('fe',"http://www.facturae.es/Facturae/2009/v3.2/Facturae")
			Document.addNamespace(ns)							
			
			ns = new Namespace('ds','http://www.w3.org/2000/09/xmldsig#')
			Document.addNamespace(ns)
			//var Document = <Facturae xmlns:ds="http://www.w3.org/2000/09/xmldsig#"/>
			//var ns = new Namespace('xs','http://www.w3.org/2001/XMLSchema')
			//Document.addNamespace(ns)		
			FileHeader = <FileHeader/>//Cabecera del fichero xml
				SchemaVersion = <SchemaVersion/>
				//Código que indica versión utilizada. Existirá compatibilidad de versiones.
				SchemaVersion.appendChild('3.2')
				var Modality = <Modality/>
					//Modalidad. Individual o Lote. Si es "individual" (I) los
					//importes de los campos del grupo Batch coincidirán con sus
					//correspondientes campos del grupo InvoiceTotals y el
					//campo InvoicesCount tendrá siempre el valor "1". Si es
					//"lote" (L), el valor del campo InvoicesCount será siempre	> "1".
				if(numerofacturas > 1) Modality.appendChild('L')
				else if(numerofacturas == 1) Modality.appendChild('I')
				InvoiceIssuerType = <InvoiceIssuerType/>
					//Tipo Emisor Factura. Puede tomar 3 valores (EM, RE y TE), 
					// que se describen como “Proveedor (antes denominado emisor)”,
					// “Destinatario (antes denominado cliente o receptor)” y 
					// “Tercero”, respectivamente. 
					// Si toma el valor "TE" el grupo ThirdParty será obligatorio 
					// cumplimentarlo en todos sus apartados.*/
				//InvoiceIssuerType.appendChild('RE') 
				InvoiceIssuerType.appendChild('RE') 
				/*var ThirdParty = <ThirdParty/>
					 var TaxIdentification = <TaxIdentification/>
					 //Identificación fiscal.
					 	var PersonTypeCode = <PersonTypeCode/>
					 		PersonTypeCode.appendChild(tipopersona)
						var ResidenceTypeCode = <ResidenceTypeCode/>
					 		ResidenceTypeCode.appendChild('R')
						var TaxIdentificationNumber = <TaxIdentificationNumber/>
					 		TaxIdentificationNumber.appendChild(pais + cifempresa)						 		
						TaxIdentification.appendChild(PersonTypeCode)
					    TaxIdentification.appendChild(ResidenceTypeCode)
						TaxIdentification.appendChild(TaxIdentificationNumber)
						var LegalEntity = <LegalEntity/>
							//Persona jurídica y otras.
								var CorporateName = <CorporateName/>
								//Razón Social.
								CorporateName.appendChild(razonsocial)
								var TradeName = <TradeName/>
								//Nombre Comercial.
								var RegistrationData = <RegistrationData/>
								//Datos Registrales: Inscripción Registro, Tomo, Folio,…
									var Book = <Book/>
									//Libro
									Book.appendChild('')
									var RegisterOfCompaniesLocation = <RegisterOfCompaniesLocation/>
									// Registro Mercantil.
									RegisterOfCompaniesLocation.appendChild(utils.stringLeft(regmercantil,20));
									var Sheet = <Sheet/>
									//Hoja
									Sheet.appendChild(utils.stringLeft(hoja, 20))
									var Folio = <Folio/>
									//Folio
									Folio.appendChild(utils.stringLeft(folio,20))
									var Section = <Section/>
									//Sección.
									Section.appendChild(utils.stringLeft(seccion,20))
									var Volume = <Volume/>
									//Tomo
									Volume.appendChild(utils.stringLeft(tomo,20))
									var AdditionalRegistrationData = <AdditionalRegistrationData/>
									//Otros datos registrales.
									
									RegistrationData.appendChild(Book)
									RegistrationData.appendChild(RegisterOfCompaniesLocation)
									RegistrationData.appendChild(Sheet)
									RegistrationData.appendChild(Folio)
									RegistrationData.appendChild(Section)
									RegistrationData.appendChild(Volume)
									RegistrationData.appendChild(AdditionalRegistrationData)
								var AddressInSpain = <AddressInSpain/>
								//Dirección Nacional. Dirección en España.
									var Address = <Address/>
									//Dirección. Tipo de vía, nombre, número, piso…
									Address.appendChild(utils.stringLeft(direccion, 80))
									var PostCode = <PostCode/>
									//Código Postal asignado por Correos.
									PostCode.appendChild(utils.stringLeft(codigopostal, 5))
									var Town = <Town/>
									//Población. Correspondiente al C.P.
									Town.appendChild(utils.stringLeft(ciudad, 50))
									var Province = <Province/>
									//Provincia. Donde está situada la Población.
									Province.appendChild(utils.stringLeft(provincia, 20))
									var CountryCode = <CountryCode/>
									CountryCode.appendChild('ESP')											
									AddressInSpain.appendChild(Address)
									AddressInSpain.appendChild(PostCode)
									AddressInSpain.appendChild(Town)
									AddressInSpain.appendChild(Province)
									AddressInSpain.appendChild(CountryCode)										
									var ContactDetails = <ContactDetails/>
										//Datos de contacto.
										var Telephone = <Telephone/>
										//Teléfono. Número de teléfono completo con prefijos del país.
										Telephone.appendChild(utils.stringLeft(('+34'+telefono), 15))
										var TeleFax = <TeleFax/>
										//Teléfono. Número de teléfono completo con prefijos del país.
										if(fax) TeleFax.appendChild(utils.stringLeft(('+34'+fax), 15))											
										var WebAddress = <WebAddress/>
										//Página web. URL de la dirección de Internet.
										WebAddress.appendChild(utils.stringLeft(web, 60))
										var ElectronicMail = <ElectronicMail/>
										//Correo electrónico. Dirección de correo electrónico.
										ElectronicMail.appendChild(utils.stringLeft(correo, 60))
										ContactDetails.appendChild(Telephone)
										ContactDetails.appendChild(TeleFax)
										ContactDetails.appendChild(WebAddress)
										ContactDetails.appendChild(ElectronicMail)										
								LegalEntity.appendChild(CorporateName)
								LegalEntity.appendChild(TradeName)
								LegalEntity.appendChild(RegistrationData)
								LegalEntity.appendChild(AddressInSpain)		
								LegalEntity.appendChild(ContactDetails)								
					 ThirdParty.appendChild(TaxIdentification)
					 ThirdParty.appendChild(LegalEntity)*/
					 var Batch = <Batch/>
					 		BatchIdentifier = <BatchIdentifier/>
					 		//Identificador del lote. Concatenación del nº de documento del emisor con
					 		//  el número de la primera factura y el número de serie caso de existir.*/
					 		BatchIdentifier.appendChild(utils.stringLeft((primerafactura+ultimafactura), 70))
					 		InvoicesCount = <InvoicesCount/>
					 		//Número total de facturas. Refleja, cuando es lote, el número de facturas 
					 		// del mismo. Siempre será valor "1" cuando el campo Modality (Modalidad)
					 		// tenga el valor "I".*/
					 		InvoicesCount.appendChild(numerofacturas)
							TotalInvoicesAmount = <TotalInvoicesAmount/>
					 		//Total facturas. Suma de los importes InvoiceTotal del Fichero. Este importe
					 		// lo es a efectos de total de factura y fiscales, sin tener en cuenta subvenciones,
					 		// anticipos y/o retenciones que pudieran haberse practicado.*/
					 		 	TotalAmount = <TotalAmount/>
					 		 	TotalAmount.appendChild(sumafacturas.toFixed(2))
							TotalInvoicesAmount.appendChild(TotalAmount)
							TotalOutstandingAmount = <TotalOutstandingAmount/>
					 		//Total a pagar. Suma de los importes TotalOutstandingAmount del Fichero, 
					 		// hasta ocho decimales. Es el importe que efectivamente se adeuda, una vez 
					 		// descontados los anticipos y sin tener en cuenta las retenciones.*/
								TotalAmount = <TotalAmount/>
					 		 	TotalAmount.appendChild(sumafacturas.toFixed(2))
							TotalOutstandingAmount.appendChild(TotalAmount)
							TotalExecutableAmount = <TotalExecutableAmount/>
					 		//Total a Ejecutar. Sumatorio de las diferencias de los importes 
					 		// (TotalOutstandingAmount y WithholdingAmount) del fichero = Sumatorio de los Importes
					 		// TotalExecutableAmount, hasta ocho decimales. Es el importe que se adeuda minorado 
					 		// en un posible importe retenido en garantía de cumplimientos contractuales.*/
								TotalAmount = <TotalAmount/>
					 		 	TotalAmount.appendChild(sumafacturas.toFixed(2))
							TotalExecutableAmount.appendChild(TotalAmount)
							InvoiceCurrencyCode = <InvoiceCurrencyCode/>
							//Código ISO 4217:2001 Alpha-3 de la moneda en la que se emite la factura. 
							// Si difiere de la moneda EURO o del campo ExchangeRateDetails será obligatorio 
							// indicar el contravalor y el tipo/fecha de cambio para los campos de base imponible 
							// y cuota, retenida como repercutida, así como en los totales TotalInvoicesAmount, 
							// TotalOutstandingAmount, y TotalExecutableAmount.*/
							InvoiceCurrencyCode.appendChild('EUR')
							Batch.appendChild(BatchIdentifier)
							Batch.appendChild(InvoicesCount)
							Batch.appendChild(TotalInvoicesAmount)
							Batch.appendChild(TotalOutstandingAmount)
							Batch.appendChild(TotalExecutableAmount)
							Batch.appendChild(InvoiceCurrencyCode)						
				FileHeader.appendChild(SchemaVersion)
				FileHeader.appendChild(Modality)
				FileHeader.appendChild(InvoiceIssuerType)
				//FileHeader.appendChild(ThirdParty)	
				FileHeader.appendChild(Batch)	
				//Document.appendChild(FileHeader)
				Parties = <Parties/>
				application.output('Vendedor')
				//Sujetos - Datos del emisor y receptor de la factura*/
					SellerParty = <SellerParty/>
					//Emisor. Datos básicos del fichero. Son comunes a la factura o facturas que se incluyen.*/
						TaxIdentification = <TaxIdentification/>
						//Identificación fiscal.
						PersonTypeCode = <PersonTypeCode/>
				 		//Tipo de persona. Física o Jurídica. "F" - Física; "J" - Jurídica.*/
				 		PersonTypeCode.appendChild(tipopersona)
				 		ResidenceTypeCode = <ResidenceTypeCode/>
				 		//Identificación del tipo de residencia y/o extranjería. "E" - Extranjero; 
				 		// * "R" - Residente; "U" - Residente en la Unión Europea.*/
				 		ResidenceTypeCode.appendChild('R')
					    TaxIdentificationNumber = <TaxIdentificationNumber/>
				 		//Código de Identificación Fiscal del sujeto. Se trata de las composiciones 
				 		// *de NIF/CIF que marca la Administración correspondiente (precedidas de las 
				 		// *dos letras del país en el caso de operaciones intracomunitarias, es decir, 
				 		// *cuando comprador y vendedor tienen domicilio fiscal en estados miembros de la UE 
				 		// *distintos).*/
						if(utils.stringLeft(cifempresa,2) == pais) TaxIdentificationNumber.appendChild(cifempresa)
						else TaxIdentificationNumber.appendChild(pais+cifempresa)					 		
					TaxIdentification.appendChild(PersonTypeCode)
				    TaxIdentification.appendChild(ResidenceTypeCode)
					TaxIdentification.appendChild(TaxIdentificationNumber)
					LegalEntity = <LegalEntity/>
							//Persona jurídica y otras.
								CorporateName = <CorporateName/>
								//Razón Social.
								CorporateName.appendChild(razonsocial)
								//var TradeName = <TradeName/>
								//Nombre Comercial.
								RegistrationData = <RegistrationData/>
								//Datos Registrales: Inscripción Registro, Tomo, Folio,…
									Book = <Book/>
									//Libro
									var libro = ''
									Book.appendChild(libro)
									RegisterOfCompaniesLocation = <RegisterOfCompaniesLocation/>
									// Registro Mercantil.
									RegisterOfCompaniesLocation.appendChild(utils.stringLeft(regmercantil,20));
									Sheet = <Sheet/>
									//Hoja
									Sheet.appendChild(utils.stringLeft(hoja, 20))
									Folio = <Folio/>
									//Folio
									Folio.appendChild(utils.stringLeft(folio,20))
									Section = <Section/>
									//Sección.
									Section.appendChild(utils.stringLeft(seccion,20))
									Volume = <Volume/>
									//Tomo
									Volume.appendChild(utils.stringLeft(tomo,20))
									AdditionalRegistrationData = <AdditionalRegistrationData/>
									//Otros datos registrales.
									AdditionalRegistrationData.appendChild('Sin Datos')
									
									if(libro) RegistrationData.appendChild(Book)
									if(regmercantil) RegistrationData.appendChild(RegisterOfCompaniesLocation)
									if(hoja) RegistrationData.appendChild(Sheet)
									if(folio) RegistrationData.appendChild(Folio)
									if(seccion) RegistrationData.appendChild(Section)
									if(tomo) RegistrationData.appendChild(Volume)
									RegistrationData.appendChild(AdditionalRegistrationData)
								AddressInSpain = <AddressInSpain/>
								//Dirección Nacional. Dirección en España.
								Address = <Address/>
								//Dirección. Tipo de vía, nombre, número, piso…
								Address.appendChild(utils.stringLeft(direccion, 80))
								PostCode = <PostCode/>
								//Código Postal asignado por Correos.
								PostCode.appendChild(utils.stringLeft(codigopostal, 5))
								Town = <Town/>
								//Población. Correspondiente al C.P.
								Town.appendChild(utils.stringLeft(ciudad, 50))
								Province = <Province/>
								//Provincia. Donde está situada la Población.
								Province.appendChild(utils.stringLeft(provincia, 20))
								CountryCode = <CountryCode/>
								//Código País. Código según la ISO 3166-1:2006 Alpha-3.
								//Al ser un domicilio ubicado en España siempre será "ESP".*/
								CountryCode.appendChild('ESP')											
								AddressInSpain.appendChild(Address)
								AddressInSpain.appendChild(PostCode)
								AddressInSpain.appendChild(Town)
								AddressInSpain.appendChild(Province)
								AddressInSpain.appendChild(CountryCode)										
								ContactDetails = <ContactDetails/>
								//Datos de contacto.
									Telephone = <Telephone/>
									//Teléfono. Número de teléfono completo con prefijos del país.
									Telephone.appendChild(utils.stringLeft(('+34'+telefono), 15))
									TeleFax = <TeleFax/>
									//Teléfono. Número de teléfono completo con prefijos del país.
									if(fax) TeleFax.appendChild(utils.stringLeft(('+34'+fax), 15))											
									WebAddress = <WebAddress/>
									//Página web. URL de la dirección de Internet.
									WebAddress.appendChild(utils.stringLeft(web, 60))
									ElectronicMail = <ElectronicMail/>
									//Correo electrónico. Dirección de correo electrónico.
									ElectronicMail.appendChild(utils.stringLeft(correo, 60))
									if(telefono) ContactDetails.appendChild(Telephone)
									if(fax) ContactDetails.appendChild(TeleFax)
									if(web) ContactDetails.appendChild(WebAddress)
									if(correo) ContactDetails.appendChild(ElectronicMail)										
							LegalEntity.appendChild(CorporateName)
							//LegalEntity.appendChild(TradeName)
							LegalEntity.appendChild(RegistrationData)
							LegalEntity.appendChild(AddressInSpain)		
							LegalEntity.appendChild(ContactDetails)	
					
					
					
					
					
					SellerParty.appendChild(TaxIdentification)
					SellerParty.appendChild(LegalEntity)
					Parties.appendChild(SellerParty)
					//Document.appendChild(Parties)
					
							
							application.output('Comprador')
							BuyerParty = <BuyerParty/>
								application.output('IdentificacionComprador')
								TaxIdentification = <TaxIdentification/>
									application.output('Tipo de Persona')
									PersonTypeCode = <PersonTypeCode/>
									//Tipo de persona. Física o Jurídica. "F" - Física; "J" - Jurídica.
									PersonTypeCode.appendChild(tipopersonacliente)
									application.output('Tipo de Residencia')
									ResidenceTypeCode = <ResidenceTypeCode/>
									//Identificación del tipo de residencia y/o extranjería. 
									//"E" - Extranjero; 
									//"R" - Residente; 
									//"U" - Residente en la Unión Europea.
									if(paiscliente == 'ES' || paiscliente == null || paiscliente == '') var tiponacionalidad = 'R'
									else tiponacionalidad = TipoNacionalidad(paiscliente)
									ResidenceTypeCode.appendChild(tiponacionalidad)
									TaxIdentificationNumber = <TaxIdentificationNumber/>
									if(utils.stringLeft(cifcliente,2) == paiscliente) TaxIdentificationNumber.appendChild(utils.stringLeft(cifcliente,30))
									else TaxIdentificationNumber.appendChild(utils.stringLeft(paiscliente+cifcliente,30))	//Código de Identificación Fiscal del sujeto. Se trata de las composiciones de NIF/CIF que marca la Administración correspondiente (precedidas de las dos letras del país en el caso de operaciones intracomunitarias, es decir, cuando comprador y vendedor tienen domicilio fiscal en estados miembros de la UE distintos).
																
								TaxIdentification.appendChild(PersonTypeCode)
								TaxIdentification.appendChild(ResidenceTypeCode)
								TaxIdentification.appendChild(TaxIdentificationNumber)
								application.output('...')
								LegalEntity = <LegalEntity/>
										CorporateName = <CorporateName/>
										application.output('Responsable Cliente')										
										//Nombre de la persona responsable o de relación del centro.
										if(razonsocialcliente) CorporateName.appendChild(utils.stringLeft(razonsocialcliente,40))
										else CorporateName.appendChild(utils.stringLeft(desccliente,40))
										LegalEntity.appendChild(CorporateName)
										if(paiscliente == 'ES')
										{
											application.output('Direccion Cliente')										
											AddressInSpain = <AddressInSpain/>
												Address = <Address/>
												Address.appendChild(utils.stringLeft(direccioncliente,80))
												PostCode = <PostCode/>
												PostCode.appendChild(utils.stringLeft(codpostalcliente,5))
												Town = <Town/>
												Town.appendChild(utils.stringLeft(poblacioncliente,50))
												Province = <Province/>
												Province.appendChild(utils.stringLeft(provinciacliente,20))
												CountryCode = <CountryCode/>
												CountryCode.appendChild('ESP')
											AddressInSpain.appendChild(Address)
											AddressInSpain.appendChild(PostCode)
											AddressInSpain.appendChild(Town)
											AddressInSpain.appendChild(Province)										
											AddressInSpain.appendChild(CountryCode)										
											LegalEntity.appendChild(AddressInSpain)
										}
										else
										{
											OverseasAddress = <OverseasAddress/>
											//Dirección en el extranjero.
												Address = <Address/>
												Address.appendChild(utils.stringLeft(direccioncliente,80))
												PostCodeAndTown = <PostCodeAndTown/>
												PostCodeAndTown.appendChild(utils.stringLeft(poblacioncliente + ' ' +codpostalcliente,50))
												Province = <Province/>
												Province.appendChild(provinciacliente)
												CountryCode = <CountryCode/>
												CountryCode.appendChild(paisclienteiso3)
											OverseasAddress.appendChild(Address)
											OverseasAddress.appendChild(PostCodeAndTown)
											OverseasAddress.appendChild(Province)
											OverseasAddress.appendChild(CountryCode)										
											LegalEntity.appendChild(OverseasAddress)
										}
										
									
									/*Individual = <Individual/>
										application.output('Persona Fisica')										
										//Persona física.		
										Name = <Name/>
										//Nombre de la persona responsable o de relación del centro.
										if(razonsocialcliente) Name.appendChild(utils.stringLeft(razonsocialcliente,40))
										else Name.appendChild(utils.stringLeft(desccliente,40))
										FirstSurname = <FirstSurname/>
										//Nombre de la persona responsable o de relación del centro.
										FirstSurname.appendChild(utils.stringLeft('',40))
										Individual.appendChild(Name)
										Individual.appendChild(FirstSurname)
										if(paiscliente == 'ES')
										{
											AddressInSpain = <AddressInSpain/>
											Address = <Address/>
											Address.appendChild(utils.stringLeft(direccioncliente,80))
											PostCode = <PostCode/>
											PostCode.appendChild(utils.stringLeft(codpostalcliente,5))
											Town = <Town/>
											Town.appendChild(utils.stringLeft(poblacioncliente,50))
											Province = <Province/>
											Province.appendChild(utils.stringLeft(provinciacliente,20))
											CountryCode = <CountryCode/>
											CountryCode.appendChild('ESP')
											AddressInSpain.appendChild(Address)
											AddressInSpain.appendChild(PostCode)
											AddressInSpain.appendChild(Town)
											AddressInSpain.appendChild(Province)										
											AddressInSpain.appendChild(CountryCode)										
											Individual.appendChild(AddressInSpain)
										}
										else
										{
											OverseasAddress = <OverseasAddress/>
											//Dirección en el extranjero.
												Address = <Address/>
												Address.appendChild(utils.stringLeft(direccioncliente,80))
												PostCodeAndTown = <PostCodeAndTown/>
												PostCodeAndTown.appendChild(utils.stringLeft(poblacioncliente + ' ' +codpostalcliente,50))
												Province = <Province/>
												Province.appendChild(provinciacliente)
												CountryCode = <CountryCode/>
												CountryCode.appendChild(paisclienteiso3)
											OverseasAddress.appendChild(Address)
											OverseasAddress.appendChild(PostCodeAndTown)
											OverseasAddress.appendChild(Province)
											OverseasAddress.appendChild(CountryCode)										
											Individual.appendChild(OverseasAddress)
										}
							*/			
							BuyerParty.appendChild(TaxIdentification)
							BuyerParty.appendChild(LegalEntity)		
							//BuyerParty.appendChild(Individual)		
						//Parties.appendChild(SellerParty)
						Parties.appendChild(BuyerParty)
						application.output('Facturas')
						Invoices = <Invoices/>
						//Conjunto de facturas que contiene el fichero. Para todos los elementos numéricos, los cálculos se efectuarán siempre redondeando al número de decimales correspondientes.
						var NFactura = null;
						var NFacturaAnterior = null;
						
						for(var i=1;i<=dataset.getMaxRowIndex();i++)
						{
							NFactura = dataset.getValue(i,23)+utils.numberFormat(dataset.getValue(i,25),'00000')+dataset.getValue(i,24);
							application.output('NFactura')
							
							
							if(NFactura != NFacturaAnterior)
							{	
								if(i>1)
								{
									PaymentDetails = <PaymentDetails/>
									//Datos de pago.
										Installment = <Installment/>
										//Vencimiento.
											InstallmentDueDate = <InstallmentDueDate/>
											//Fechas en las que se deben atender los pagos. ISO 8601:2004.
											InstallmentDueDate.appendChild(utils.dateFormat(fechacobro,'yyyy-MM-dd'))
											InstallmentAmount = <InstallmentAmount/>
											//Importe a satisfacer en cada plazo. Siempre con dos decimales.
											InstallmentAmount.appendChild(impnee.toFixed(2))
											PaymentMeans = <PaymentMeans/>
											//Cada vencimiento/importe podrá tener un medio de pago concreto.
											PaymentMeans.appendChild('04')
											/*01 Al contado
											  02 Recibo domiciliado
											  03 Recibo
											  04 Transferencia*/
											AccountToBeCredited = <AccountToBeCredited/>
											//Cuenta de abono. Único formato admitido. Cuando la forma de pago (PaymentMeans) sea "transferencia" este dato será obligatorio.
												IBAN = <IBAN/>
												//IBAN. Único formato admitido para identificar la cuenta. (Recomendado)
												IBAN.appendChild(cuentaabono)		
												BIC = <BIC/>
												//Código SWIFT. Será obligatorio rellenar las 11 posiciones, utilizando los caracteres XXX cuando no se informe de la sucursal.
												BIC.appendChild(bic)
												AccountToBeCredited.appendChild(IBAN)
												AccountToBeCredited.appendChild(BIC)
											//var AccountToBeDebited = <AccountToBeDebited/>
												
											Installment.appendChild(InstallmentDueDate)
											Installment.appendChild(InstallmentAmount)
											Installment.appendChild(PaymentMeans)
											if(cuentaabono && bic && cuentaabono != '' && bic != '') Installment.appendChild(AccountToBeCredited)
										PaymentDetails.appendChild(Installment)
									Invoice = <Invoice/>
									Invoice.appendChild(InvoiceHeader)
									Invoice.appendChild(InvoiceIssueData)
									Invoice.appendChild(TaxesOutputs)
									Invoice.appendChild(InvoiceTotals)
									Invoice.appendChild(Items)
									Invoice.appendChild(PaymentDetails)
									Invoices.appendChild(Invoice)
									Document.appendChild(Invoices)
							
									/*var fechafactura = dataset.getValue(i,26);
									var impbre = dataset.getValue(i,37);
									var depp = dataset.getValue(i,38);
									//var porcgfi = dataset.getValue(i,50);
									var impgfi = dataset.getValue(i,51);
									var impnee = dataset.getValue(i,49);
									var impbie = dataset.getValue(i,40);
									var piva = dataset.getValue(i,41);
									var cuotaiva = dataset.getValue(i,42);
									var impbie2 = dataset.getValue(i,43);
									var piva2 = dataset.getValue(i,44);
									var cuotaiva2 = dataset.getValue(i,45);
									var impbie3 = dataset.getValue(i,46);
									var piva3 = dataset.getValue(i,47);
									var cuotaiva3 = dataset.getValue(i,48);
									var impre = dataset.getValue(i,52);
									if(impre)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										var porcimpre = dataset2.getValue(1,1)
									}
									var impre2 = dataset.getValue(i,53);
									if(impre2)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva2;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										var porcimpre2 = dataset2.getValue(1,1)
									}						
									var impre3 = dataset.getValue(i,54);
									if(impre3)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva3;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										var porcimpre3 = dataset2.getValue(1,1)
									}
									//var alb = dataset.getValue(i,60);
									//var lalb = dataset.getValue(i,61);
									var concepto = dataset.getValue(i,63)
									var cant = dataset.getValue(i,64)
									var imporlfa = dataset.getValue(i,73)
									var preclfa = dataset.getValue(i,65)
									var dtolfa = dataset.getValue(i,68)
									var impordtolfa = dataset.getValue(i,69)
									*/
									datoslineas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI,i)
								}
								else
								{
									/*fechafactura = dataset.getValue(i,26);
									impbre = dataset.getValue(i,37);
									depp = dataset.getValue(i,38);
									//var porcgfi = dataset.getValue(i,50);
									impgfi = dataset.getValue(i,51);
									impnee = dataset.getValue(i,49);
									impbie = dataset.getValue(i,40);
									piva = dataset.getValue(i,41);
									cuotaiva = dataset.getValue(i,42);
									impbie2 = dataset.getValue(i,43);
									piva2 = dataset.getValue(i,44);
									cuotaiva2 = dataset.getValue(i,45);
									impbie3 = dataset.getValue(i,46);
									piva3 = dataset.getValue(i,47);
									cuotaiva3 = dataset.getValue(i,48);
									impre = dataset.getValue(i,52);
									if(impre)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										porcimpre = dataset2.getValue(1,1)
									}
									impre2 = dataset.getValue(i,53);
									if(impre2)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva2;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										porcimpre2 = dataset2.getValue(1,1)
									}						
									impre3 = dataset.getValue(i,54);
									if(impre3)
									{
										query = "select ivare from tbmaestrotipoiva "+
												"WHERE factor = "+piva3;
										dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
										porcimpre3 = dataset2.getValue(1,1)
									}
									//alb = dataset.getValue(i,60);
									//lalb = dataset.getValue(i,61);
									concepto = dataset.getValue(i,63)
									cant = dataset.getValue(i,64)
									imporlfa = dataset.getValue(i,73)
									preclfa = dataset.getValue(i,65)
									dtolfa = dataset.getValue(i,68)
									impordtolfa = dataset.getValue(i,69)
									*/
									datoslineas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI,i)
								}
								application.output('Cabecera Factura')
								Invoice = <Invoice/>
								InvoiceHeader = <InvoiceHeader/>
									InvoiceNumber = <InvoiceNumber/>
										InvoiceNumber.appendChild(NFactura)
									InvoiceSeriesCode = <InvoiceSeriesCode/>
										if(fechafactura) InvoiceSeriesCode.appendChild(fechafactura.getFullYear().toString())
										else InvoiceSeriesCode.appendChild('')
									InvoiceDocumentType = <InvoiceDocumentType/>
										//Tipo documento factura. Puede tomar 3 valores (FC, FA y AF), 
										//que se describen como “Factura completa u ordinaria”, 
										//“Factura simplificada” y “Código sin uso desde la entrada en 
										//vigor del RD 1789/2010. Se mantiene por compatibilidad hacia atrás. 
										//Antes significaba autofactura. Para indicar que se trata de una 
										//factura expedida por el destinatario, se recomienda emplear 
										//el elemento InvoiceIssuerType empleando el valor RE, que significa 
										//Destinatario”, respectivamente.
										InvoiceDocumentType.appendChild('FC')
									InvoiceClass = <InvoiceClass/>
									//Clase de Factura. Puede tomar 6 valores (OO, OR, OC, CO, CR y CC), 
									//que se describen como “Original”, “Original rectificativa”, 
									//“Original recapitulativa”, “Duplicado original”, 
									//“Duplicado rectificativa” y “Duplicado recapitulativa”.	
										InvoiceClass.appendChild('OO')
									InvoiceHeader.appendChild(InvoiceNumber)
									InvoiceHeader.appendChild(InvoiceSeriesCode)
									InvoiceHeader.appendChild(InvoiceDocumentType)
									InvoiceHeader.appendChild(InvoiceClass)
								InvoiceIssueData = <InvoiceIssueData/>	
								//Datos de la emisión de la factura
									IssueDate = <IssueDate/>
									//Fecha de expedición. Fecha en la que se genera la factura con efectos 
									//fiscales. ISO 8601:2004. Esta fecha no podrá ser posterior a la fecha
									// de la firma electrónica.
									IssueDate.appendChild(utils.dateFormat(fechafactura,'yyyy-MM-dd'))
									
									OperationDate = <OperationDate/>
									//Fecha de Operación. Fecha en la que se realiza el servicio o se entrega 
									//el bien. ISO 8601:2004. Esta fecha solo será obligatoria si es distinta 
									//de la fecha de expedición.
									OperationDate.appendChild(utils.dateFormat(fechafactura,'yyyy-MM-dd'))
									/*PlaceOfIssue = <PlaceOfIssue/>
									//Lugar de expedición. Plaza en la que se expide el documento.
										PostCode = <PostCode/>
										PostCode.appendChild(utils.numberFormat(0,'00000'))
										PlaceOfIssueDescription = <PlaceOfIssueDescription/>
										//Texto del nombre del lugar.									
										
										PlaceOfIssue.appendChild(PostCode)
										PlaceOfIssue.appendChild(PlaceOfIssueDescription)
									*/
									InvoiceCurrencyCode = <InvoiceCurrencyCode/>
									//Moneda de la operación. Código ISO 4217:2001 Alpha-3 de la moneda en la que se emite la factura. Si la moneda de la operación difiere de la moneda del impuesto (EURO), los campos del contravalor ExchangeRate y
									//ExchangeRateDate deberán cumplimentarse, en cumplimiento del Artº 10.1 del Reglamento sobre facturación. RD 1496/2003 de 28 de Noviembre.
									InvoiceCurrencyCode.appendChild('EUR')
									TaxCurrencyCode = <TaxCurrencyCode/>
									//Moneda del Impuesto. Código ISO 4217:2001 Alpha-3 de la moneda en la que se liquida el impuesto.
									TaxCurrencyCode.appendChild('EUR')
									LanguageName = <LanguageName/>
									//Moneda del Impuesto. Código ISO 4217:2001 Alpha-3 de la moneda en la que se liquida el impuesto.
									LanguageName.appendChild('es')
									
								InvoiceIssueData.appendChild(IssueDate)
								//InvoiceIssueData.appendChild(OperationDate)
								//InvoiceIssueData.appendChild(PlaceOfIssue)
								InvoiceIssueData.appendChild(InvoiceCurrencyCode)
								InvoiceIssueData.appendChild(TaxCurrencyCode)
								InvoiceIssueData.appendChild(LanguageName)
								TaxesOutputs = <TaxesOutputs/>
								//Impuestos repercutidos.
									Tax = <Tax/>
									//Impuesto.
										TaxTypeCode = <TaxTypeCode/>
										//Identificador del impuesto por el que se tributa. En caso de que el impuesto no corresponda a ninguno de los relacionados en “TaxTypeCodeType”, utilícese el código “05”, definido como “otro”. En este caso, se empleará el elemento “AditionalLineItemInformation” para identificar el impuesto, donde se incluirá, para ello, la siguiente cadena de caracteres: 05 = [nombre del impuesto]. Si hubiera varios impuestos con el código “05”, se añadirán los valores de sus campos “TaxRate”, “TaxableBase” y “TaxAmount”, en este orden, hasta que sea posible discernirlos; es decir: 05 [valor “TaxRate”] [valor “TaxableBase”] [valor “TaxAmount”] = [nombre del impuesto]. Cuando la operación esté exenta del impuesto o se encuentre en régimen suspensivo, deberá indicarse el motivo en el elemento “AditionalLineItemInformation”. Este elemento se define a nivel de línea, no de impuesto; por ello, para
										//identificar cuál es el impuesto del que está exenta, el motivo irá precedido del código del impuesto; por ejemplo: 07 exenta por….
										TaxTypeCode.appendChild('01')
										TaxRate = <TaxRate/>
										//Tipo impositivo. Téngase en cuenta que no siempre son porcentajes. La legislación del impuesto correspondiente permitirá identificar las unidades y dimensiones del tipo impositivo. Hasta ocho decimales.
										TaxRate.appendChild(piva.toFixed(2))
										TaxableBase = <TaxableBase/>
										//Base imponible. La legislación del impuesto correspondiente determina cómo se calcula la base imponible. Hasta ocho decimales.
											TotalAmount = <TotalAmount/>
											//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento
											//sobre facturación, RD 1496/2003 de 28 de Noviembre.
											TotalAmount.appendChild(impbie.toFixed(2))
										TaxableBase.appendChild(TotalAmount)
										TaxAmount = <TaxAmount/>
										//Cuota. La legislación del impuesto correspondiente determina cómo se calcula la cuota. Hasta ocho decimales.
											TotalAmount = <TotalAmount/>
											//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
											TotalAmount.appendChild(cuotaiva.toFixed(2))
										TaxAmount.appendChild(TotalAmount)
									Tax.appendChild(TaxTypeCode)
									Tax.appendChild(TaxRate)
									Tax.appendChild(TaxableBase)
									Tax.appendChild(TaxAmount)
										if(impre)
										{
											EquivalenceSurcharge = <EquivalenceSurcharge/>
											//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
											EquivalenceSurcharge.appendChild(porcimpre.toFixed(2))
											EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
											//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
												TotalAmount = <TotalAmount/>
												//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
												TotalAmount.appendChild(impre.toFixed(2))
											EquivalenceSurchargeAmount.appendChild(TotalAmount)		
											
											Tax.appendChild(EquivalenceSurcharge)
											Tax.appendChild(EquivalenceSurchargeAmount)
										}
									TaxesOutputs.appendChild(Tax)
									if(impbie2)
									{
										Tax = <Tax/>
										//Impuesto.
											TaxTypeCode = <TaxTypeCode/>
											//Identificador del impuesto por el que se tributa. En caso de que el impuesto no corresponda a ninguno de los relacionados en “TaxTypeCodeType”, utilícese el código “05”, definido como “otro”. En este caso, se empleará el elemento “AditionalLineItemInformation” para identificar el impuesto, donde se incluirá, para ello, la siguiente cadena de caracteres: 05 = [nombre del impuesto]. Si hubiera varios impuestos con el código “05”, se añadirán los valores de sus campos “TaxRate”, “TaxableBase” y “TaxAmount”, en este orden, hasta que sea posible discernirlos; es decir: 05 [valor “TaxRate”] [valor “TaxableBase”] [valor “TaxAmount”] = [nombre del impuesto]. Cuando la operación esté exenta del impuesto o se encuentre en régimen suspensivo, deberá indicarse el motivo en el elemento “AditionalLineItemInformation”. Este elemento se define a nivel de línea, no de impuesto; por ello, para
											//identificar cuál es el impuesto del que está exenta, el motivo irá precedido del código del impuesto; por ejemplo: 07 exenta por….
											TaxTypeCode.appendChild('01')
											TaxRate = <TaxRate/>
											//Tipo impositivo. Téngase en cuenta que no siempre son porcentajes. La legislación del impuesto correspondiente permitirá identificar las unidades y dimensiones del tipo impositivo. Hasta ocho decimales.
											TaxRate.appendChild(piva2.toFixed(2))
											TaxableBase = <TaxableBase/>
											//Base imponible. La legislación del impuesto correspondiente determina cómo se calcula la base imponible. Hasta ocho decimales.
												TotalAmount = <TotalAmount/>
												//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento
												//sobre facturación, RD 1496/2003 de 28 de Noviembre.
												TotalAmount.appendChild(impbie2.toFixed(2))
											TaxableBase.appendChild(TotalAmount)
											TaxAmount = <TaxAmount/>
											//Cuota. La legislación del impuesto correspondiente determina cómo se calcula la cuota. Hasta ocho decimales.
												TotalAmount = <TotalAmount/>
												//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
												TotalAmount.appendChild(cuotaiva2.toFixed(2))
											TaxAmount.appendChild(TotalAmount)
										Tax.appendChild(TaxTypeCode)
										Tax.appendChild(TaxRate)
										Tax.appendChild(TaxableBase)
										Tax.appendChild(TaxAmount)
											if(impre2)
											{
												EquivalenceSurcharge = <EquivalenceSurcharge/>
												//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
												EquivalenceSurcharge.appendChild(porcimpre2.toFixed(2))
												EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
												//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(impre2.toFixed(2))
												EquivalenceSurchargeAmount.appendChild(TotalAmount)		
												
												Tax.appendChild(EquivalenceSurcharge)
												Tax.appendChild(EquivalenceSurchargeAmount)
											}
										TaxesOutputs.appendChild(Tax)
									}
									if(impbie3)
									{
										Tax = <Tax/>
										//Impuesto.
											TaxTypeCode = <TaxTypeCode/>
											//Identificador del impuesto por el que se tributa. En caso de que el impuesto no corresponda a ninguno de los relacionados en “TaxTypeCodeType”, utilícese el código “05”, definido como “otro”. En este caso, se empleará el elemento “AditionalLineItemInformation” para identificar el impuesto, donde se incluirá, para ello, la siguiente cadena de caracteres: 05 = [nombre del impuesto]. Si hubiera varios impuestos con el código “05”, se añadirán los valores de sus campos “TaxRate”, “TaxableBase” y “TaxAmount”, en este orden, hasta que sea posible discernirlos; es decir: 05 [valor “TaxRate”] [valor “TaxableBase”] [valor “TaxAmount”] = [nombre del impuesto]. Cuando la operación esté exenta del impuesto o se encuentre en régimen suspensivo, deberá indicarse el motivo en el elemento “AditionalLineItemInformation”. Este elemento se define a nivel de línea, no de impuesto; por ello, para
											//identificar cuál es el impuesto del que está exenta, el motivo irá precedido del código del impuesto; por ejemplo: 07 exenta por….
											TaxTypeCode.appendChild('01')
											TaxRate = <TaxRate/>
											//Tipo impositivo. Téngase en cuenta que no siempre son porcentajes. La legislación del impuesto correspondiente permitirá identificar las unidades y dimensiones del tipo impositivo. Hasta ocho decimales.
											TaxRate.appendChild(piva3.toFixed(2))
											TaxableBase = <TaxableBase/>
											//Base imponible. La legislación del impuesto correspondiente determina cómo se calcula la base imponible. Hasta ocho decimales.
												TotalAmount = <TotalAmount/>
												//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento
												//sobre facturación, RD 1496/2003 de 28 de Noviembre.
												TotalAmount.appendChild(impbie3.toFixed(2))
											TaxableBase.appendChild(TotalAmount)
											TaxAmount = <TaxAmount/>
											//Cuota. La legislación del impuesto correspondiente determina cómo se calcula la cuota. Hasta ocho decimales.
												TotalAmount = <TotalAmount/>
												//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
												TotalAmount.appendChild(cuotaiva3.toFixed(2))
											TaxAmount.appendChild(TotalAmount)
										Tax.appendChild(TaxTypeCode)
										Tax.appendChild(TaxRate)
										Tax.appendChild(TaxableBase)
										Tax.appendChild(TaxAmount)
											if(impre3)
											{
												EquivalenceSurcharge = <EquivalenceSurcharge/>
												//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
												EquivalenceSurcharge.appendChild(porcimpre3.toFixed(2))
												EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
												//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(impre3.toFixed(2))
												EquivalenceSurchargeAmount.appendChild(TotalAmount)		
												
												Tax.appendChild(EquivalenceSurcharge)
												Tax.appendChild(EquivalenceSurchargeAmount)
											}
										TaxesOutputs.appendChild(Tax)
									}
									
									InvoiceTotals = <InvoiceTotals/>
										TotalGrossAmount = <TotalGrossAmount/>
										//Total Importe Bruto. Suma total de importes brutos de los detalles de la factura. Hasta ocho decimales.
										TotalGrossAmount.appendChild(impbre.toFixed(2))
										TotalGeneralDiscounts = <TotalGeneralDiscounts/>
										//Total Importe Bruto. Suma total de importes brutos de los detalles de la factura. Hasta ocho decimales.
										TotalGeneralDiscounts.appendChild(globals.GCROUND(impbre*depp,2).toFixed(2))
										TotalGeneralSurcharges = <TotalGeneralSurcharges/>
										//Total general de cargos. Sumatorio de los importes de los diferentes campos GeneralSurcharges. Hasta ocho decimales.
										TotalGeneralSurcharges.appendChild(globals.GCROUND(impgfi,2).toFixed(2))
										TotalGrossAmountBeforeTaxes = <TotalGrossAmountBeforeTaxes/>
										//Total importe bruto antes de impuestos. Resultado de: TotalGrossAmount - TotalGeneralDiscounts + TotalGeneralSurcharges. Hasta ocho decimales.
										TotalGrossAmountBeforeTaxes.appendChild(globals.GCROUND(impbie+impbie2+impbie3,2).toFixed(2))
										TotalTaxOutputs = <TotalTaxOutputs/>
										//Total importe bruto antes de impuestos. Resultado de: TotalGrossAmount - TotalGeneralDiscounts + TotalGeneralSurcharges. Hasta ocho decimales.
										TotalTaxOutputs.appendChild(globals.GCROUND(cuotaiva+cuotaiva2+cuotaiva3+impre+impre2+impre3,2).toFixed(2))
										TotalTaxesWithheld = <TotalTaxesWithheld/>
										//Total impuestos retenidos. Hasta ocho decimals.
										TotalTaxesWithheld.appendChild(0)
										InvoiceTotal = <InvoiceTotal/>
										//Total importe bruto antes de impuestos. Resultado de: TotalGrossAmount - TotalGeneralDiscounts + TotalGeneralSurcharges. Hasta ocho decimales.
										InvoiceTotal.appendChild(impnee.toFixed(2))
										TotalOutstandingAmount = <TotalOutstandingAmount/>
										//Total importe bruto antes de impuestos. Resultado de: TotalGrossAmount - TotalGeneralDiscounts + TotalGeneralSurcharges. Hasta ocho decimales.
										TotalOutstandingAmount.appendChild(impnee.toFixed(2))
										TotalExecutableAmount = <TotalExecutableAmount/>
										//Total importe bruto antes de impuestos. Resultado de: TotalGrossAmount - TotalGeneralDiscounts + TotalGeneralSurcharges. Hasta ocho decimales.
										TotalExecutableAmount.appendChild(impnee.toFixed(2))								
									InvoiceTotals.appendChild(TotalGrossAmount)
									InvoiceTotals.appendChild(TotalGeneralDiscounts)
									InvoiceTotals.appendChild(TotalGeneralSurcharges)
									InvoiceTotals.appendChild(TotalGrossAmountBeforeTaxes)
									InvoiceTotals.appendChild(TotalTaxOutputs)
									InvoiceTotals.appendChild(TotalTaxesWithheld)
									InvoiceTotals.appendChild(InvoiceTotal)
									InvoiceTotals.appendChild(TotalOutstandingAmount)
									InvoiceTotals.appendChild(TotalExecutableAmount)
									var Items = <Items/> 
									//Información detallada.
								
							}
							else
							{
								/*fechafactura = dataset.getValue(i,26);
								impbre = dataset.getValue(i,37);
								depp = dataset.getValue(i,38);
								//var porcgfi = dataset.getValue(i,50);
								impgfi = dataset.getValue(i,51);
								impnee = dataset.getValue(i,49);
								impbie = dataset.getValue(i,40);
								piva = dataset.getValue(i,41);
								cuotaiva = dataset.getValue(i,42);
								impbie2 = dataset.getValue(i,43);
								piva2 = dataset.getValue(i,44);
								cuotaiva2 = dataset.getValue(i,45);
								impbie3 = dataset.getValue(i,46);
								piva3 = dataset.getValue(i,47);
								cuotaiva3 = dataset.getValue(i,48);
								impre = dataset.getValue(i,52);
								if(impre)
								{
									query = "select ivare from tbmaestrotipoiva "+
											"WHERE factor = "+piva;
									dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
									porcimpre = dataset2.getValue(1,1)
								}
								impre2 = dataset.getValue(i,53);
								if(impre2)
								{
									query = "select ivare from tbmaestrotipoiva "+
											"WHERE factor = "+piva2;
									dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
									porcimpre2 = dataset2.getValue(1,1)
								}						
								impre3 = dataset.getValue(i,54);
								if(impre3)
								{
									query = "select ivare from tbmaestrotipoiva "+
											"WHERE factor = "+piva3;
									dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
									porcimpre3 = dataset2.getValue(1,1)
								}
								//alb = dataset.getValue(i,60);
								//lalb = dataset.getValue(i,61);
								concepto = dataset.getValue(i,63)
								cant = dataset.getValue(i,64)
								imporlfa = dataset.getValue(i,73)
								preclfa = dataset.getValue(i,65)
								dtolfa = dataset.getValue(i,68)
								impordtolfa = dataset.getValue(i,69)
								*/
								datoslineas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI,i)
							}
							
								InvoiceLine = <InvoiceLine/>
								//Líneas de detalle de la factura.
									/*var IssuerContractReference = <IssuerContractReference/>
									//Referencia del contrato del Emisor.
									var IssuerContractDate = <IssuerContractDate/>
									//Fecha del contrato del emisor.
									var IssuerTransactionReference = <IssuerTransactionReference/>
									//Referencia de la Operación, Número de Pedido, Contrato, etc. del Emisor.
									var IssuerTransactionDate = <IssuerTransactionDate/>
									//Fecha de operación / pedido del emisor.								
									var ReceiverContractReference = <ReceiverContractReference/>
									//Referencia del contrato del Receptor.
									var ReceiverContractDate = <ReceiverContractDate/>
									//Fecha del contrato del receptor.
									var ReceiverTransactionReference = <ReceiverTransactionReference/>
									//Referencia de la Operación, Número de Pedido, Contrato, etc. del Receptor.
									var ReceiverTransactionDate = <ReceiverTransactionDate/>
									//Fecha de operación / pedido del receptor.
									var FileReference = <FileReference/>
									//Referencia del expediente.
									var FileDate = <FileDate/>
									//Fecha del expediente.
									var SequenceNumber = <SequenceNumber/>
									//Número de secuencia o línea del pedido.
									var DeliveryNotesReferences = <DeliveryNotesReferences/>
									//Referencias de albaranes.
										var DeliveryNote = <DeliveryNote/>
										//Información del albarán.
											var DeliveryNoteNumber = <DeliveryNoteNumber/>
											//Número de referencia del albarán.
											if(alb) DeliveryNoteNumber.appendChild(alb);
											var DeliveryNoteDate = <DeliveryNoteDate/>
											//Fecha del albarán.
											if(alb)
											{
												query = 'select fecha_cal from calbaran where cod_cal ='+alb;
												dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
												var fecha_cal = dataset2.getValue(1,1)
												DeliveryNoteDate.appendChild(fecha_cal)
											}										
											DeliveryNote.appendChild(DeliveryNoteNumber)
											DeliveryNote.appendChild(DeliveryNoteDate)
										DeliveryNotesReferences.appendChild(DeliveryNote)*/
									ItemDescription = <ItemDescription/>
									//Descripción del bien o servicio.
									ItemDescription.appendChild(concepto)		
									Quantity = <Quantity/>
									//Cantidad. Número de Unidades servidas/prestadas.
									Quantity.appendChild(cant)
									UnitOfMeasure = <UnitOfMeasure/>
									//Cantidad. Número de Unidades servidas/prestadas.
									UnitOfMeasure.appendChild('01')
									UnitPriceWithoutTax = <UnitPriceWithoutTax/>
									//Precio de la unidad de bien o servicio servido/prestado, en la moneda indicada en la Cabecera de la Factura. Siempre sin Impuestos. Hasta ocho decimales.
									if(preclfa) var imp = preclfa
									else imp = 0	
									UnitPriceWithoutTax.appendChild(imp.toFixed(2))
									TotalCost = <TotalCost/>
									//Coste Total. Resultado: Quantity x UnitPriceWithoutTax Hasta ocho decimales
									TotalCost.appendChild(imporlfa)
									
									DiscountsAndRebates = <DiscountsAndRebates/>
										//Descuentos.
											Discount = <Discount/>
											//Descuento.
												DiscountReason = <DiscountReason/>
												DiscountReason.appendChild('Descuento')
												DiscountRate = <DiscountRate/>
												DiscountRate.appendChild(globals.GCROUND(dtolfa,2).toFixed(2))
												DiscountAmount = <DiscountAmount/>
												DiscountAmount.appendChild(globals.GCROUND(impordtolfa,2).toFixed(2))
												Discount.appendChild(DiscountReason)
												Discount.appendChild(DiscountRate)
												Discount.appendChild(DiscountAmount)
									DiscountsAndRebates.appendChild(Discount)
									Charges = <Charges/>	
									//Cargos.
										Charge = <Charge/>	
										//Cargo
											ChargeReason = <ChargeReason/>
											//Concepto por el que se aplica el cargo.
											ChargeReason.appendChild('Cargo')
											ChargeRate = <ChargeRate/>
											//Porcentaje a cargar sobre el TIB. Los porcentajes se reflejan con hasta 8 decimales.
											ChargeRate.appendChild(0)
											ChargeAmount = <ChargeAmount/>
											//Importe a cargar sobre el TIB. Hasta 8 decimales.
											ChargeAmount.appendChild(0)
											Charge.appendChild(ChargeReason)
											Charge.appendChild(ChargeRate)
											Charge.appendChild(ChargeAmount)
									Charges.appendChild(Charge)
									GrossAmount = <GrossAmount/>
										if(imporlfa) imp = imporlfa
										else imp = 0	
										GrossAmount.appendChild(imp.toFixed(2))	
									TaxesOutputs = <TaxesOutputs/>
									//Impuestos retenidos. Es una secuencia de elementos, cada uno de los cuales contiene la información de un impuesto retenido.
										Tax = <Tax/>										
											TaxTypeCode = <TaxTypeCode/>
											TaxTypeCode.appendChild('01')
											TaxRate = <TaxRate/>
											TaxRate.appendChild(piva.toFixed(2))
											TaxableBase = <TaxableBase/>
												TotalAmount = <TotalAmount/>
												TotalAmount.appendChild(impbie.toFixed(2))
												TaxableBase.appendChild(TotalAmount)
											TaxAmount = <TaxAmount/>
												TotalAmount = <TotalAmount/>
												TotalAmount.appendChild(cuotaiva.toFixed(2))
												TaxAmount.appendChild(TotalAmount)
											Tax.appendChild(TaxTypeCode)
											Tax.appendChild(TaxRate)
											Tax.appendChild(TaxableBase)
											Tax.appendChild(TaxAmount)
											if(impre)
											{
												EquivalenceSurcharge = <EquivalenceSurcharge/>
												//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
												EquivalenceSurcharge.appendChild(porcimpre.toFixed(2))
												EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
												//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(impre.toFixed(2))
												EquivalenceSurchargeAmount.appendChild(TotalAmount)		
												
												Tax.appendChild(EquivalenceSurcharge)
												Tax.appendChild(EquivalenceSurchargeAmount)
											}
										TaxesOutputs.appendChild(Tax)
										if(impbie2)
										{
											Tax = <Tax/>
											//Impuesto.
												TaxTypeCode = <TaxTypeCode/>
												//Identificador del impuesto por el que se tributa. En caso de que el impuesto no corresponda a ninguno de los relacionados en “TaxTypeCodeType”, utilícese el código “05”, definido como “otro”. En este caso, se empleará el elemento “AditionalLineItemInformation” para identificar el impuesto, donde se incluirá, para ello, la siguiente cadena de caracteres: 05 = [nombre del impuesto]. Si hubiera varios impuestos con el código “05”, se añadirán los valores de sus campos “TaxRate”, “TaxableBase” y “TaxAmount”, en este orden, hasta que sea posible discernirlos; es decir: 05 [valor “TaxRate”] [valor “TaxableBase”] [valor “TaxAmount”] = [nombre del impuesto]. Cuando la operación esté exenta del impuesto o se encuentre en régimen suspensivo, deberá indicarse el motivo en el elemento “AditionalLineItemInformation”. Este elemento se define a nivel de línea, no de impuesto; por ello, para
												//identificar cuál es el impuesto del que está exenta, el motivo irá precedido del código del impuesto; por ejemplo: 07 exenta por….
												TaxTypeCode.appendChild('01')
												TaxRate = <TaxRate/>
												//Tipo impositivo. Téngase en cuenta que no siempre son porcentajes. La legislación del impuesto correspondiente permitirá identificar las unidades y dimensiones del tipo impositivo. Hasta ocho decimales.
												TaxRate.appendChild(piva2.toFixed(2))
												TaxableBase = <TaxableBase/>
												//Base imponible. La legislación del impuesto correspondiente determina cómo se calcula la base imponible. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento
													//sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(impbie2.toFixed(2))
												TaxableBase.appendChild(TotalAmount)
												TaxAmount = <TaxAmount/>
												//Cuota. La legislación del impuesto correspondiente determina cómo se calcula la cuota. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(cuotaiva2.toFixed(2))
												TaxAmount.appendChild(TotalAmount)
											Tax.appendChild(TaxTypeCode)
											Tax.appendChild(TaxRate)
											Tax.appendChild(TaxableBase)
											Tax.appendChild(TaxAmount)
												if(impre2)
												{
													EquivalenceSurcharge = <EquivalenceSurcharge/>
													//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
													EquivalenceSurcharge.appendChild(porcimpre2.toFixed(2))
													EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
													//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
														TotalAmount = <TotalAmount/>
														//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
														TotalAmount.appendChild(impre2.toFixed(2))
													EquivalenceSurchargeAmount.appendChild(TotalAmount)		
													
													Tax.appendChild(EquivalenceSurcharge)
													Tax.appendChild(EquivalenceSurchargeAmount)
												}
											TaxesOutputs.appendChild(Tax)
										}
										if(impbie3)
										{
											Tax = <Tax/>
											//Impuesto.
												TaxTypeCode = <TaxTypeCode/>
												//Identificador del impuesto por el que se tributa. En caso de que el impuesto no corresponda a ninguno de los relacionados en “TaxTypeCodeType”, utilícese el código “05”, definido como “otro”. En este caso, se empleará el elemento “AditionalLineItemInformation” para identificar el impuesto, donde se incluirá, para ello, la siguiente cadena de caracteres: 05 = [nombre del impuesto]. Si hubiera varios impuestos con el código “05”, se añadirán los valores de sus campos “TaxRate”, “TaxableBase” y “TaxAmount”, en este orden, hasta que sea posible discernirlos; es decir: 05 [valor “TaxRate”] [valor “TaxableBase”] [valor “TaxAmount”] = [nombre del impuesto]. Cuando la operación esté exenta del impuesto o se encuentre en régimen suspensivo, deberá indicarse el motivo en el elemento “AditionalLineItemInformation”. Este elemento se define a nivel de línea, no de impuesto; por ello, para
												//identificar cuál es el impuesto del que está exenta, el motivo irá precedido del código del impuesto; por ejemplo: 07 exenta por….
												TaxTypeCode.appendChild('01')
												TaxRate = <TaxRate/>
												//Tipo impositivo. Téngase en cuenta que no siempre son porcentajes. La legislación del impuesto correspondiente permitirá identificar las unidades y dimensiones del tipo impositivo. Hasta ocho decimales.
												TaxRate.appendChild(piva3.toFixed(2))
												TaxableBase = <TaxableBase/>
												//Base imponible. La legislación del impuesto correspondiente determina cómo se calcula la base imponible. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento
													//sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(impbie3.toFixed(2))
												TaxableBase.appendChild(TotalAmount)
												TaxAmount = <TaxAmount/>
												//Cuota. La legislación del impuesto correspondiente determina cómo se calcula la cuota. Hasta ocho decimales.
													TotalAmount = <TotalAmount/>
													//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
													TotalAmount.appendChild(cuotaiva3.toFixed(2))
												TaxAmount.appendChild(TotalAmount)
											Tax.appendChild(TaxTypeCode)
											Tax.appendChild(TaxRate)
											Tax.appendChild(TaxableBase)
											Tax.appendChild(TaxAmount)
												if(impre3)
												{
													EquivalenceSurcharge = <EquivalenceSurcharge/>
													//Tipo de recargo de Equivalencia. Siempre con dos decimales.											
													EquivalenceSurcharge.appendChild(porcimpre3.toFixed(2))
													EquivalenceSurchargeAmount = <EquivalenceSurchargeAmount/>
													//Cuota. Importe resultante de aplicar a la Base Imponible, la misma que para el IVA, el porcentaje indicado en “EquivalenceSurchage”. Hasta ocho decimales.
														TotalAmount = <TotalAmount/>
														//Importe en la moneda original de la facturación. Siempre que la divisa de facturación sea distinta de EURO, el elemento EquivalentInEuros deberá cumplimentarse para satisfacer los requerimientos del Art.10.1 del Reglamento sobre facturación, RD 1496/2003 de 28 de Noviembre.
														TotalAmount.appendChild(impre3.toFixed(2))
													EquivalenceSurchargeAmount.appendChild(TotalAmount)		
													
													Tax.appendChild(EquivalenceSurcharge)
													Tax.appendChild(EquivalenceSurchargeAmount)
												}
											TaxesOutputs.appendChild(Tax)
										}
										if(cant && cant != 0 && imporlfa && imporlfa != 0)
										{
											/*InvoiceLine.appendChild(IssuerContractReference)
											InvoiceLine.appendChild(IssuerContractDate)
											InvoiceLine.appendChild(IssuerTransactionReference)
											InvoiceLine.appendChild(IssuerTransactionDate)
											InvoiceLine.appendChild(ReceiverContractReference)
											InvoiceLine.appendChild(ReceiverContractDate)
											InvoiceLine.appendChild(ReceiverTransactionReference)
											InvoiceLine.appendChild(ReceiverTransactionDate)
											InvoiceLine.appendChild(FileReference)
											InvoiceLine.appendChild(FileDate)
											InvoiceLine.appendChild(SequenceNumber)
											InvoiceLine.appendChild(DeliveryNotesReferences)*/
											InvoiceLine.appendChild(ItemDescription)
											InvoiceLine.appendChild(Quantity)
											InvoiceLine.appendChild(UnitOfMeasure)
											InvoiceLine.appendChild(UnitPriceWithoutTax)
											InvoiceLine.appendChild(TotalCost)	
											InvoiceLine.appendChild(DiscountsAndRebates)
											InvoiceLine.appendChild(Charges)
											InvoiceLine.appendChild(GrossAmount)
											InvoiceLine.appendChild(TaxesOutputs)								
										Items.appendChild(InvoiceLine)
									}
									
							NFacturaAnterior = NFactura;
						}
						
						PaymentDetails = <PaymentDetails/>
						//Datos de pago.
							Installment = <Installment/>
							//Vencimiento.
								InstallmentDueDate = <InstallmentDueDate/>
								//Fechas en las que se deben atender los pagos. ISO 8601:2004.
								InstallmentDueDate.appendChild(utils.dateFormat(fechacobro,'yyyy-MM-dd'))
								InstallmentAmount = <InstallmentAmount/>
								//Importe a satisfacer en cada plazo. Siempre con dos decimales.
								InstallmentAmount.appendChild(impnee.toFixed(2))
								PaymentMeans = <PaymentMeans/>
								//Cada vencimiento/importe podrá tener un medio de pago concreto.
								PaymentMeans.appendChild('04')
								/*01 Al contado
								  02 Recibo domiciliado
								  03 Recibo
								  04 Transferencia*/
								AccountToBeCredited = <AccountToBeCredited/>
								//Cuenta de abono. Único formato admitido. Cuando la forma de pago (PaymentMeans) sea "transferencia" este dato será obligatorio.
									IBAN = <IBAN/>
									//IBAN. Único formato admitido para identificar la cuenta. (Recomendado)
									IBAN.appendChild(cuentaabono)		
									BIC = <BIC/>
									//Código SWIFT. Será obligatorio rellenar las 11 posiciones, utilizando los caracteres XXX cuando no se informe de la sucursal.
									BIC.appendChild(bic)
									AccountToBeCredited.appendChild(IBAN)
									AccountToBeCredited.appendChild(BIC)
								//var AccountToBeDebited = <AccountToBeDebited/>
									
								Installment.appendChild(InstallmentDueDate)
								Installment.appendChild(InstallmentAmount)
								Installment.appendChild(PaymentMeans)
								if(cuentaabono && bic && cuentaabono != '' && bic != '') Installment.appendChild(AccountToBeCredited)
							PaymentDetails.appendChild(Installment)
						Invoice.appendChild(InvoiceHeader)
						Invoice.appendChild(InvoiceIssueData)
						Invoice.appendChild(TaxesOutputs)
						Invoice.appendChild(InvoiceTotals)
						Invoice.appendChild(Items)
						Invoice.appendChild(PaymentDetails)
						Invoices.appendChild(Invoice)
					Document.appendChild(FileHeader)
					Document.appendChild(Parties)
					Document.appendChild(Invoices)
					
						
					xml += Document.toXMLString()
					application.output(xml)
					//var newxml = xml.toString().replace(' xmlns=""','')
					newxml = utils.stringReplace(xml,' xmlns=""','')
					newxml = utils.stringReplace(newxml,'<Facturae','<fe:Facturae')
					newxml = utils.stringReplace(newxml, '</Facturae','</fe:Facturae')
					//var xml2 = new XML(newxml)
					application.output(newxml);
					
					
					/*var jsFile = plugins.file.createTempFile('SEPA','.xml');
					
					var success = plugins.file.writeXMLFile(jsFile ,newxml);
					if (!success) application.output('Could not write file.');
					//if(application.getApplicationType() == APPLICATION_TYPES.WEB_CLIENT) 
					//{
						plugins.file.streamFilesToServer(jsFile)
						plugins.file.openFile(jsFile,"_blank",application/xml)
					/*}
					else 
					{
						plugins.file.streamFilesToServer(jsFile,doImportFile)
					}*/
					htm = newxml
					/*if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
					{
						var js = plugins.file.showFileSaveDialog('FacturaE32_'+eje_cfa.toString()+utils.numberFormat(nup_cfa,'00000').toString()+ser_cfa+'.xml', 'Selecciona localización para salvar el fichero');
						if (!js) return;			
									
						ok = 1
						// Write the file in the selected location
						plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');
					}
					else
					{*/
						ok = 1
						/*js = application.getServerURL()  + "\\uploads\\FacturaE32.xml"
						plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');	*/
						
						var jsFile = plugins.file.createTempFile('FacturaE32','.xml');
						
						var success = plugins.file.writeXMLFile(jsFile , newxml.toString());
						if (!success) application.output('Could not write file.');
						
						//plugins.file.streamFilesToServer(jsFile)
						//plugins.file.openFile(jsFile,"_blank",'application/xml')
						else plugins.file.openFile("FacturaE32.xml",jsFile.getBytes(),'application/txt')
					//}
	
				
		}
	}
	catch (e) 
	{
		application.output("catched exception");
		application.output(e);
	} 
	finally 
	{
		if(ok == 1)
		{
			application.output('Fichero FacturaE generado correctamente')
			//application.getWindow('Impresion Facturas').hide();
			//globals.GCenableBgElements();
		}
	}
}

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E4E78DC5-6BE5-4857-B156-CB59EFA57033",variableType:8}
 */
var numerofacturas;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"2BECA6C1-CA19-4DFA-8D11-162AB032E423",variableType:8}
 */
var sumafacturas;

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} DEJE
 * @param {String} DSER
 * @param {Number} DNUP
 * @param {Number} HEJE
 * @param {String} HSER
 * @param {Number} HNUP
 * @param {Number} DCLI
 * @param {Number} HCLI
 *
 *
 *
 * @properties={typeid:24,uuid:"E64F8C75-E8D2-4BE0-AA1C-CBF718DFDC9E"}
 */
function nfacturas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)
{
	var query = "select count(*),isnull(sum(impnee_cfa),0) from tbfacturacabecera "+
	"WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
     " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
     "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
     "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
     "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
     " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
     "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+")";
     var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
     numerofacturas = dataset2.getValue(1,1);
     sumafacturas = dataset2.getValue(1,2);
}

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"DD71E240-8916-4E77-86C6-F7F984EAA8BC"}
 */
var cifempresa = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"494437A2-C033-4588-88FE-FEABED25634A"}
 */
var tipopersona = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B50B61D2-1537-4EFF-B633-B813CB1CEF78"}
 */
var pais = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"132D4B6B-EF87-4040-A436-72BFB4DFD8C2"}
 */
var razonsocial = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"16A42054-460B-44FB-AE14-0748C7168806"}
 */
var regmercantil = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"44F25D50-9CC2-4D92-9D41-AA12E3FAD5C0"}
 */
var hoja = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B0CF6B25-DB15-49CD-B396-6254CA196317"}
 */
var folio = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C7C63F68-8A4E-4E6E-B590-DF1ADB07D5AC"}
 */
var seccion = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9C8521CD-323A-4C24-B4CC-E2CB07BE0545"}
 */
var tomo = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"76885E8B-D94A-4929-852F-DA12D4630F58"}
 */
var direccion = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F65D10FC-2C87-46BD-B081-C9F5D3BFBEC4"}
 */
var codigopostal = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"5459D1D0-BCA2-427B-B7A9-72BF664443C2"}
 */
var ciudad = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"8A0B0382-12BC-457D-BB5A-06BA0A2A37A3"}
 */
var provincia = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"551E8656-3D17-4B14-9FAD-11C6AC9F1F8A"}
 */
var telefono = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"45B43E15-B7FE-4474-BB2D-7772BC36DB67"}
 */
var fax = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"B9442111-0C10-4718-8E22-3C29FDFA8076"}
 */
var web = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C88E7A25-E882-4ED5-871B-3166906FFF55"}
 */
var correo = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"09896DFA-3857-4C66-A486-E9F51F7275A8"}
 */
var primerafactura = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"3049BCDF-7EA8-4FD3-98B4-0AE1D4C1BFAF"}
 */
var ultimafactura = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"95326791-3F95-4CC1-A1A7-68011235977E"}
 */
var cifcliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"608C52D3-589B-4849-BE93-7B4AD8E82533"}
 */
var tipopersonacliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"174CCF66-E49A-4116-94D1-DE04FE15DD44"}
 */
var paiscliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F93F03E9-D0BF-463C-96C8-F239E56995FB"}
 */
var desccliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"ACB190E9-5C05-4A34-9D22-550437531569"}
 */
var direccioncliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E56153BE-B9A7-4F52-ACAB-0024B335D84D"}
 */
var poblacioncliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"F3CCBF10-5AE4-443F-96E0-A84D79991E66"}
 */
var provinciacliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"E292D8D5-D01D-4BF6-A1BC-6F2C6BA47791"}
 */
var codpostalcliente = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"38062DD1-CE76-4758-B7AA-359F45205472"}
 */
var razonsocialcliente = '';

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"F39B696C-26D1-4498-B89E-408726957609",variableType:93}
 */
var fechacobro;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"C67A7CF2-FF02-4A0E-B2AC-8B904E57E4A6"}
 */
var cuentaabono = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"4E579B21-95BE-400B-ACC6-166042E4DF81"}
 */
var bic = '';

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} DEJE
 * @param {String} DSER
 * @param {Number} DNUP
 * @param {Number} HEJE
 * @param {String} HSER
 * @param {Number} HNUP
 * @param {Number} DCLI
 * @param {Number} HCLI
 *
 * @properties={typeid:24,uuid:"A7E2B9B6-47C4-4B65-8E52-FEF4F3C96AEA"}
 */
function datosempresa(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI)
{
	var query = "SELECT ParametrosAplicacion.NºEmpresa,ParametrosAplicacion.Propiedad,"+
    "ParametrosAplicacion.Empresa,ParametrosAplicacion.CodPostal,"+
    "ParametrosAplicacion.Direccion,ParametrosAplicacion.Poblacion,"+
    "ParametrosAplicacion.Provincia,ParametrosAplicacion.CIF,"+
    "ParametrosAplicacion.Telefono,ParametrosAplicacion.Fax,"+
    "ParametrosAplicacion.Mail,ParametrosAplicacion.Web,"+
    "ParametrosAplicacion.Logo,ParametrosAplicacion.Logo2,"+
    "ParametrosAplicacion.TelAux,ParametrosAplicacion.CtaBancaria,"+
    "ParametrosAplicacion.Registro,ParametrosAplicacion.Tomo,"+
    "ParametrosAplicacion.Folio,ParametrosAplicacion.HojaRegistral,"+
    "ParametrosAplicacion.pais,"+
    "tbFacturaCabecera.ID,tbFacturaCabecera.eje_cfa,"+
    "tbFacturaCabecera.ser_cfa,tbFacturaCabecera.nup_cfa,"+
    "tbFacturaCabecera.fecha_cfa,tbFacturaCabecera.fechcobro_cfa,"+
    "tbFacturaCabecera.fechconta_cfa,tbFacturaCabecera.clie_cfa,"+
    "tbFacturaCabecera.cfpa_cfa,tbFacturaCabecera.desccfpa_cfa,"+
    "tbFacturaCabecera.repr_cfa,tbFacturaCabecera.obse_cfa,"+
    "tbFacturaCabecera.fenvio,tbFacturaCabecera.situconta,"+
    "tbFacturaCabecera.situ,tbFacturaCabecera.impbre_cfa,"+
    "tbFacturaCabecera.depp_cfa,tbFacturaCabecera.pgfi_cfa,"+
    "tbFacturaCabecera.impbie_cfa,tbFacturaCabecera.piva_cfa,"+
    "tbFacturaCabecera.cuotaiva_cfa,tbFacturaCabecera.impbie2_cfa,"+
    "tbFacturaCabecera.piva2_cfa,tbFacturaCabecera.cuotaiva2_cfa,"+
    "tbFacturaCabecera.impbie3_cfa,tbFacturaCabecera.piva3_cfa,"+
    "tbFacturaCabecera.cuotaiva3_cfa,tbFacturaCabecera.impnee_cfa,"+
    "tbFacturaCabecera.gtosfinan_cfa,tbFacturaCabecera.impgtosfinan,"+
    "tbFacturaCabecera.impre,tbFacturaCabecera.impre2,"+
    "tbFacturaCabecera.impre3,tbFacturaLinea.ID,tbFacturaLinea.eje_lfa,"+
    "tbFacturaLinea.ser_lfa,tbFacturaLinea.nup_lfa,tbFacturaLinea.nli_lfa,"+
    "tbFacturaLinea.nalb_lfa,tbFacturaLinea.lalb_lfa,"+
    "tbFacturaLinea.ref_lfa,tbFacturaLinea.concep_lfa,"+
    "tbFacturaLinea.cant1_lfa,tbFacturaLinea.prec_lfa,"+
    "tbFacturaLinea.unme_lfa,tbFacturaLinea.piva_lfa,"+
    "tbFacturaLinea.dto_lfa,tbFacturaLinea.impdto_lfa,"+
    "tbFacturaLinea.clie_lfa,tbFacturaLinea.situ_lfa,"+
    "tbFacturaLinea.precuni_lfa,tbFacturaLinea.impor_lfa,"+
    "tbFacturaLinea.importot_lfa,tbFacturaLinea.fecha_lfa,"+
    "tbFacturaLinea.nprograma_lfa,tbMaestroClientes.ID,"+
    "tbMaestroClientes.IdCliente,tbMaestroClientes.DescCliente,"+
    "tbMaestroClientes.Direccion,tbMaestroClientes.Poblacion,"+
    "tbMaestroClientes.Provincia,tbMaestroClientes.CodPostal,"+
    "tbMaestroClientes.RazonSocial,tbMaestroClientes.PersContacto,"+
    "tbMaestroClientes.EmailContacto,tbMaestroClientes.Telf1,"+
    "tbMaestroClientes.Telf2,tbMaestroClientes.Fax,"+
    "tbMaestroClientes.CIF,tbMaestroClientes.NumProveedor,"+
    "tbMaestroClientes.CuentaContable,tbMaestroClientes.IdFormaPago,"+
    "tbMaestroClientes.TipoIva,tbMaestroClientes.IdMoneda,"+
    "tbMaestroClientes.DiaPago1,tbMaestroClientes.DiaPago2,tbMaestroClientes.DiaPago3,"+
    "tbMaestroClientes.Pais,tbMaestroClientes.Observaciones,"+
    "tbMaestroClientes.CodigoBanco,tbMaestroClientes.CodigoSucursal,"+
    "tbMaestroClientes.Codigo1DC,tbMaestroClientes.CodigoCuenta,"+
    "tbMaestroArticulos.RefCliente,tbMaestroformpago.denom_fp,ParametrosAplicacion.bic,"+
	"tbMaestroClientes.Telf1,tbMaestroClientes.web,tbMaestroClientes.EmailContacto "+
    "FROM tbFacturaCabecera tbFacturaCabecera LEFT JOIN dbo.tbFacturaLinea tbFacturaLinea ON "+
	 "tbFacturaCabecera.eje_cfa = tbFacturaLinea.eje_lfa "+
    "AND tbFacturaCabecera.nup_cfa = tbFacturaLinea.nup_lfa "+
    "AND tbFacturaCabecera.ser_cfa = tbFacturaLinea.ser_lfa "+
    "LEFT JOIN dbo.tbMaestroClientes tbMaestroClientes ON "+
	 "tbFacturaCabecera.clie_cfa = tbMaestroClientes.IdCliente "+
    "LEFT JOIN dbo.tbMaestroformpago tbMaestroformpago ON "+
	 "tbFacturaCabecera.cfpa_cfa = tbMaestroformpago.codig_fp "+
    "LEFT JOIN dbo.tbMaestroArticulos tbMaestroArticulos ON "+
	 "tbFacturaLinea.ref_lfa = tbMaestroArticulos.Codigo,"+
    "dbo.ParametrosAplicacion ParametrosAplicacion "+
    "WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
    " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
    "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
    "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
    "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
    " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
    "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+") "+
    "ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
    "tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,99999999)
	
				
				cifempresa = globals.GCQuitarCaracteresEspeciales(utils.stringTrim(utils.stringReplace(dataset.getValue(1,8),' ','')));
				tipopersona = globals.GCQuitarCaracteresEspeciales(TipoPersona(cifempresa));					
				pais = utils.stringTrim(dataset.getValue(1,21));
				razonsocial = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,3));
				regmercantil = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,17));
				hoja = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,20));
				folio = dataset.getValue(1,19);
				seccion = '';
				tomo = dataset.getValue(1,18);
				direccion = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,5));
				codigopostal = dataset.getValue(1,4);
				ciudad = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,6));
				provincia = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,7));
				telefono = dataset.getValue(1,9);
				fax = dataset.getValue(1,10);
				web = dataset.getValue(1,12);
				correo = dataset.getValue(1,11);
				primerafactura = DEJE.toString() + utils.numberFormat(DNUP,'00000') + DSER;
				ultimafactura = HEJE.toString() + utils.numberFormat(HNUP,'00000') + HSER;
				cifcliente = utils.stringTrim(utils.stringReplace(dataset.getValue(1,90),' ',''));
				tipopersonacliente = globals.GCQuitarCaracteresEspeciales(TipoPersona(cifcliente))	
				paiscliente = dataset.getValue(1,99);
				//var contactocliente = dataset.getValue(1,85);
				desccliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,79));
				direccioncliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,80));
				poblacioncliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,81));
				provinciacliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,82));
				codpostalcliente = dataset.getValue(1,83);
				razonsocialcliente = globals.GCQuitarCaracteresEspeciales(dataset.getValue(1,84));
				fechacobro = dataset.getValue(1,27);
				//var formapago = dataset.getValue(1,30);
				cuentaabono = dataset.getValue(1,16);
				bic = dataset.getValue(1,107);
				telefonocliente  = dataset.getValue(1,108);
				webcliente  = dataset.getValue(1,109);
				emailcliente  = dataset.getValue(1,110);
}

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"CB4AD92C-FECC-4767-9EC1-B26CF5EAE597"}
 */
var telefonocliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"579DB3BF-BD15-44E3-AC59-E0F48A25926B"}
 */
var webcliente = '';

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"BF746FD0-4CF8-4741-AD1C-5506105FDD89"}
 */
var emailcliente = '';

/**
 * @type {Date}
 *
 * @properties={typeid:35,uuid:"A9CAD031-8245-472F-846C-539E95BE658C",variableType:93}
 */
var fechafactura;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"92B9FC9A-3324-486B-8421-E69A44987A97",variableType:8}
 */
var impbre;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"59247012-9496-431A-B035-037CE314966D",variableType:8}
 */
var depp;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"7246A87F-F46A-4827-B8F5-40221A9E420F",variableType:8}
 */
var impgfi;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"5C29DBA2-A4EE-4C7B-A165-B28BDC3E057A",variableType:8}
 */
var impnee;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B0959D6B-03CA-4337-BBBE-3D84D141DD72",variableType:8}
 */
var impbie;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"91EB561F-87A0-4A2E-A212-8B8FCF2EC885",variableType:8}
 */
var piva;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"525038FA-7CB7-4D47-91BF-4A2E9FE19AEA",variableType:8}
 */
var cuotaiva;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"5F5081A9-AA81-4AFC-96E3-6D212FF5B32F",variableType:8}
 */
var impbie2;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"F581FFE4-7E4F-442F-9C30-E6CF85212FDE",variableType:8}
 */
var piva2;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"38AB79FE-84D5-4D81-937C-D30EC871238D",variableType:8}
 */
var cuotaiva2;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"D00AA020-5628-4E38-837C-E3E2F93DF4FF",variableType:8}
 */
var impbie3;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"54E56282-20A5-4E13-AA5F-094C331E5A74",variableType:8}
 */
var piva3;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"48281130-2FFE-4CF2-98B5-A23D8685AF7E",variableType:8}
 */
var cuotaiva3;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"B3220312-C7F8-4287-B017-7B91BB2CFFCF",variableType:8}
 */
var porcimpre;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"28F4B44A-38B0-4280-854A-BE5069352EDB",variableType:8}
 */
var porcimpre2;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"87D19B89-72E0-497A-B0B8-29E3DCDFB1A5",variableType:8}
 */
var porcimpre3;

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"2720EA4C-94FC-4AAE-960F-BFD05643C103"}
 */
var concepto = '';

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"80A33961-3A0F-49FC-8876-582DEBEB8EA7",variableType:8}
 */
var cant;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"695D88D8-BB06-4C72-897D-FA59D593D145",variableType:8}
 */
var imporlfa;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"52994AE5-5686-4882-B643-4DBAA07EF280",variableType:8}
 */
var preclfa;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"218FD40B-9276-4C03-AF77-FC598AD680A7",variableType:8}
 */
var dtolfa;

/**
 * @type {Number}
 *
 *
 * @properties={typeid:35,uuid:"D527230E-8E2B-48A2-97BE-9A288BDEEFF1",variableType:8}
 */
var impordtolfa;

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} DEJE
 * @param {String} DSER
 * @param {Number} DNUP
 * @param {Number} HEJE
 * @param {String} HSER
 * @param {Number} HNUP
 * @param {Number} DCLI
 * @param {Number} HCLI
 * @param {Number} i
 *
 *
 *
 * @properties={typeid:24,uuid:"091B722C-CD60-4DDD-A5B7-3FB5650EFBFF"}
 */
function datoslineas(DEJE,DSER,DNUP,HEJE,HSER,HNUP,DCLI,HCLI,i)
{
	var query = "SELECT ParametrosAplicacion.NºEmpresa,ParametrosAplicacion.Propiedad,"+
    "ParametrosAplicacion.Empresa,ParametrosAplicacion.CodPostal,"+
    "ParametrosAplicacion.Direccion,ParametrosAplicacion.Poblacion,"+
    "ParametrosAplicacion.Provincia,ParametrosAplicacion.CIF,"+
    "ParametrosAplicacion.Telefono,ParametrosAplicacion.Fax,"+
    "ParametrosAplicacion.Mail,ParametrosAplicacion.Web,"+
    "ParametrosAplicacion.Logo,ParametrosAplicacion.Logo2,"+
    "ParametrosAplicacion.TelAux,ParametrosAplicacion.CtaBancaria,"+
    "ParametrosAplicacion.Registro,ParametrosAplicacion.Tomo,"+
    "ParametrosAplicacion.Folio,ParametrosAplicacion.HojaRegistral,"+
    "ParametrosAplicacion.pais,"+
    "tbFacturaCabecera.ID,tbFacturaCabecera.eje_cfa,"+
    "tbFacturaCabecera.ser_cfa,tbFacturaCabecera.nup_cfa,"+
    "tbFacturaCabecera.fecha_cfa,tbFacturaCabecera.fechcobro_cfa,"+
    "tbFacturaCabecera.fechconta_cfa,tbFacturaCabecera.clie_cfa,"+
    "tbFacturaCabecera.cfpa_cfa,tbFacturaCabecera.desccfpa_cfa,"+
    "tbFacturaCabecera.repr_cfa,tbFacturaCabecera.obse_cfa,"+
    "tbFacturaCabecera.fenvio,tbFacturaCabecera.situconta,"+
    "tbFacturaCabecera.situ,tbFacturaCabecera.impbre_cfa,"+
    "tbFacturaCabecera.depp_cfa,tbFacturaCabecera.pgfi_cfa,"+
    "tbFacturaCabecera.impbie_cfa,tbFacturaCabecera.piva_cfa,"+
    "tbFacturaCabecera.cuotaiva_cfa,tbFacturaCabecera.impbie2_cfa,"+
    "tbFacturaCabecera.piva2_cfa,tbFacturaCabecera.cuotaiva2_cfa,"+
    "tbFacturaCabecera.impbie3_cfa,tbFacturaCabecera.piva3_cfa,"+
    "tbFacturaCabecera.cuotaiva3_cfa,tbFacturaCabecera.impnee_cfa,"+
    "tbFacturaCabecera.gtosfinan_cfa,tbFacturaCabecera.impgtosfinan,"+
    "tbFacturaCabecera.impre,tbFacturaCabecera.impre2,"+
    "tbFacturaCabecera.impre3,tbFacturaLinea.ID,tbFacturaLinea.eje_lfa,"+
    "tbFacturaLinea.ser_lfa,tbFacturaLinea.nup_lfa,tbFacturaLinea.nli_lfa,"+
    "tbFacturaLinea.nalb_lfa,tbFacturaLinea.lalb_lfa,"+
    "tbFacturaLinea.ref_lfa,tbFacturaLinea.concep_lfa,"+
    "tbFacturaLinea.cant1_lfa,tbFacturaLinea.prec_lfa,"+
    "tbFacturaLinea.unme_lfa,tbFacturaLinea.piva_lfa,"+
    "tbFacturaLinea.dto_lfa,tbFacturaLinea.impdto_lfa,"+
    "tbFacturaLinea.clie_lfa,tbFacturaLinea.situ_lfa,"+
    "tbFacturaLinea.precuni_lfa,tbFacturaLinea.impor_lfa,"+
    "tbFacturaLinea.importot_lfa,tbFacturaLinea.fecha_lfa,"+
    "tbFacturaLinea.nprograma_lfa,tbMaestroClientes.ID,"+
    "tbMaestroClientes.IdCliente,tbMaestroClientes.DescCliente,"+
    "tbMaestroClientes.Direccion,tbMaestroClientes.Poblacion,"+
    "tbMaestroClientes.Provincia,tbMaestroClientes.CodPostal,"+
    "tbMaestroClientes.RazonSocial,tbMaestroClientes.PersContacto,"+
    "tbMaestroClientes.EmailContacto,tbMaestroClientes.Telf1,"+
    "tbMaestroClientes.Telf2,tbMaestroClientes.Fax,"+
    "tbMaestroClientes.CIF,tbMaestroClientes.NumProveedor,"+
    "tbMaestroClientes.CuentaContable,tbMaestroClientes.IdFormaPago,"+
    "tbMaestroClientes.TipoIva,tbMaestroClientes.IdMoneda,"+
    "tbMaestroClientes.DiaPago1,tbMaestroClientes.DiaPago2,tbMaestroClientes.DiaPago3,"+
    "tbMaestroClientes.Pais,tbMaestroClientes.Observaciones,"+
    "tbMaestroClientes.CodigoBanco,tbMaestroClientes.CodigoSucursal,"+
    "tbMaestroClientes.Codigo1DC,tbMaestroClientes.CodigoCuenta,"+
    "tbMaestroArticulos.RefCliente,tbMaestroformpago.denom_fp,ParametrosAplicacion.bic "+
    "FROM tbFacturaCabecera tbFacturaCabecera LEFT JOIN dbo.tbFacturaLinea tbFacturaLinea ON "+
	 "tbFacturaCabecera.eje_cfa = tbFacturaLinea.eje_lfa "+
    "AND tbFacturaCabecera.nup_cfa = tbFacturaLinea.nup_lfa "+
    "AND tbFacturaCabecera.ser_cfa = tbFacturaLinea.ser_lfa "+
    "LEFT JOIN dbo.tbMaestroClientes tbMaestroClientes ON "+
	 "tbFacturaCabecera.clie_cfa = tbMaestroClientes.IdCliente "+
    "LEFT JOIN dbo.tbMaestroformpago tbMaestroformpago ON "+
	 "tbFacturaCabecera.cfpa_cfa = tbMaestroformpago.codig_fp "+
    "LEFT JOIN dbo.tbMaestroArticulos tbMaestroArticulos ON "+
	 "tbFacturaLinea.ref_lfa = tbMaestroArticulos.Codigo,"+
    "dbo.ParametrosAplicacion ParametrosAplicacion "+
    "WHERE (tbFacturaCabecera.eje_cfa >= "+DEJE+
    " AND tbFacturaCabecera.eje_cfa <= "+HEJE+") "+
    "AND (tbFacturaCabecera.ser_cfa >= '"+DSER+"' "+
    "AND tbFacturaCabecera.ser_cfa <= '"+HSER+"') "+
    "AND (tbFacturaCabecera.nup_cfa >= "+DNUP+
    " AND tbFacturaCabecera.nup_cfa <= "+HNUP+") "+
    "AND (tbFacturaCabecera.clie_cfa BETWEEN "+DCLI+" AND "+HCLI+") "+
    "ORDER BY tbFacturaLinea.eje_lfa ASC,tbFacturaLinea.ser_lfa ASC,"+
    "tbFacturaLinea.nup_lfa ASC,tbFacturaLinea.nli_lfa ASC";
	var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null,99999999)
	
	fechafactura = dataset.getValue(i,26);
	impbre = dataset.getValue(i,37);
	depp = dataset.getValue(i,38);
	//var porcgfi = dataset.getValue(i,50);
	impgfi = dataset.getValue(i,51);
	impnee = dataset.getValue(i,49);
	impbie = dataset.getValue(i,40);
	piva = dataset.getValue(i,41);
	cuotaiva = dataset.getValue(i,42);
	impbie2 = dataset.getValue(i,43);
	piva2 = dataset.getValue(i,44);
	cuotaiva2 = dataset.getValue(i,45);
	impbie3 = dataset.getValue(i,46);
	piva3 = dataset.getValue(i,47);
	cuotaiva3 = dataset.getValue(i,48);
	//impre = dataset.getValue(i,52);
	if(impre)
	{
		query = "select ivare from tbmaestrotipoiva WHERE factor = "+piva;
		var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
		porcimpre = dataset2.getValue(1,1)
	}
	//impre2 = dataset.getValue(i,53);
	if(impre2)
	{
		query = "select ivare from tbmaestrotipoiva WHERE factor = "+piva2;
		dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
		porcimpre2 = dataset2.getValue(1,1)
	}						
	//impre3 = dataset.getValue(i,54);
	if(impre3)
	{
		query = "select ivare from tbmaestrotipoiva WHERE factor = "+piva3;
		dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
		porcimpre3 = dataset2.getValue(1,1)
	}
	//var alb = dataset.getValue(i,60);
	//var lalb = dataset.getValue(i,61);
	concepto = dataset.getValue(i,63)
	cant = dataset.getValue(i,64)
	imporlfa = dataset.getValue(i,73)
	preclfa = dataset.getValue(i,65)
	dtolfa = dataset.getValue(i,68)
	impordtolfa = dataset.getValue(i,69)
}

/**
 * @type {String}
 *
 *
 * @properties={typeid:35,uuid:"E2D2F3BF-4FCB-4A7E-8ECF-EA11BCEFF990"}
 */
var paisclienteiso3 = '';

/**
 * TODO generated, please specify type and doc for the params
 *
 * @properties={typeid:24,uuid:"1C2A5636-FA7C-46AE-829A-55CBC8C15568"}
 */
function getpaiso3()
{
	var query = "select pai_iso3 from pais where pai_iso2 ='"+paiscliente+"'";				
	var dataset2 = databaseManager.getDataSetByQuery(globals.GCconex, query, null,1)
	paisclienteiso3 = dataset2.getValue(1,1)
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} CIF
 * 
 * @return {String}
 *
 *
 * @properties={typeid:24,uuid:"2C1CC574-98EB-4DD9-82F6-71F33F67A573"}
 */
function TipoPersona(CIF)
{
	var l = utils.stringLeft(CIF,1)
	var Letr = 'NO'
	var tippers = ''
	for(var i=0;i<Letras.length;i++)
	{
		if(Letras[i] == l)
		{
			Letr = 'SI'
			break;
		}
	}					
	if(Letr == 'SI')
	{
		tippers = 'J'//Persona Juridica
	}
	else if(Letr == 'NO')
	{
		tippers = 'F'//Persona Física
	}
	return tippers
}

/**
 * TODO generated, please specify type and doc for the params
 * @param {String} PAIS
 * 
 * @return {String}
 *
 *
 * @properties={typeid:24,uuid:"0AAD77AD-A76C-422E-BC3F-9B57EA7872C4"}
 */
function TipoNacionalidad(PAIS)
{
	var Letr = 'NO'
	var tiponacionalidad = ''
	for(var i=0;i<Letras.length;i++)
	{
		if(Letras[i] == PAIS)
		{
			Letr = 'SI'
			break;
		}
	}					
	if(Letr == 'SI')
	{
		tiponacionalidad = 'U'//Residente en la Unión Europea.
	}
	else if(Letr == 'NO')
	{
		tiponacionalidad = 'E'//Extranjero
	}
	return tiponacionalidad
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"F1C47DAA-2E44-4022-9A1A-C7C7D36E0C59"}
 */
function onDataChangefraoriginalrect(event) {
	if(fraoriginal && fraoriginal.length == 7)
	{
		var ejerectificada = utils.stringLeft(fraoriginal,2);
		var nuprectificada = utils.stringRight(fraoriginal,5);
		var query333 = "select clie_cfa,cfpa_cfa,desccfpa_cfa,obse_cfa,fenvio from tbFacturaCabecera \
		where eje_cfa = "+ ejerectificada + " and nup_cfa ="+nuprectificada;
		var dataset333 = databaseManager.getDataSetByQuery(globals.GCconex, query333, null, 1);
		if(dataset333.getMaxRowIndex())
		{
			clie_cfa = dataset333.getValue(1,1);
			cfpa_cfa = dataset333.getValue(1,2);
			desccfpa_cfa = dataset333.getValue(1,3);
			obse_cfa = dataset333.getValue(1,4);
			fenvio = dataset333.getValue(1,5);
		}
		else
		{
			globals.GCshowErrorDialog('No existe factura original registrada con esa numeracion',null,'Aceptar',null,null,null)
			clie_cfa = null;
			cfpa_cfa = null;
			desccfpa_cfa = null;
			obse_cfa = null;
			fenvio = null;
		}
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param event
 *
 * @properties={typeid:24,uuid:"F3CEF8AD-2AB3-4004-BE37-73C9E276CCF9"}
 */
function AgregarlineasFacturarectificada(event){
	if(globals.core_dlg_buttonPressed == 'Si')
	{
		var ejerectificada = utils.stringLeft(fraoriginal,2);
		var nuprectificada = utils.stringRight(fraoriginal,5);
	
		var query = "select eje_lfa,ser_lfa,nup_lfa,fecha_lfa,ref_lfa,concep_lfa,cant1_lfa,prec_lfa,unme_lfa,\
		 			piva_lfa,clie_lfa,precuni_lfa,impor_lfa,importot_lfa,nprograma_lfa,dto_lfa,impdto_lfa,medida_lfa \
		 			from tbfacturalinea where eje_lfa ="+ejerectificada+" and nup_lfa="+nuprectificada+
					"and ser_lfa ='' order by nli_lfa";
		var dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 999999999);
		var rows = dataset.getMaxRowIndex();
		for(var i=1;i<=rows;i++)
		{
			//make a new record
			forms.dlg_Linea_FacturaGC.foundset.newRecord(true)
			forms.dlg_Linea_FacturaGC.eje_lfa = forms.FrmFacturasGC.eje_cfa;
			forms.dlg_Linea_FacturaGC.ser_lfa = forms.FrmFacturasGC.ser_cfa;
			forms.dlg_Linea_FacturaGC.nup_lfa = forms.FrmFacturasGC.nup_cfa;
			forms.dlg_Linea_FacturaGC.validate_autoEnter()
			forms.dlg_Linea_FacturaGC.fecha_lfa = dataset.getValue(i,4);
			forms.dlg_Linea_FacturaGC.ref_lfa = dataset.getValue(i,5);
			forms.dlg_Linea_FacturaGC.concep_lfa = dataset.getValue(i,6);
			forms.dlg_Linea_FacturaGC.cant1_lfa = dataset.getValue(i,7);
			forms.dlg_Linea_FacturaGC.prec_lfa = dataset.getValue(i,8);
			forms.dlg_Linea_FacturaGC.unme_lfa = dataset.getValue(i,9);
			forms.dlg_Linea_FacturaGC.piva_lfa = dataset.getValue(i,10);
			forms.dlg_Linea_FacturaGC.clie_lfa = dataset.getValue(i,11);
			forms.dlg_Linea_FacturaGC.precuni_lfa = dataset.getValue(i,12);
			forms.dlg_Linea_FacturaGC.impor_lfa = dataset.getValue(i,13);
			forms.dlg_Linea_FacturaGC.importot_lfa = dataset.getValue(i,14);
			forms.dlg_Linea_FacturaGC.nprograma_lfa = dataset.getValue(i,15);
			forms.dlg_Linea_FacturaGC.dto_lfa = dataset.getValue(i,16);
			forms.dlg_Linea_FacturaGC.impdto_lfa = dataset.getValue(i,17);
			forms.dlg_Linea_FacturaGC.medida_lfa = dataset.getValue(i,18);
			
			databaseManager.saveData(forms.dlg_Linea_FacturaGC.foundset)
		}
			var e = forms.FrmFacturasGC.eje_cfa;
			var s = forms.FrmFacturasGC.ser_cfa;
			var n = forms.FrmFacturasGC.nup_cfa;
			
			
			if(s == null)
			{
				s = 'IS NULL'
			}
			else
			{
				s = "= '"+forms.FrmFacturasGC.ser_cfa+"'"
			}
			query = "select sum(impor_lfa) from tbFacturaLinea "+
			"where eje_lfa = "+ e +" AND ser_lfa "+s+
			" AND nup_lfa = "+n;
			dataset = databaseManager.getDataSetByQuery(globals.GCconex, query, null, 1)
			var imporbr=dataset.getValue(1,1)
			
			
			if(imporbr==null)
			{
				imporbr=0
			}
			forms.FrmFacturasGC.impbre_cfa = imporbr;
			forms.FrmFacturasGC.impbie_cfa = null
			forms.FrmFacturasGC.impbie2_cfa = null
			forms.FrmFacturasGC.impbie3_cfa = null
			forms.FrmFacturasGC.piva_cfa = null
			forms.FrmFacturasGC.piva2_cfa = null
			forms.FrmFacturasGC.piva3_cfa = null
			forms.FrmFacturasGC.cuotaiva_cfa = null
			forms.FrmFacturasGC.cuotaiva2_cfa = null
			forms.FrmFacturasGC.cuotaiva3_cfa = null
			forms.FrmFacturasGC.impre = null
			forms.FrmFacturasGC.impre2 = null
			forms.FrmFacturasGC.impre3 = null
			forms.FrmFacturasGC.onFocusLostDtoPP(event)
			forms.FrmFacturasGC.onFocusLostgtosfinan(event)
			forms.FrmFacturasGC.onFocusLostIva(event)
			databaseManager.saveData();
		}	
}

/**
 * Perform the element onclick action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 *
 * @properties={typeid:24,uuid:"A940AD5F-C739-4322-9D55-E9112BBDA760"}
 */
function onActionTicketBAIOSATU(event) {
	var ro = forms.FrmFacturasGC.elements.fld_fecha_cfa.readOnly;
	if(globals.GCisEditing() && ro == false)
	{
		//forms[frm].btn_cancel()
		globals.GCshowInfoDialog('La factura se esta editando. Grabe primero la cabecera de la Factura antes intentar enviar al servicio OSATU.',null,'Aceptar',null,null,null)
	}
	else if(!id || foundset.getSize() == 0) 
	{
		//globals.GCshowErrorDialog('La factura aún NO se ha enviado a TicketBAI.\n\nEnvíe primero la factura a TicketBAI antes de enviar la información complementaria de OSATU',null,'Aceptar',null,null,null)
	}
	else if(!fechaenviofichero || !cqr) 
	{
		globals.GCshowErrorDialog('La factura aún NO se ha enviado a TicketBAI.\n\nEnvíe primero la factura a TicketBAI antes de enviar la información complementaria de OSATU',null,'Aceptar',null,null,null)
	}
	else if(fichero_respuesta_osatu &&	xml_enviado_osatu)
	{
		if(/*mac &&*/ fechaenviofichero && cqr) application.showURL(cqr,'_blank')
	}
	else if(!gcparametrosaplicacion_to_parametrosaplicacion.osatu ||
	gcparametrosaplicacion_to_parametrosaplicacion.osatu == null)
	{
		globals.GCshowInfoDialog('No está habilitado el módulo OSATU. Póngase en contacto con AG Informática y Servcios.',null,'Aceptar',null,null,null)
	}
	else
	{
		if(!gcparametrosaplicacion_to_parametrosaplicacion.empresa) 
		{
			globals.GCshowErrorDialog("Falta el nombre de la empresa (emisor de la factura) en los parametros de la aplicación.\n\nEs un campo obligatorio para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else if(!gcparametrosaplicacion_to_parametrosaplicacion.cif) 
		{	
			globals.GCshowErrorDialog("Falta el cif de la empresa (emisor de la factura) en los parametros de la aplicación.\n\nEs un campo obligatorio para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else if(!forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.desccliente) 
		{	
			globals.GCshowErrorDialog("Falta el nombre del cliente en su ficha. Es un campo obligatorio para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else if(!forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.direccion) 
		{	
			globals.GCshowErrorDialog("Falta la dirección del cliente en su ficha. Es un campo obligatorio para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else if(!forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.pais) 
		{	
			globals.GCshowErrorDialog("Falta el pais del cliente en su ficha. Es un campo obligatorio para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else if(forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.pais == 'ES' && 
				!forms.FrmFacturasGC.GCtbfacturacabecera_to_tbmaestroclientes.codpostal ) 
		{	
			globals.GCshowErrorDialog("Falta el código postal del cliente en su ficha. Es un campo obligatorio en clientes nacionales para realizar el envío a TicketBAI.", null, null, null, null, null)
		}
		else
		{
			if(application.getApplicationType() != APPLICATION_TYPES.SMART_CLIENT)
			{
				globals.GCshowInfoDialog("El envío al servicio OSATU sólo está disponible a traves de aplicación escritorio SmartClient", null, null, null, null, null)
			}
			else
			{
				var rutacertificado = '';
				var rutacertificadokey = '';
				if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20' || 
				gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GUIPÚZCOA' || 
				gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GIPUZKOA' || 
				gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GUIPUZCOA'){
					if(globals.GCconex == 'conexiongestionmlegazpipruebas') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_ml.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_ml_key.pem";
					}
					else if(globals.GCconex == 'conexiongestiontmendizabalpruebas') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_tmendizabal.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_tmendizabal_key.pem";
					}
					else if(globals.GCconex == 'conexiongestionolabemarpruebas') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_olabemar.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_olabemar_key.pem";
					}
					else if(globals.GCconex == 'conexiongestionsectorvertical') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_sv.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_sv_key.pem";	
						//rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai.pem";
						//rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_key.pem";
					}
					else if(globals.GCconex == 'conexiongestionamsorolla') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_amsorolla.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_amsorolla_key.pem";	
						//rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai.pem";
						//rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_key.pem";
					}
					else if(globals.GCconex == 'conexiongestiontedelbi') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_tedelbi.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_tedelbi_key.pem";	
						//rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai.pem";
						//rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_key.pem";
					}
					else if(globals.GCconex == 'conexiongestiongm') 
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\cert_gm.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\cert_gm_key.pem";	
						//rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai.pem";
						//rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_key.pem";
					}
					else if(globals.GCconex == 'conexiongestioncomercialag')
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_key.pem";
					}
					/*else if(globals.GCconex == 'conexiongestioncomercialagdemo' || globals.GCconex == 'conexiongestioncomercialagdemo2')
					{
						rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_demo.pem";
						rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_ticketbai_demo_key.pem";
					}*/
				}
				else if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48' || 
						gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'VIZCAYA' || 
						gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'BIZCAIA'){
					rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_vizcaya_ticketbai.pem";
					rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_vizcaya_ticketbai_key.pem";
				}
				else if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01' || 
						gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ÁLAVA' || 
						gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ALAVA' || 
						gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ARABA'){
							if(globals.GCconex == 'conexiongestionzusipruebas')
							{
								rutacertificado = plugins.file.getHomeFolder()+"\\.servoy\\certif_alaba_ticketbai.pem";
								rutacertificadokey = plugins.file.getHomeFolder()+"\\.servoy\\certif_alaba_ticketbai_key.pem";
							}
				}
				
				var f = plugins.file.convertToJSFile(rutacertificado);
				var f2 = plugins.file.convertToJSFile(rutacertificadokey);
				
				if(f && f.exists() && f2 && f2.exists())
				{
					GenerarXMLTBAIOSATU(eje_cfa,ser_cfa,nup_cfa,clie_cfa)
				}
				else
				{
					globals.GCshowErrorDialog("Para realizar el envío a OSATU falta certificado digital en la ruta "+plugins.file.getHomeFolder()+
							"\\.servoy\\ y en formato .pem\n\nPóngase en contacto con AG Informática", null, null, null, null, null)					
				}
			}
		}
	}
}

/**
 * Callback method when form is destroyed.
 * 
 * 
 * @param {Number} EJE
 * @param {String} SER
 * @param {Number} NUP
 * @param {Number} CLI
 *
 * @properties={typeid:24,uuid:"F0518C13-2D8F-4DAC-ADE0-A7771F971A0F"}
 */
function GenerarXMLTBAIOSATU(EJE,SER,NUP,CLI)
{
	try
	{
		var xml = new String();
		htm = new String();
		newxml = new String();
		Document = new XML();
		var Cabecera = new XML();
		var IDVersion = new XML();
		var IDFactura = new XML();
		var NIF = new XML();
		var SerieFactura = new XML();
		var NumFactura = new XML();
		var FechaExpedicionFactura = new XML();
		var OsatuOtrosDatosTributarios = new XML();
		//var NIFRepresentante = new XML();
		//var NIFRepresentanteContraparte = new XML();
		//var Cupon = new XML();
		var nfactura = eje_cfa+utils.numberFormat(nup_cfa,'00000')+ser_cfa;
		
		xml = '<?xml version="1.0" encoding="UTF-8"?>';
		Document = <OsatuTicketBAI/>
		
		Cabecera = <Cabecera/>
			IDVersion = <IDVersion/>
			IDVersion.appendChild('1.0')
		Cabecera.appendChild(IDVersion)
		IDFactura = <IDFactura/>
			NIF = <NIF/>
			NIF.appendChild(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.cif,9))
			SerieFactura = <SerieFactura/>
			SerieFactura.appendChild(fecha_cfa.getFullYear())
			NumFactura = <NumFactura/>
			NumFactura.appendChild(nfactura)
			FechaExpedicionFactura = <FechaExpedicionFactura/>
			FechaExpedicionFactura.appendChild(utils.dateFormat(fechaenviofichero,'dd-MM-yyyy'))
			//FechaExpedicionFactura.appendChild(utils.dateFormat(fecha_cfa,'dd-MM-yyyy'))
		IDFactura.appendChild(NIF)
		IDFactura.appendChild(SerieFactura)
		IDFactura.appendChild(NumFactura)
		IDFactura.appendChild(FechaExpedicionFactura)
		OsatuOtrosDatosTributarios = <OsatuOtrosDatosTributarios/>
			/*NIFRepresentante = <NIFRepresentante/>
			NIFRepresentante.appendChild(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.cif,9))
			NIFRepresentanteContraparte = <NIFRepresentanteContraparte/>
			NIFRepresentanteContraparte.appendChild(utils.stringLeft(GCtbfacturacabecera_to_tbmaestroclientes.cif,9))
			//Cupon = <Cupon/>
			//Cupon.appendChild('S')
		OsatuOtrosDatosTributarios.appendChild(NIFRepresentante)
		OsatuOtrosDatosTributarios.appendChild(NIFRepresentanteContraparte)
		OsatuOtrosDatosTributarios.appendChild(Cupon)*/
		Document.appendChild(Cabecera)
		Document.appendChild(IDFactura)
		Document.appendChild(OsatuOtrosDatosTributarios)
		
		xml += Document
		newxml = utils.stringReplace(xml.toString(),'<OsatuTicketBAI','<T:OsatuTicketBAI')
		newxml = utils.stringReplace(newxml,'</OsatuTicketBAI','</T:OsatuTicketBAI')
		newxml = utils.stringReplace(newxml,'<T:OsatuTicketBAI>','<T:OsatuTicketBAI xmlns:T="urn:ticketbai:osatu">')
		
		newxml = utils.stringReplace(newxml,' xmlns=""','')
		//var xml2 = new XML(newxml)
		application.output(newxml);
			
		htm += newxml
		if(application.getApplicationType() != APPLICATION_TYPES.WEB_CLIENT && application.getApplicationType() != APPLICATION_TYPES.NG_CLIENT)
		{
			var folder = plugins.file.convertToJSFile("c:\\tmp");
			var b = plugins.file.createFolder(folder)
			if (b == true) application.output("El directorio c:\\tmp se ha creado correctamente o ya existía.");
			var js = "c:\\tmp\\OSATU"+nfactura+".xml";
			var f = plugins.file.convertToJSFile(js);
			if(f && f.exists()) f.deleteFile()
			plugins.file.writeTXTFile(js, htm, 'UTF8', 'application/xml');
			
			f = plugins.file.convertToJSFile(js);
			if(f && f.exists())
			{
				f = plugins.file.convertToJSFile("C:\\tmp\\ficheroenviocurl.xml");
				
				if(f && f.exists()) f.deleteFile()
				plugins.file.copyFile(js,"C:\\tmp\\ficheroenviocurl.xml")
				
				//ENVIO EL XML AL SISTEMA OSATU
				application.output('ENVIO EL XML AL SISTEMA OSATU CON CURL')
				var resp = envioOSATU(newxml)
				application.output(resp)
				if(utils.stringLeft(resp,2) == '00')
				{
					var ruta = "C:\\TMP\\salidaOSATU.xml";
					f = plugins.file.convertToJSFile(ruta);
					if(f && f.exists())
					{
						var rawData = plugins.file.readFile(ruta);
						fichero_respuesta_osatu = rawData;
					}
					ruta =  "c:\\tmp\\OSATU"+nfactura+".xml";
					f = plugins.file.convertToJSFile(ruta);
					if(f && f.exists())
					{
						rawData = plugins.file.readFile(ruta);
						xml_enviado_osatu = rawData;
					}
					databaseManager.saveData(forms.FrmFacturasGC.foundset);
					databaseManager.refreshRecordFromDatabase(forms.FrmFacturasGC.foundset,-1)	
					globals.GCshowInfoDialog("Fichero enviado correctamente a OSATU.", null, null, null, null, null)
				}
				else
				{
					/*fichero_respuesta_osatu = null;
					xml_enviado_osatu = null;
					databaseManager.saveData(forms.FrmFacturasGC.foundset);
					databaseManager.refreshRecordFromDatabase(forms.FrmFacturasGC.foundset,-1)	*/
					globals.GCshowErrorDialog("Fichero rechazado al enviar a OSATU.\nCódigo: '"+resp+"'", null, null, null, null, null)
				}
			}
			
		}
		
	}
	catch (e) {
		application.output("catched exception");
		application.output(e);
		globals.GCshowErrorDialog(e.toString(),null,'Aceptar',null,null,null)
	}
}

/**
 * TODO generated, please specify type and doc for the params
 * @param myXml
 * 
 * @return {String}
 * 
 *
 *
 * @properties={typeid:24,uuid:"046EDB24-F51B-436D-8CE6-2C36B9DE7391"}
 */
function envioOSATU(myXml){
	//var rutabat = "c:\\Servoy\\Comando_Curl_Servoy.bat";
	//var rutabat = "D:\\curl\\curl-7.81.0-win64-mingw\\bin\\curl.exe";
	
	var hfolder = plugins.file.getHomeFolder()+"\\.servoy\\";
	if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '20' || gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GUIPÚZCOA' || 
	gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GIPUZKOA' || gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'GUIPUZCOA'){		
		if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbaientorno != 1) 
		{
			if(globals.GCconex == 'conexiongestionmlegazpipruebas') var rutabat = hfolder+"CURL_OSATU_ML_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestiontmendizabalpruebas') rutabat = hfolder+"CURL_OSATU_TM_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestionolabemarpruebas') rutabat = hfolder+"CURL_OSATU_OLABEMAR_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestionsectorvertical') rutabat = hfolder+"CURL_OSATU_SV_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestionamsorolla') rutabat = hfolder+"CURL_OSATU_AMSOROLLA_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestiontedelbi') rutabat = hfolder+"CURL_OSATU_TEDELBI_PRUEBAS.exe";	
			else if(globals.GCconex == 'conexiongestiongm') rutabat = hfolder+"CURL_OSATU_GM_PRUEBAS.exe";	
			else rutabat = hfolder+"CURL_OSATU_PRUEBAS.exe";		
		}
		else 
		{			
			if(globals.GCconex == 'conexiongestionmlegazpipruebas') rutabat = hfolder+"CURL_OSATU_ML_OFICIAL.exe";
			else if(globals.GCconex == 'conexiongestiontmendizabalpruebas') rutabat = hfolder+"CURL_OSATU_TM_OFICIAL.exe";	
			else if(globals.GCconex == 'conexiongestionolabemarpruebas') rutabat = hfolder+"CURL_OSATU_OLABEMAR_OFICIAL.exe";	
			else if(globals.GCconex == 'conexiongestionsectorvertical') rutabat = hfolder+"CURL_OSATU_SV_OFICIAL.exe";	
			else if(globals.GCconex == 'conexiongestionamsorolla') rutabat = hfolder+"CURL_OSATU_AMSOROLLA_OFICIAL.exe";	
			else if(globals.GCconex == 'conexiongestiontedelbi') rutabat = hfolder+"CURL_OSATU_TEDELBI_OFICIAL.exe";	
			else if(globals.GCconex == 'conexiongestiongm') rutabat = hfolder+"CURL_OSATU_GM_OFICIAL.exe";	
			else rutabat = hfolder+"CURL_OSATU_OFICIAL.exe";
		}
	}
	else if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '48' || gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'VIZCAYA' || 
	gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'BIZCAIA'){
		f = plugins.file.convertToJSFile("C:\\tmp\\ficheroenviocurl.xml");
		if(f && f.exists())
		{			
			var f2 = plugins.file.convertToJSFile("C:\\tmp\\ficheroenviocurl.xml.zip");
			if(f2 && f2.exists()) f2.deleteFile()
			f2 = plugins.file.convertToJSFile("C:\\tmp\\ficheroenviocurl.xml.gz");
			if(f2 && f2.exists()) f2.deleteFile()
			//plugins.it2be_tools.zip("C:\\tmp\\ficheroenviocurl.xml")
			plugins.file.copyFile("C:\\tmp\\ficheroenviocurl.xml.zip","C:\\tmp\\ficheroenviocurl.gz")				
		}
		if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbaientorno != 1) rutabat = hfolder+"CURL_OSATU_VIZCAYA_PRUEBAS.exe";
		else rutabat = hfolder+"CURL_OSATU_VIZCAYA_OFICIAL.exe";
	}
	else if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01' || gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ÁLAVA' || 
	gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ALAVA' || gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ARABA'){
		if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbaientorno != 1) rutabat = hfolder+"CURL_OSATU_ALAVA_PRUEBAS.exe";
		else rutabat = hfolder+"CURL_OSATU_ALAVA_OFICIAL.exe";
	}
	else{
		if(gcparametrosaplicacion_to_parametrosaplicacion.ticketbaientorno != 1) rutabat = hfolder+"CURL_OSATU_PRUEBAS.exe";
		else rutabat = hfolder+"CURL_OSATU_OFICIAL.exe";
	}
	//var rutabat = hfolder+"Comando_Curl_Servoy.bat";
	var f = plugins.file.convertToJSFile(rutabat);
	//var urlServer = "https://tbai.egoitza.gipuzkoa.eus/sarrerak/alta"; // --- Entorno https://tbai.egoitza.gipuzkoa.eus/qr/?id=
	//var urlServer = "https://tbai-prep.egoitza.gipuzkoa.eus/WAS/HACI/HTBRecepcionFacturasWEB/rest/recepcionFacturas/alta"; // --- Entorno pruebas.
	
	//var resp = 'No existe el .bat';
	var resp = 'No existe el curl.exe';
	if(f && f.exists())
	{
		var ruta = "C:\\TMP\\salidaOSATU.xml";
		f = plugins.file.convertToJSFile(ruta);
		if(f && f.exists()) f.deleteFile()
		
		//curl --connect-timeout 60 -m 60 -s -S -L --header "Content-Type: application/xml;charset=UTF-8" -H "Accept: application/xml" --cert D:\CERTIF_AG\cgagfnmt.pem --key D:\CERTIF_AG\cgagfnmt_key.pem --data-binary @C:\TMP\ficheroenviocurl.xml  https://tbai-prep.egoitza.gipuzkoa.eus/WAS/HACI/HTBRecepcionFacturasWEB/rest/recepcionFacturas/alta --output c:\tmp\salida.xml -v
	
		//resp = application.executeProgram(rutabat);
		
		resp = plugins.UserManager.executeCommand(rutabat);
		
		//resp = application.executeProgram(rutabat,[myXml,urlServer]);		
		//plugins.UserManager.executeCommand(rutabat+ ' --connect-timeout 60 -m 60 -s -S -L --header "Content-Type: application/xml;charset=UTF-8" -H "Accept: application/xml" --cert D:\CERTIF_AG\cgagfnmt.pem --key D:\CERTIF_AG\cgagfnmt_key.pem --data '+myXml+'  '+urlServer+'  --output c:\tmp\salida.xml -v')
		//resp = application.executeProgram("cmd /c  C:\\Windows\\System32\\cmd.exe");
		
		ruta = "C:\\TMP\\salidaOSATU.xml";
		f = plugins.file.convertToJSFile(ruta);
		if(f && f.exists())
		{
			//leo el fichero firmado
			var texto = new Array();
			
			 var _oFR = new Packages.java.io.FileInputStream(ruta),
		     _oIR = new Packages.java.io.InputStreamReader(_oFR, "UTF8"),
		     _oBR = new Packages.java.io.BufferedReader(_oIR),
		     z = 0;
			 while ((texto[z] = _oBR.readLine()) != null) 
			 {
		         //texto[i] = _oBR.readLine();
		         z++;            
		     }
		     _oBR.close();
			     if(utils.stringLeft(gcparametrosaplicacion_to_parametrosaplicacion.codpostal,2) == '01' || 
					gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ÁLAVA' || 
					gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ALAVA' || 
					gcparametrosaplicacion_to_parametrosaplicacion.provincia == 'ARABA'){
						var linea = texto[0];
						if(linea) resp = utils.stringTrim(linea.slice(258, 260));
						if(resp == '00')
					    {
					    	resp += " - Recibido";
					    }
					    else
					    {
					    	resp += " - Rechazado. Consulte el archivo salidaOSATU.xml"
					    }
				} 
				else
				{
					linea = texto[5];
					if(linea) resp = utils.stringTrim(linea.slice(16, 18));
					else
					{
						linea = texto[0]
						if(linea) resp = utils.stringTrim(linea.slice(258, 260));
					}
				    if(resp == '00')
				    {
					    linea = texto[6];
					    if(linea)
					    {
					    	resp += " - "+utils.stringTrim(linea.slice(21, 30));			    	
					    }
					    else
					    {
					    	linea = texto[0];
					    	if(linea) resp += " - "+utils.stringTrim(linea.slice(282, 290));		
					    }
				    }
				    else
				    {
				    	if(linea){
					    	 linea = texto[4];
					    	 resp = utils.stringTrim(linea.slice(16, 18));
					    	 linea = texto[5];
							 if(linea)
							 {
							   	resp += " - "+utils.stringTrim(linea.slice(21, 30))+ "\n";			    	
							 }
					    	 linea = texto[8];
					    	 if(linea)
					    	 {
					    		 resp += utils.stringTrim(linea.slice(20, 23));
					    		 linea = texto[9];
					    		 if(linea)
						    	 {
						    		 resp += " - "+utils.stringTrim(linea.slice(25, 77));
						    	 }
					    	 }
				    	}
				    	else resp = 'RECHAZADO EL ENVÍO A TICKETBAI. \nCONSULTE EL FICHERO C:\TMP\salidaOSATU.xml PARA SABER LA RAZON DE PORQUÉ SE HA RECHAZADO.'
				    }
				}
		}
		else 
		{
			resp = 'No generado fichero C:\\TMP\\salidaOSATU.xml';
		}
	}
	
	//var resp = plugins.Velocity.invokeService("TicketBAI",{ inPath: 'c:/tmp/ficheroenviocurl.xml', outPath: 'C:/tmp/salida.xml' });
	return resp
}

/**
 * Fired when the button is clicked.
 *
 * @param {JSEvent} event
 *
 * @properties={typeid:24,uuid:"9A61C8C7-2DF6-414F-B20F-70B9B47BF52F"}
 */
function btn_listadoFacturas(event) {
	
	globals.GCFormulario = 'FrmFacturasGC';
	//globals.GCshowDialogClientes('BD Clientes', 1, null, null, true, null, null, null, null, null);
	var win = application.getWindow('dialog_Facturas3')
	if(win != null) win.destroy();
	 
	win = application.createWindow("dialog_Facturas3", JSWindow.MODAL_DIALOG);
	//win.setInitialBounds(10, 10, 1100, 600);
	win.title = 'Últimas Facturas';
	//win.resizable = true;
	//win.show(forms.dialog_Clientes2GC)
	win.show(forms.lst_Facturas2GC)

}
